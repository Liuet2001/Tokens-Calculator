<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
<meta charset="UTF-8">
<title>Calculadora de Tokens</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Poppins:wght@700&display=swap" rel="stylesheet">

<!-- SCRIPTS DO FIREBASE -->
<script type="module">
  // Importa as funções necessárias dos SDKs do Firebase
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, addDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // --- PASSO IMPORTANTE ---
  // Cole a sua configuração do Firebase que você copiou aqui dentro.
  const firebaseConfig = {
    apiKey: "AIzaSyDgeTU4YmFpZIwcmE2-cxGKTkO2KqeQotE",
    authDomain: "token-calculator-a45d6.firebaseapp.com",
    projectId: "token-calculator-a45d6",
    storageBucket: "token-calculator-a45d6.firebasestorage.app",
    messagingSenderId: "597974335563",
    appId: "1:597974335563:web:9d07ada2708d61b7d30dce"
  };

  // Inicializa o Firebase e o Firestore
  const appFirebase = initializeApp(firebaseConfig);
  const db = getFirestore(appFirebase);

  // Torna a função de salvar dados acessível globalmente para o nosso outro script
  window.saveReceiptToFirebase = async (receiptData) => {
    try {
      const docRef = await addDoc(collection(db, "receipts"), {
        ...receiptData,
        createdAt: Timestamp.now() // Adiciona um carimbo de data/hora
      });
      console.log("Recibo salvo com o ID: ", docRef.id);
    } catch (e) {
      console.error("Erro ao adicionar o documento: ", e);
      alert("Houve um erro ao salvar o recibo no banco de dados.");
    }
  };
</script>


<style>
  :root {
    --font-header: 'Poppins', sans-serif;
    --font-body: 'Inter', sans-serif;
    --bg-primary: #18181b;
    --bg-secondary: #27272a;
    --bg-tertiary: #3f3f46;
    --border-color: #3f3f46;
    --accent-primary: #34d399;
    --accent-hover: #10b981;
    --accent-danger: #f43f5e;
    --text-primary: #f8fafc;
    --text-secondary: #a1a1aa;
  }

  html[data-theme='light'] {
    --bg-primary: #f4f4f5;
    --bg-secondary: #ffffff;
    --bg-tertiary: #e4e4e7;
    --border-color: #d4d4d8;
    --accent-primary: #10b981;
    --accent-hover: #0f9a6c;
    --accent-danger: #ef4444;
    --text-primary: #18181b;
    --text-secondary: #71717a;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background-color: var(--bg-primary);
    color: var(--text-primary);
    font-family: var(--font-body);
    padding: 40px 20px;
    transition: background-color 0.3s ease, color 0.3s ease;
  }

  .container {
    width: 100%;
    max-width: 800px;
    margin: auto;
    background: var(--bg-secondary);
    padding: 32px;
    border-radius: 16px;
    border: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    gap: 24px;
    transition: background-color 0.3s ease, border-color 0.3s ease;
    opacity: 0;
    transform: translateY(20px);
    animation: fadeIn 0.5s 0.2s ease-out forwards;
  }
  
  @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
  
  .settings-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
  }

  .language-switcher button { background: none; border: none; padding: 4px; cursor: pointer; transition: all 0.3s ease; }
  .language-switcher button:not(.active) { filter: grayscale(100%); opacity: 0.6; }
  html[data-theme='dark'] .language-switcher button:not(.active) { filter: grayscale(100%) invert(100%); opacity: 0.8; }
  .language-switcher button.active, .language-switcher button:not(.active):hover { filter: none; opacity: 1; transform: scale(1.1); }
  
  .theme-switcher { display: flex; align-items: center; gap: 8px; }
  .theme-switcher-label { font-size: 12px; color: var(--text-secondary); font-weight: 500; }
  .toggle-track { width: 44px; height: 24px; background-color: var(--bg-tertiary); border-radius: 99px; position: relative; cursor: pointer; transition: background-color 0.3s ease; }
  .toggle-thumb { width: 18px; height: 18px; background-color: white; border-radius: 50%; position: absolute; top: 3px; left: 4px; transition: transform 0.3s ease; }
  html[data-theme='light'] .toggle-track { background-color: var(--accent-primary); }
  html[data-theme='light'] .toggle-thumb { transform: translateX(19px); }

  h2 { font-family: var(--font-header); color: var(--accent-primary); font-size: 28px; font-weight: 700; }
  .input-group { display: flex; flex-direction: column; gap: 8px; }
  .input-group label { font-size: 14px; font-weight: 500; color: var(--text-secondary); }

  input[type="text"], input[type="number"] {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    background-color: var(--bg-tertiary);
    color: var(--text-primary);
    font-size: 16px;
    transition: all 0.3s ease;
  }
  
  input[type="text"]:focus, input[type="number"]:focus {
    outline: none;
    border-color: var(--accent-primary);
    box-shadow: 0 0 0 3px rgba(52, 211, 153, 0.3);
  }

  .mode-selector {
      display: flex;
      gap: 20px;
      background-color: var(--bg-tertiary);
      padding: 6px;
      border-radius: 10px;
      width: fit-content;
  }
  .mode-selector label {
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
  }
  .mode-selector input[type="radio"] { display: none; }
  .mode-selector input[type="radio"]:checked + label {
      background-color: var(--bg-secondary);
      color: var(--accent-primary);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }

  .distributor-container {
      background-color: rgba(120, 120, 120, 0.05);
      border: 1px dashed var(--border-color);
      padding: 24px;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      gap: 20px;
  }

  .token-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
  }
  .token-filters label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 14px;
  }

  .distributor-controls {
      display: flex;
      gap: 16px;
      align-items: center;
  }
  .distributor-controls .input-group { flex-grow: 1; }
  #leftover-mush {
      margin-top: 28px;
      font-weight: 500;
      color: var(--text-secondary);
  }
  #leftover-mush span {
    color: var(--accent-primary);
    font-weight: 700;
  }
  
  table { width: 100%; border-collapse: collapse; }
  th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border-color); transition: background-color 0.3s ease; }
  td:nth-child(3), td:nth-child(4), th:nth-child(3), th:nth-child(4) { text-align: center; }
  th { font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
  tbody tr:hover { background-color: rgba(120, 120, 120, 0.05); }
  tfoot td { border-bottom: none; }
  tfoot b { color: var(--accent-primary); }
  .buttons { display: flex; justify-content: center; gap: 12px; margin-top: 16px; flex-wrap: wrap;}
  button { padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: transform 0.15s ease, background-color 0.2s, color 0.2s, box-shadow 0.2s; }
  button:hover { transform: translateY(-2px) scale(1.02); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); }
  #btnCalcular, #btnDistribute { background: var(--accent-primary); color: #fff; }
  #btnCalcular:hover, #btnDistribute:hover { background: var(--accent-hover); }
  #btnResetar { background: var(--accent-danger); color: var(--text-primary); }
  #btnGerarImagem { background: var(--bg-tertiary); color: var(--text-primary); }
  
  #resultado { display: none; position: absolute; left: -9999px; top: 0; width: 600px; background-color: var(--bg-secondary); color: var(--text-primary); padding: 32px; border-radius: 16px; border: 1px solid var(--border-color); }
  #resultado h3 { color: var(--accent-primary); text-align: center; font-family: var(--font-header); font-size: 22px; margin-bottom: 24px; }
  #resumo-itens, #resumo-totais { display: flex; flex-direction: column; gap: 12px; }
  .receipt-section-title { color: var(--text-secondary); font-size: 14px; font-weight: 600; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; margin-bottom: 8px; }
  .receipt-line { display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
  .receipt-label { color: var(--text-secondary); }
  .receipt-value { font-weight: 600; color: var(--text-primary); }
  #resumo-totais { margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border-color); }
  .receipt-line.final-total .receipt-label { font-size: 16px; font-weight: 700; color: var(--text-primary); }
  .receipt-line.final-total .receipt-value { font-size: 18px; font-weight: 700; color: var(--accent-primary); }
  .agradecimento { text-align: center; margin-top: 32px; font-size: 14px; color: var(--text-secondary); }
  .moeda-img { vertical-align: -3px; width: 18px; height: 18px; margin-left: 8px; }
</style>
</head>
<body>

<div class="container" id="calculadora-container">
  
  <div class="settings-bar">
      <div class="language-switcher">
          <button id="lang-br">🇧🇷</button>
          <button id="lang-en">🇺🇸</button>
      </div>
      <div class="theme-switcher">
          <span class="theme-switcher-label" data-translate-key="themeLabel"></span>
          <div class="toggle-track" id="theme-toggle">
              <div class="toggle-thumb"></div>
          </div>
      </div>
  </div>

  <h2 data-translate-key="mainHeader">Calculadora de Tokens</h2>

  <div class="input-group">
    <label for="nomeCliente" data-translate-key="idLabel">Identificador / Nome</label>
    <input type="text" id="nomeCliente" data-translate-key-placeholder="idPlaceholder">
  </div>
  <div class="input-group">
    <label for="desconto" data-translate-key="discountLabel">Desconto (%)</label>
    <input type="number" id="desconto" data-translate-key-placeholder="discountPlaceholder" min="0" max="100">
  </div>

  <div class="input-group">
      <label data-translate-key="calculationMode">Modo de Cálculo</label>
      <div class="mode-selector">
          <input type="radio" id="mode-qty" name="calculation-mode" value="quantity" checked>
          <label for="mode-qty" data-translate-key="modeQty">Por Quantidade</label>
          <input type="radio" id="mode-mush" name="calculation-mode" value="mush">
          <label for="mode-mush" data-translate-key="modeMush">Por Mush</label>
      </div>
  </div>
  
  <div class="distributor-container" id="distributor-section" style="display: none;">
      <div>
          <label data-translate-key="distributeTokensLabel">Tokens Desejáveis para Distribuição</label>
          <div class="token-filters" id="token-filters-container">
          </div>
      </div>
      <div class="distributor-controls">
          <div class="input-group">
              <label for="total-mush" data-translate-key="totalMushLabel">Total de Mush a Gastar</label>
              <input type="number" id="total-mush" placeholder="30000">
          </div>
          <button id="btnDistribute" data-translate-key="btnDistribute">Distribuir</button>
      </div>
      <div id="leftover-mush"></div>
  </div>

  <table>
    <thead>
      <tr>
        <th data-translate-key="tableItem">Item</th>
        <th data-translate-key="tablePrice">Preço Unitário</th>
        <th data-translate-key="tableQty">Quantidade</th>
        <th data-translate-key="tableTotal">Valor Total</th>
      </tr>
    </thead>
    <tbody id="tabela-itens">
    </tbody>
    <tfoot>
      <tr>
        <td colspan="3"><b data-translate-key="tableGrandTotal">TOTAL GERAL</b></td>
        <td id="totalGeral" style="text-align: center;"><b>0.00</b></td>
      </tr>
    </tfoot>
  </table>

  <div class="buttons">
    <button id="btnCalcular" data-translate-key="btnCalculate">Calcular</button>
    <button id="btnResetar" data-translate-key="btnReset">Resetar</button>
    <button id="btnGerarImagem" data-translate-key="btnExport">Exportar para PNG</button>
  </div>
</div>

<div id="resultado">
  <h3 data-translate-key="receiptHeader">Recibo - <span id="resNome"></span></h3>
  <div class="receipt-section" id="resumo-itens"></div>
  <div class="receipt-section" id="resumo-totais"></div>
  <p class="agradecimento" data-translate-key="receiptThanks">✨ Agradecemos a preferência! ✨</p>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

  const MOEDA_BASE64 = ""; // COLE SUA STRING BASE64 AQUI
  const ITENS_CATALOGO = {
    revive: { preco: 790, name_br: 'Revive Token', name_en: 'Revive Token' },
    max: { preco: 570, name_br: 'Max Growth Token', name_en: 'Max Growth Token' },
    partial: { preco: 195, name_br: 'Partial Growth Token', name_en: 'Partial Growth Token' },
    change: { preco: 90, name_br: 'Appearance Change Token', name_en: 'Appearance Change Token' }
  };

  const TRANSLATIONS = {
      br: {
          pageTitle: "Calculadora de Tokens", mainHeader: "Calculadora de Tokens", themeLabel: "Tema Claro",
          idLabel: "Identificador / Nome", idPlaceholder: "Digite seu nome ou ID", discountLabel: "Desconto (%)",
          discountPlaceholder: "Ex: 10", tableItem: "Item", tablePrice: "Preço Unitário", tableQty: "Quantidade",
          tableTotal: "Valor Total", tableGrandTotal: "TOTAL GERAL", btnCalculate: "Calcular", btnReset: "Resetar",
          btnExport: "Exportar para PNG", alertNoItems: "Nenhum item foi selecionado para gerar o recibo.",
          alertInsufficientMush: "Mush insuficiente para comprar ao menos um de cada item selecionado.",
          receiptHeader: "Recibo", receiptItemsHeader: "Itens Comprados", receiptSubtotal: "Subtotal",
          receiptDiscount: "Desconto", receiptFinalTotal: "Total Final", receiptThanks: "✨ Agradecemos a preferência! ✨",
          calculationMode: "Modo de Cálculo", modeQty: "Por Quantidade", modeMush: "Por Mush",
          distributeTokensLabel: "Tokens Desejáveis para Distribuição", totalMushLabel: "Total de Mush a Gastar",
          btnDistribute: "Distribuir", leftoverMushText: "Sobrou:",
          leftoverConfirm1: "Sobraram",
          leftoverConfirm2: "Deseja distribuir este valor nos itens restantes:"
      },
      en: {
          pageTitle: "Token Calculator", mainHeader: "Token Calculator", themeLabel: "Light Theme",
          idLabel: "Identifier / Name", idPlaceholder: "Enter your name or ID", discountLabel: "Discount (%)",
          discountPlaceholder: "Ex: 10", tableItem: "Item", tablePrice: "Unit Price", tableQty: "Quantity",
          tableTotal: "Total Value", tableGrandTotal: "GRAND TOTAL", btnCalculate: "Calculate", btnReset: "Reset",
          btnExport: "Export to PNG", alertNoItems: "No items were selected to generate the receipt.",
          alertInsufficientMush: "Insufficient mush to purchase at least one of each selected item.",
          receiptHeader: "Receipt", receiptItemsHeader: "Purchased Items", receiptSubtotal: "Subtotal",
          receiptDiscount: "Discount", receiptFinalTotal: "Final Total", receiptThanks: "✨ Thank you for your preference! ✨",
          calculationMode: "Calculation Mode", modeQty: "By Quantity", modeMush: "By Mush",
          distributeTokensLabel: "Desirable Tokens for Distribution", totalMushLabel: "Total Mush to Spend",
          btnDistribute: "Distribute", leftoverMushText: "Leftover:",
          leftoverConfirm1: "There is",
          leftoverConfirm2: "leftover. Do you want to distribute this amount to the remaining items:"
      }
  };
  
  const dom = {
    html: document.documentElement,
    nomeClienteInput: document.getElementById('nomeCliente'),
    descontoInput: document.getElementById('desconto'),
    tabelaItensBody: document.getElementById('tabela-itens'),
    totalGeralCell: document.getElementById('totalGeral'),
    resultadoDiv: document.getElementById('resultado'),
    resNomeSpan: document.getElementById('resNome'),
    resumoItensDiv: document.getElementById('resumo-itens'),
    resumoTotaisDiv: document.getElementById('resumo-totais'),
    btnCalcular: document.getElementById('btnCalcular'),
    btnResetar: document.getElementById('btnResetar'),
    btnGerarImagem: document.getElementById('btnGerarImagem'),
    themeToggle: document.getElementById('theme-toggle'),
    langBr: document.getElementById('lang-br'),
    langEn: document.getElementById('lang-en'),
    modeQtyRadio: document.getElementById('mode-qty'),
    modeMushRadio: document.getElementById('mode-mush'),
    distributorSection: document.getElementById('distributor-section'),
    tokenFiltersContainer: document.getElementById('token-filters-container'),
    totalMushInput: document.getElementById('total-mush'),
    btnDistribute: document.getElementById('btnDistribute'),
    leftoverMushDiv: document.getElementById('leftover-mush')
  };

  let currentLang = 'br';

  const app = {
    init() {
        this.loadPreferences();
        this.addEventListeners();
        this.setLanguage(currentLang);
    },

    loadPreferences() {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        this.setTheme(savedTheme);
        const savedLang = localStorage.getItem('language') || 'br';
        currentLang = savedLang;
    },

    addEventListeners() {
        dom.descontoInput.addEventListener('input', this.updateUI.bind(this));
        dom.btnCalcular.addEventListener('click', this.updateUI.bind(this));
        dom.btnResetar.addEventListener('click', this.reset.bind(this));
        dom.btnGerarImagem.addEventListener('click', this.generateImage.bind(this));
        dom.themeToggle.addEventListener('click', () => {
            const newTheme = dom.html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            this.setTheme(newTheme);
        });
        dom.langBr.addEventListener('click', () => this.setLanguage('br'));
        dom.langEn.addEventListener('click', () => this.setLanguage('en'));
        dom.modeQtyRadio.addEventListener('change', () => this.toggleMode('quantity'));
        dom.modeMushRadio.addEventListener('change', () => this.toggleMode('mush'));
        dom.btnDistribute.addEventListener('click', this.distributeMush.bind(this));
    },

    toggleMode(mode) {
        if (mode === 'quantity') {
            dom.distributorSection.style.display = 'none';
            dom.tabelaItensBody.querySelectorAll('input').forEach(input => input.disabled = false);
            dom.btnCalcular.style.display = 'inline-block';
        } else {
            dom.distributorSection.style.display = 'flex';
            dom.tabelaItensBody.querySelectorAll('input').forEach(input => input.disabled = true);
            dom.btnCalcular.style.display = 'none';
        }
    },

    setTheme(theme) {
        dom.html.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
    },

    setLanguage(lang) {
        currentLang = lang;
        localStorage.setItem('language', lang);
        document.querySelectorAll('[data-translate-key]').forEach(el => {
            const key = el.dataset.translateKey;
            if (TRANSLATIONS[lang][key]) el.innerText = TRANSLATIONS[lang][key];
        });
        document.querySelectorAll('[data-translate-key-placeholder]').forEach(el => {
            const key = el.dataset.translateKeyPlaceholder;
            if (TRANSLATIONS[lang][key]) el.placeholder = TRANSLATIONS[lang][key];
        });
        document.title = TRANSLATIONS[lang].pageTitle;
        dom.langBr.classList.toggle('active', lang === 'br');
        dom.langEn.classList.toggle('active', lang === 'en');
        this.loadTable();
        this.buildTokenFilters();
        this.updateUI();
    },
    
    buildTokenFilters() {
        dom.tokenFiltersContainer.innerHTML = '';
        for (const key in ITENS_CATALOGO) {
            const item = ITENS_CATALOGO[key];
            const label = document.createElement('label');
            label.innerHTML = `
                <input type="checkbox" value="${key}" checked>
                <span>${item[`name_${currentLang}`]}</span>
            `;
            dom.tokenFiltersContainer.appendChild(label);
        }
    },

    distributeMush() {
        let totalMush = parseInt(dom.totalMushInput.value) || 0;
        const discount = parseFloat(dom.descontoInput.value) || 0;
        const selectedTokenKeys = Array.from(dom.tokenFiltersContainer.querySelectorAll('input:checked')).map(cb => cb.value);

        this.reset(false);

        if (selectedTokenKeys.length === 0) return;

        const itemsToConsider = selectedTokenKeys.map(key => ({ 
            key, 
            ...ITENS_CATALOGO[key],
            priceWithDiscount: ITENS_CATALOGO[key].preco * (1 - (discount / 100))
        }));
        
        const t = TRANSLATIONS[currentLang];
        let remainingMush = totalMush;

        const fairShare = totalMush / itemsToConsider.length;

        itemsToConsider.forEach(item => {
            if (item.priceWithDiscount > 0 && fairShare >= item.priceWithDiscount) {
                const quantityFromShare = Math.floor(fairShare / item.priceWithDiscount);
                const qtyInput = document.getElementById(`qtd-${item.key}`);
                if (qtyInput) qtyInput.value = quantityFromShare;
                remainingMush -= quantityFromShare * item.priceWithDiscount;
            }
        });

        const sortedForLeftover = itemsToConsider.sort((a, b) => b.priceWithDiscount - a.priceWithDiscount);
        for (const item of sortedForLeftover) {
            if (remainingMush < item.priceWithDiscount) continue;
            const additionalQuantity = Math.floor(remainingMush / item.priceWithDiscount);
            const qtyInput = document.getElementById(`qtd-${item.key}`);
            if (qtyInput) qtyInput.value = parseInt(qtyInput.value || 0) + additionalQuantity;
            remainingMush -= additionalQuantity * item.priceWithDiscount;
        }

        const allTokenKeys = Object.keys(ITENS_CATALOGO);
        const unselectedTokenKeys = allTokenKeys.filter(key => !selectedTokenKeys.includes(key));

        if (remainingMush > 1 && unselectedTokenKeys.length > 0) {
            const unselectedNames = unselectedTokenKeys.map(key => ITENS_CATALOGO[key][`name_${currentLang}`]).join(', ');
            const confirmMessage = `${t.leftoverConfirm1} ${remainingMush.toFixed(2)} mush. ${t.leftoverConfirm2} ${unselectedNames}?`;
            
            if (window.confirm(confirmMessage)) {
                const leftoverItems = unselectedTokenKeys
                    .map(key => ({ key, ...ITENS_CATALOGO[key], priceWithDiscount: ITENS_CATALOGO[key].preco * (1 - (discount / 100)) }))
                    .sort((a, b) => b.priceWithDiscount - a.priceWithDiscount);
                
                for (const item of leftoverItems) {
                    if (remainingMush < item.priceWithDiscount) continue;
                    const leftoverQuantity = Math.floor(remainingMush / item.priceWithDiscount);
                    const qtyInput = document.getElementById(`qtd-${item.key}`);
                    if (qtyInput) qtyInput.value = parseInt(qtyInput.value || 0) + leftoverQuantity;
                    remainingMush -= leftoverQuantity * item.priceWithDiscount;
                }
            }
        }

        dom.leftoverMushDiv.innerHTML = `${t.leftoverMushText} <span>${remainingMush.toFixed(2)}</span>`;
        dom.leftoverMushDiv.querySelector('span').appendChild(this.createCoinIcon());
        this.updateUI();
    },

    calculateValues() {
        const descontoPercentual = parseFloat(dom.descontoInput.value) || 0;
        const resultados = {
          itens: {}, totalBruto: 0, totalFinal: 0, valorDescontoTotal: 0, descontoPercentual: descontoPercentual
        };
        for (const key in ITENS_CATALOGO) {
          const item = ITENS_CATALOGO[key];
          const qtdInput = document.getElementById(`qtd-${key}`);
          const quantidade = qtdInput ? parseInt(qtdInput.value) || 0 : 0;
          const precoOriginal = item.preco;
          const precoComDesconto = precoOriginal * (1 - (descontoPercentual / 100));
          const subtotal = quantidade * precoComDesconto;
          resultados.itens[key] = {
            nome: item[`name_${currentLang}`], quantidade: quantidade, precoOriginal: precoOriginal, precoComDesconto: precoComDesconto, subtotal: subtotal
          };
          resultados.totalBruto += quantidade * precoOriginal;
          resultados.totalFinal += subtotal;
        }
        resultados.valorDescontoTotal = resultados.totalBruto - resultados.totalFinal;
        return resultados;
    },

    createCoinIcon() {
        const img = document.createElement('img');
        img.src = MOEDA_BASE64;
        img.className = 'moeda-img';
        img.alt = 'mush';
        return img;
    },

    loadTable() {
        const currentValues = {};
        document.querySelectorAll('#tabela-itens input[type="number"]').forEach(input => {
            currentValues[input.id] = input.value;
        });
        dom.tabelaItensBody.innerHTML = '';
        for (const key in ITENS_CATALOGO) {
          const item = ITENS_CATALOGO[key];
          const tr = document.createElement('tr');
          const savedQty = currentValues[`qtd-${key}`] || 0;
          tr.innerHTML = `
            <td>${item[`name_${currentLang}`]}</td>
            <td>${item.preco.toFixed(2)}</td>
            <td style="text-align: center;"><div style="width: 80px; margin: 0 auto;"><input type="number" id="qtd-${key}" value="${savedQty}" min="0"></div></td>
            <td style="text-align: center;">0.00</td>
          `;
          tr.querySelector(`td:nth-child(2)`).appendChild(this.createCoinIcon());
          tr.querySelector(`td:nth-child(4)`).appendChild(this.createCoinIcon());
          dom.tabelaItensBody.appendChild(tr);
          tr.querySelector(`#qtd-${key}`).addEventListener('input', this.updateUI.bind(this));
        }
    },

    updateUI() {
        const calculo = this.calculateValues();
        const rows = dom.tabelaItensBody.getElementsByTagName('tr');
        Array.from(rows).forEach((row, index) => {
          const key = Object.keys(ITENS_CATALOGO)[index];
          if (!calculo.itens[key]) return;
          const itemCalculado = calculo.itens[key];
          const precoCell = row.querySelector(`td:nth-child(2)`);
          const totalCell = row.querySelector(`td:nth-child(4)`);
          if (calculo.descontoPercentual > 0) {
            precoCell.innerHTML = `${itemCalculado.precoOriginal.toFixed(2)} ➝ ${itemCalculado.precoComDesconto.toFixed(2)}`;
          } else {
            precoCell.innerHTML = `${itemCalculado.precoOriginal.toFixed(2)}`;
          }
          precoCell.appendChild(this.createCoinIcon());
          totalCell.innerHTML = `${itemCalculado.subtotal.toFixed(2)}`;
          totalCell.appendChild(this.createCoinIcon());
        });
        dom.totalGeralCell.innerHTML = `<b>${calculo.totalFinal.toFixed(2)}</b>`;
        dom.totalGeralCell.appendChild(this.createCoinIcon());
    },
    
    reset(clearDistributor = true) {
        dom.nomeClienteInput.value = '';
        dom.descontoInput.value = '';
        if(clearDistributor) {
            dom.totalMushInput.value = '';
            dom.leftoverMushDiv.innerHTML = '';
        }
        for (const key in ITENS_CATALOGO) {
            const input = document.getElementById(`qtd-${key}`);
            if (input) input.value = 0;
        }
        this.updateUI();
    },
    
    generateImage() {
        const calculo = this.calculateValues();
        const nome = dom.nomeClienteInput.value.trim() || 'Nao_Identificado';
        let temItens = false;
        const t = TRANSLATIONS[currentLang];

        if (window.saveReceiptToFirebase) {
            const itemsToSave = {};
            for(const key in calculo.itens) {
                if(calculo.itens[key].quantidade > 0) {
                    itemsToSave[key] = calculo.itens[key].quantidade;
                    temItens = true;
                }
            }
            if(temItens) {
                const receiptData = {
                    customerName: nome,
                    discountApplied: calculo.descontoPercentual,
                    grandTotal: calculo.totalFinal,
                    items: itemsToSave
                };
                window.saveReceiptToFirebase(receiptData);
            }
        }
        
        dom.resultadoDiv.querySelector('h3').innerHTML = `${t.receiptHeader} - <span id="resNome">${nome}</span>`;
        dom.resumoItensDiv.innerHTML = `<h4 class="receipt-section-title">${t.receiptItemsHeader}</h4>`;
        dom.resumoTotaisDiv.innerHTML = '';
        
        let hasItemsForReceipt = false;
        for(const key in calculo.itens) {
          const item = calculo.itens[key];
          if (item.quantidade > 0) {
            hasItemsForReceipt = true;
            const itemLine = document.createElement('div');
            itemLine.className = 'receipt-line';
            const precoComMoeda = document.createElement('span');
            precoComMoeda.className = 'receipt-value';
            precoComMoeda.textContent = item.subtotal.toFixed(2);
            precoComMoeda.appendChild(this.createCoinIcon());
            itemLine.innerHTML = `<span class="receipt-label">${item.nome} (x${item.quantidade})</span>`;
            itemLine.appendChild(precoComMoeda);
            dom.resumoItensDiv.appendChild(itemLine);
          }
        }
        if (!hasItemsForReceipt) { alert(t.alertNoItems); return; }
        if (calculo.descontoPercentual > 0) {
            dom.resumoTotaisDiv.innerHTML += `<div class="receipt-line"><span class="receipt-label">${t.receiptSubtotal}</span><span class="receipt-value">${calculo.totalBruto.toFixed(2)}</span></div><div class="receipt-line"><span class="receipt-label">${t.receiptDiscount} (${calculo.descontoPercentual.toFixed(2)}%)</span><span class="receipt-value">- ${calculo.valorDescontoTotal.toFixed(2)}</span></div>`;
        }
        dom.resumoTotaisDiv.innerHTML += `<div class="receipt-line final-total"><span class="receipt-label">${t.receiptFinalTotal}</span><span class="receipt-value">${calculo.totalFinal.toFixed(2)}</span></div>`;
        dom.resumoTotaisDiv.querySelectorAll('.receipt-value').forEach(el => el.appendChild(this.createCoinIcon()));
        dom.resultadoDiv.style.display = 'block';
        setTimeout(() => {
            html2canvas(dom.resultadoDiv, { backgroundColor: null, scale: 2 }).then(canvas => {
              const link = document.createElement('a');
              const nomeSanitizado = nome.normalize('NFD').replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '_').replace(/[^\w-]/g, '');
              link.download = `${nomeSanitizado}_recibo.png`;
              link.href = canvas.toDataURL('image/png');
              link.click();
              dom.resultadoDiv.style.display = 'none';
            });
        }, 300);
      }
  };
  
  app.init();
});
</script>

</body>
</html>
