<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
<meta charset="UTF-8">
<title>Calculadora de Tokens</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Poppins:wght@700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>


<style>
  :root {
    --font-header: 'Poppins', sans-serif;
    --font-body: 'Inter', sans-serif;
    --bg-primary: #18181b;
    --bg-secondary: #27272a;
    --bg-tertiary: #3f3f46;
    --border-color: #3f3f46;
    --accent-primary: #34d399;
    --accent-hover: #10b981;
    --accent-danger: #f43f5e;
    --text-primary: #f8fafc;
    --text-secondary: #a1a1aa;
    --text-error: #fca5a5;
  }

  html[data-theme='light'] {
    --bg-primary: #f4f4f5;
    --bg-secondary: #ffffff;
    --bg-tertiary: #e4e4e7;
    --border-color: #d4d4d8;
    --accent-primary: #10b981;
    --accent-hover: #0f9a6c;
    --accent-danger: #ef4444;
    --text-primary: #18181b;
    --text-secondary: #71717a;
    --text-error: #b91c1c;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background-color: var(--bg-primary);
    color: var(--text-primary);
    font-family: var(--font-body);
    padding: 40px 20px;
    transition: background-color 0.3s ease, color 0.3s ease;
    display: flex;
    align-items: flex-start; /* Alinha no topo para quando a calculadora estiver vis√≠vel */
    justify-content: center;
    min-height: 100vh;
  }

  /* ESTILOS PARA O CONTAINER DE LOGIN */
  #auth-container {
    width: 100%;
    max-width: 400px;
    background: var(--bg-secondary);
    padding: 32px;
    border-radius: 16px;
    border: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    gap: 24px;
    margin-top: 10vh; /* Centraliza um pouco na vertical */
  }
  #auth-error {
      color: var(--text-error);
      font-size: 14px;
      text-align: center;
      min-height: 20px;
  }

  .container {
    width: 100%;
    max-width: 800px;
    margin: auto;
    background: var(--bg-secondary);
    padding: 32px;
    border-radius: 16px;
    border: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    gap: 24px;
    transition: background-color 0.3s ease, border-color 0.3s ease;
    opacity: 0;
    transform: translateY(20px);
    animation: fadeIn 0.5s 0.2s ease-out forwards;
  }
  
  @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
  
  .settings-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
  }
  .settings-controls { display: flex; align-items: center; gap: 20px;}

  .language-switcher button { background: none; border: none; padding: 4px; cursor: pointer; transition: all 0.3s ease; }
  .language-switcher button:not(.active) { filter: grayscale(100%); opacity: 0.6; }
  html[data-theme='dark'] .language-switcher button:not(.active) { filter: grayscale(100%) invert(100%); opacity: 0.8; }
  .language-switcher button.active, .language-switcher button:not(.active):hover { filter: none; opacity: 1; transform: scale(1.1); }
  
  .theme-switcher { display: flex; align-items: center; gap: 8px; }
  .theme-switcher-label { font-size: 12px; color: var(--text-secondary); font-weight: 500; }
  .toggle-track { width: 44px; height: 24px; background-color: var(--bg-tertiary); border-radius: 99px; position: relative; cursor: pointer; transition: background-color 0.3s ease; }
  .toggle-thumb { width: 18px; height: 18px; background-color: white; border-radius: 50%; position: absolute; top: 3px; left: 4px; transition: transform 0.3s ease; }
  html[data-theme='light'] .toggle-track { background-color: var(--accent-primary); }
  html[data-theme='light'] .toggle-thumb { transform: translateX(19px); }

  h2 { font-family: var(--font-header); color: var(--accent-primary); font-size: 28px; font-weight: 700; text-align: center;}
  .input-group { display: flex; flex-direction: column; gap: 8px; }
  .input-group label { font-size: 14px; font-weight: 500; color: var(--text-secondary); }

  input[type="text"], input[type="number"], input[type="password"] {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    background-color: var(--bg-tertiary);
    color: var(--text-primary);
    font-size: 16px;
    transition: all 0.3s ease;
  }
  
  input[type="text"]:focus, input[type="number"]:focus, input[type="password"]:focus {
    outline: none;
    border-color: var(--accent-primary);
    box-shadow: 0 0 0 3px rgba(52, 211, 153, 0.3);
  }
  
  /* --- ESTILOS PARA O SISTEMA DE ABAS --- */
  .tab-navigation {
      display: flex;
      border-bottom: 1px solid var(--border-color);
  }
  .tab-link {
      padding: 12px 20px;
      cursor: pointer;
      background: none;
      border: none;
      color: var(--text-secondary);
      font-weight: 600;
      font-size: 16px;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
  }
  .tab-link:hover {
      color: var(--text-primary);
  }
  .tab-link.active {
      color: var(--accent-primary);
      border-bottom-color: var(--accent-primary);
  }
  .tab-content {
      padding-top: 24px;
  }

  /* ... O resto dos estilos ... */
  
  .hidden { display: none !important; }

</style>
</head>
<body>

<div id="auth-container">
    <h2 data-translate-key="loginHeader">Login</h2>
    <div class="input-group">
        <label for="username-input" data-translate-key="usernameLabel">Usu√°rio</label>
        <input type="text" id="username-input" autocomplete="username">
    </div>
    <div class="input-group">
        <label for="password-input" data-translate-key="passwordLabel">Senha</label>
        <input type="password" id="password-input" autocomplete="current-password">
    </div>
    <p id="auth-error"></p>
    <button id="btnLogin" data-translate-key="loginButton">Entrar</button>
</div>


<div id="app-container" class="hidden">
    <div class="container" id="calculadora-container">
      <div class="settings-bar">
          <div class="language-switcher">
              <button id="lang-br">üáßüá∑</button>
              <button id="lang-en">üá∫üá∏</button>
          </div>
          <div class="settings-controls">
              <div class="theme-switcher">
                  <span class="theme-switcher-label" data-translate-key="themeLabel"></span>
                  <div class="toggle-track" id="theme-toggle">
                      <div class="toggle-thumb"></div>
                  </div>
              </div>
              <button id="btnLogout" data-translate-key="logoutButton">Sair</button>
          </div>
      </div>

      <div class="tab-navigation">
          <button class="tab-link active" data-tab="calculator-view" data-translate-key="tabCalculator">Calculadora</button>
          <button class="tab-link" data-tab="history-view" data-translate-key="tabHistory">Hist√≥rico</button>
      </div>

      <div id="calculator-view" class="tab-content">
          <h2 data-translate-key="mainHeader">Calculadora de Tokens</h2>
          
          <div class="input-group">
            <label for="nomeCliente" data-translate-key="idLabel">Identificador / Nome</label>
            <input type="text" id="nomeCliente" data-translate-key-placeholder="idPlaceholder">
          </div>
          <div class="input-group">
            <label for="desconto" data-translate-key="discountLabel">Desconto (%)</label>
            <input type="number" id="desconto" data-translate-key-placeholder="discountPlaceholder" min="0" max="100">
          </div>
          <div class="input-group">
              <label data-translate-key="calculationMode">Modo de C√°lculo</label>
              <div class="mode-selector">
                  <input type="radio" id="mode-qty" name="calculation-mode" value="quantity" checked>
                  <label for="mode-qty" data-translate-key="modeQty">Por Quantidade</label>
                  <input type="radio" id="mode-mush" name="calculation-mode" value="mush">
                  <label for="mode-mush" data-translate-key="modeMush">Por Mush</label>
              </div>
          </div>
          <div class="distributor-container" id="distributor-section" style="display: none;">
              <div>
                  <label data-translate-key="distributeTokensLabel">Tokens Desej√°veis para Distribui√ß√£o</label>
                  <div class="token-filters" id="token-filters-container"></div>
              </div>
              <div class="distributor-controls">
                  <div class="input-group">
                      <label for="total-mush" data-translate-key="totalMushLabel">Total de Mush a Gastar</label>
                      <input type="number" id="total-mush" placeholder="30000">
                  </div>
                  <button id="btnDistribute" data-translate-key="btnDistribute">Distribuir</button>
              </div>
              <div id="leftover-mush"></div>
          </div>
          <table>
            <thead>
              <tr>
                <th data-translate-key="tableItem">Item</th>
                <th data-translate-key="tablePrice">Pre√ßo Unit√°rio</th>
                <th data-translate-key="tableQty">Quantidade</th>
                <th data-translate-key="tableTotal">Valor Total</th>
              </tr>
            </thead>
            <tbody id="tabela-itens"></tbody>
            <tfoot>
              <tr>
                <td colspan="3"><b data-translate-key="tableGrandTotal">TOTAL GERAL</b></td>
                <td id="totalGeral" style="text-align: center;"><b>0.00</b></td>
              </tr>
            </tfoot>
          </table>
          <div class="buttons">
            <button id="btnCalcular" data-translate-key="btnCalculate">Calcular</button>
            <button id="btnResetar" data-translate-key="btnReset">Resetar</button>
            <button id="btnGerarImagem" data-translate-key="btnExport">Exportar para PNG</button>
          </div>
      </div>
      
      <div id="history-view" class="tab-content hidden">
          <h2 data-translate-key="historyHeader">Hist√≥rico de Vendas</h2>
          <div id="history-table-container">
              </div>
      </div>

    </div>
</div>

<div id="resultado">
  <h3 data-translate-key="receiptHeader">Recibo - <span id="resNome"></span></h3>
  <div class="receipt-section" id="resumo-itens"></div>
  <div class="receipt-section" id="resumo-totais"></div>
  <p class="agradecimento" data-translate-key="receiptThanks">‚ú® Agradecemos a prefer√™ncia! ‚ú®</p>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDgeTU4YmFpZIwcmE2-cxGKTkO2KqeQotE",
    authDomain: "token-calculator-a45d6.firebaseapp.com",
    projectId: "token-calculator-a45d6",
    storageBucket: "token-calculator-a45d6.firebasestorage.app",
    messagingSenderId: "597974335563",
    appId: "1:597974335563:web:9d07ada2708d61b7d30dce""
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  document.addEventListener('DOMContentLoaded', () => {

    const MOEDA_BASE64 = ""; // COLE SUA STRING BASE64 AQUI
    const ITENS_CATALOGO = {
      revive: { preco: 790, name_br: 'Revive Token', name_en: 'Revive Token' },
      max: { preco: 570, name_br: 'Max Growth Token', name_en: 'Max Growth Token' },
      partial: { preco: 195, name_br: 'Partial Growth Token', name_en: 'Partial Growth Token' },
      change: { preco: 90, name_br: 'Appearance Change Token', name_en: 'Appearance Change Token' }
    };

    const TRANSLATIONS = {
      br: {
          pageTitle: "Calculadora de Tokens", mainHeader: "Calculadora de Tokens", themeLabel: "Tema Claro",
          idLabel: "Identificador / Nome", idPlaceholder: "Digite seu nome ou ID", discountLabel: "Desconto (%)",
          discountPlaceholder: "Ex: 10", tableItem: "Item", tablePrice: "Pre√ßo Unit√°rio", tableQty: "Quantidade",
          tableTotal: "Valor Total", tableGrandTotal: "TOTAL GERAL", btnCalculate: "Calcular", btnReset: "Resetar",
          btnExport: "Exportar para PNG", alertNoItems: "Nenhum item foi selecionado para gerar o recibo.",
          alertInsufficientMush: "Mush insuficiente para comprar ao menos um de cada item selecionado.",
          receiptHeader: "Recibo", receiptItemsHeader: "Itens Comprados", receiptSubtotal: "Subtotal",
          receiptDiscount: "Desconto", receiptFinalTotal: "Total Final", receiptThanks: "‚ú® Agradecemos a prefer√™ncia! ‚ú®",
          calculationMode: "Modo de C√°lculo", modeQty: "Por Quantidade", modeMush: "Por Mush",
          distributeTokensLabel: "Tokens Desej√°veis para Distribui√ß√£o", totalMushLabel: "Total de Mush a Gastar",
          btnDistribute: "Distribuir", leftoverMushText: "Sobrou:",
          leftoverConfirm1: "Sobraram", leftoverConfirm2: "Deseja distribuir este valor nos itens restantes:",
          loginHeader: "Acessar Calculadora", usernameLabel: "Usu√°rio", passwordLabel: "Senha",
          loginButton: "Entrar", logoutButton: "Sair", errorInvalidCredentials: "Usu√°rio ou senha inv√°lidos.",
          errorGeneric: "Ocorreu um erro. Tente novamente.",
          tabCalculator: "Calculadora", tabHistory: "Hist√≥rico", historyHeader: "Hist√≥rico de Vendas",
          historyCustomer: "Cliente", historyDate: "Data", historyTotal: "Total", historySeller: "Vendedor",
          historyNoRecords: "Nenhum registro encontrado."
      },
      en: {
          pageTitle: "Token Calculator", mainHeader: "Token Calculator", themeLabel: "Light Theme",
          idLabel: "Identifier / Name", idPlaceholder: "Enter your name or ID", discountLabel: "Discount (%)",
          discountPlaceholder: "Ex: 10", tableItem: "Item", tablePrice: "Unit Price", tableQty: "Quantity",
          tableTotal: "Total Value", tableGrandTotal: "GRAND TOTAL", btnCalculate: "Calculate", btnReset: "Reset",
          btnExport: "Export to PNG", alertNoItems: "No items were selected to generate the receipt.",
          alertInsufficientMush: "Insufficient mush to purchase at least one of each selected item.",
          receiptHeader: "Receipt", receiptItemsHeader: "Purchased Items", receiptSubtotal: "Subtotal",
          receiptDiscount: "Discount", receiptFinalTotal: "Final Total", receiptThanks: "‚ú® Thank you for your preference! ‚ú®",
          calculationMode: "Calculation Mode", modeQty: "By Quantity", modeMush: "By Mush",
          distributeTokensLabel: "Desirable Tokens for Distribution", totalMushLabel: "Total Mush to Spend",
          btnDistribute: "Distribute", leftoverMushText: "Leftover:",
          leftoverConfirm1: "There is", leftoverConfirm2: "leftover. Do you want to distribute this amount to the remaining items:",
          loginHeader: "Calculator Login", usernameLabel: "Username", passwordLabel: "Password",
          loginButton: "Login", logoutButton: "Logout", errorInvalidCredentials: "Invalid username or password.",
          errorGeneric: "An error occurred. Please try again.",
          tabCalculator: "Calculator", tabHistory: "History", historyHeader: "Sales History",
          historyCustomer: "Customer", historyDate: "Date", historyTotal: "Total", historySeller: "Seller",
          historyNoRecords: "No records found."
      }
    };
    
    const dom = {
      // ... (todos os seletores DOM existentes)
      authContainer: document.getElementById('auth-container'),
      appContainer: document.getElementById('app-container'),
      usernameInput: document.getElementById('username-input'),
      passwordInput: document.getElementById('password-input'),
      btnLogin: document.getElementById('btnLogin'),
      btnLogout: document.getElementById('btnLogout'),
      authError: document.getElementById('auth-error'),
      html: document.documentElement,
      nomeClienteInput: document.getElementById('nomeCliente'),
      descontoInput: document.getElementById('desconto'),
      tabelaItensBody: document.getElementById('tabela-itens'),
      totalGeralCell: document.getElementById('totalGeral'),
      resultadoDiv: document.getElementById('resultado'),
      resNomeSpan: document.getElementById('resNome'),
      resumoItensDiv: document.getElementById('resumo-itens'),
      resumoTotaisDiv: document.getElementById('resumo-totais'),
      btnCalcular: document.getElementById('btnCalcular'),
      btnResetar: document.getElementById('btnResetar'),
      btnGerarImagem: document.getElementById('btnGerarImagem'),
      themeToggle: document.getElementById('theme-toggle'),
      langBr: document.getElementById('lang-br'),
      langEn: document.getElementById('lang-en'),
      modeQtyRadio: document.getElementById('mode-qty'),
      modeMushRadio: document.getElementById('mode-mush'),
      distributorSection: document.getElementById('distributor-section'),
      tokenFiltersContainer: document.getElementById('token-filters-container'),
      totalMushInput: document.getElementById('total-mush'),
      btnDistribute: document.getElementById('btnDistribute'),
      leftoverMushDiv: document.getElementById('leftover-mush'),
      // Novos seletores para abas
      tabNavigation: document.querySelector('.tab-navigation'),
      tabLinks: document.querySelectorAll('.tab-link'),
      tabContents: document.querySelectorAll('.tab-content'),
      historyTableContainer: document.getElementById('history-table-container'),
    };

    let currentLang = 'br';

    const app = {
      // ... (todas as fun√ß√µes existentes de init a reset) ...
      
      init() {
        this.addAuthListeners();
        this.loadPreferences(); 
        this.setLanguage(currentLang); 
      },
      addAuthListeners() {
        auth.onAuthStateChanged(user => {
            if (user) {
                dom.authContainer.classList.add('hidden');
                dom.appContainer.classList.remove('hidden');
                if (!this.calculatorInitialized) {
                    this.addAppEventListeners();
                    this.calculatorInitialized = true;
                }
            } else {
                dom.authContainer.classList.remove('hidden');
                dom.appContainer.classList.add('hidden');
            }
        });
        dom.btnLogin.addEventListener('click', this.handleLogin.bind(this));
        dom.btnLogout.addEventListener('click', this.handleLogout.bind(this));
      },
      async handleLogin() {
          const username = dom.usernameInput.value.trim();
          const password = dom.passwordInput.value;
          const t = TRANSLATIONS[currentLang];
          if (!username || !password) {
              dom.authError.textContent = t.errorInvalidCredentials;
              return;
          }
          const email = `${username}@painelriciv.com`;
          try {
              dom.authError.textContent = '';
              await auth.signInWithEmailAndPassword(email, password);
          } catch (error) {
              console.error("Erro de login:", error.code);
              if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                  dom.authError.textContent = t.errorInvalidCredentials;
              } else {
                  dom.authError.textContent = t.errorGeneric;
              }
          }
      },
      handleLogout() { auth.signOut(); },
      loadPreferences() {
          this.setTheme(localStorage.getItem('theme') || 'dark');
          currentLang = localStorage.getItem('language') || 'br';
      },
      addAppEventListeners() {
          dom.descontoInput.addEventListener('input', this.updateUI.bind(this));
          dom.btnCalcular.addEventListener('click', this.updateUI.bind(this));
          dom.btnResetar.addEventListener('click', this.reset.bind(this));
          dom.btnGerarImagem.addEventListener('click', this.generateImage.bind(this));
          dom.themeToggle.addEventListener('click', () => {
              const newTheme = dom.html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
              this.setTheme(newTheme);
          });
          dom.langBr.addEventListener('click', () => this.setLanguage('br'));
          dom.langEn.addEventListener('click', () => this.setLanguage('en'));
          dom.modeQtyRadio.addEventListener('change', () => this.toggleMode('quantity'));
          dom.modeMushRadio.addEventListener('change', () => this.toggleMode('mush'));
          dom.btnDistribute.addEventListener('click', this.distributeMush.bind(this));
          // Event listener para as abas
          dom.tabNavigation.addEventListener('click', this.handleTabClick.bind(this));
      },
      
      handleTabClick(event) {
          const clickedTab = event.target.closest('.tab-link');
          if (!clickedTab) return;

          const tabId = clickedTab.dataset.tab;

          dom.tabLinks.forEach(link => link.classList.remove('active'));
          dom.tabContents.forEach(content => content.classList.add('hidden'));

          clickedTab.classList.add('active');
          document.getElementById(tabId).classList.remove('hidden');

          if (tabId === 'history-view') {
              this.loadHistory();
          }
      },

      async loadHistory() {
          const t = TRANSLATIONS[currentLang];
          dom.historyTableContainer.innerHTML = `<p>${t.historyLoading || 'Carregando hist√≥rico...'}</p>`;

          try {
              const querySnapshot = await db.collection("receipts").orderBy("createdAt", "desc").get();
              if (querySnapshot.empty) {
                  dom.historyTableContainer.innerHTML = `<p>${t.historyNoRecords}</p>`;
                  return;
              }

              let tableHTML = `
                  <table>
                      <thead>
                          <tr>
                              <th>${t.historyCustomer}</th>
                              <th>${t.historySeller}</th>
                              <th>${t.historyTotal}</th>
                              <th>${t.historyDate}</th>
                          </tr>
                      </thead>
                      <tbody>
              `;

              querySnapshot.forEach(doc => {
                  const data = doc.data();
                  const date = data.createdAt?.toDate ? data.createdAt.toDate().toLocaleString(currentLang) : 'N/A';
                  tableHTML += `
                      <tr>
                          <td>${data.customerName || 'N/A'}</td>
                          <td>${data.seller || 'N/A'}</td>
                          <td>${data.grandTotal?.toFixed(2) || '0.00'}</td>
                          <td>${date}</td>
                      </tr>
                  `;
              });

              tableHTML += `</tbody></table>`;
              dom.historyTableContainer.innerHTML = tableHTML;

          } catch (error) {
              console.error("Erro ao buscar hist√≥rico: ", error);
              dom.historyTableContainer.innerHTML = `<p style="color: var(--text-error);">${t.errorGeneric}</p>`;
          }
      },
      // ... (O resto das fun√ß√µes, de toggleMode at√© generateImage, permanecem as mesmas da vers√£o anterior)
      // Vou omiti-las aqui para brevidade, mas elas estar√£o no c√≥digo completo abaixo
    };

    // Cole o resto das fun√ß√µes aqui (do `toggleMode` ao `generateImage`)
    // Ou simplesmente use o bloco de script completo abaixo
    
    // Inicia a aplica√ß√£o
    app.init();
  });
</script>
</body>
</html>
