<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
<meta charset="UTF-8">
<title>Calculadora de Tokens</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Poppins:wght@700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-functions-compat.js"></script>

<style>
  :root {
    --font-header: 'Poppins', sans-serif;
    --font-body: 'Inter', sans-serif;
    --bg-primary: #18181b;
    --bg-secondary: #27272a;
    --bg-tertiary: #3f3f46;
    --border-color: #3f3f46;
    --accent-primary: #34d399;
    --accent-hover: #10b981;
    --accent-danger: #f43f5e;
    --accent-warning: #f59e0b;
    --text-primary: #f8fafc;
    --text-secondary: #a1a1aa;
    --text-error: #fca5a5;
    --grid-color: rgba(255, 255, 255, 0.15);
  }

  html[data-theme='light'] {
    --bg-primary: #f4f4f5;
    --bg-secondary: #ffffff;
    --bg-tertiary: #e4e4e7;
    --border-color: #d4d4d8;
    --accent-primary: #10b981;
    --accent-hover: #0f9a6c;
    --accent-danger: #ef4444;
    --accent-warning: #d97706;
    --text-primary: #18181b;
    --text-secondary: #71717a;
    --text-error: #b91c1c;
    --grid-color: rgba(0, 0, 0, 0.1);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background-color: var(--bg-primary);
    color: var(--text-primary);
    font-family: var(--font-body);
    padding: 40px 20px;
    transition: background-color 0.3s ease, color 0.3s ease;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    min-height: 100vh;
  }

  .hidden { display: none !important; }

  #auth-container {
    width: 100%;
    max-width: 400px;
    background: var(--bg-secondary);
    padding: 32px;
    border-radius: 16px;
    border: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    gap: 24px;
    margin-top: 10vh;
  }
  
  #app-container {
    width: 100%;
    max-width: 800px;
  }

  .container {
    width: 100%;
    background: var(--bg-secondary);
    padding: 32px;
    border-radius: 16px;
    border: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    gap: 24px;
  }
  
  .settings-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
  }
  .settings-controls { display: flex; align-items: center; gap: 16px;}
  #logged-in-user { font-size: 14px; color: var(--text-secondary); }
  #logged-in-user .username { font-weight: 700; color: var(--text-primary); }
  .language-switcher button { background: none; border: none; padding: 4px; cursor: pointer; transition: all 0.3s ease; }
  .language-switcher button:not(.active) { filter: grayscale(100%); opacity: 0.6; }
  html[data-theme='dark'] .language-switcher button:not(.active) { filter: grayscale(100%) invert(100%); opacity: 0.8; }
  .language-switcher button.active, .language-switcher button:not(.active):hover { filter: none; opacity: 1; transform: scale(1.1); }
  
  .theme-switcher { display: flex; align-items: center; gap: 8px; }
  .theme-switcher-label { font-size: 12px; color: var(--text-secondary); font-weight: 500; }
  .toggle-track { width: 44px; height: 24px; background-color: var(--bg-tertiary); border-radius: 99px; position: relative; cursor: pointer; transition: background-color 0.3s ease; }
  .toggle-thumb { width: 18px; height: 18px; background-color: white; border-radius: 50%; position: absolute; top: 3px; left: 4px; transition: transform 0.3s ease; }
  html[data-theme='light'] .toggle-track { background-color: var(--accent-primary); }
  html[data-theme='light'] .toggle-thumb { transform: translateX(19px); }

  h2 { font-family: var(--font-header); color: var(--accent-primary); font-size: 28px; font-weight: 700; text-align: center; margin-bottom: 8px;}
  h3 { margin-bottom: 1rem; color: var(--text-secondary); border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; }
  .input-group { display: flex; flex-direction: column; gap: 8px; }
  .input-group label { font-size: 14px; font-weight: 500; color: var(--text-secondary); transition: color 0.3s ease, font-weight 0.3s ease; }

  .reseller-label {
    flex-direction: row;
    align-items: center;
    gap: 10px;
    cursor: pointer;
  }

  input[type="text"], input[type="number"], input[type="password"], input[type="date"], select {
    width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--bg-tertiary); color: var(--text-primary); font-size: 16px; transition: all 0.3s ease;
  }
  input[type="text"]:focus, input[type="number"]:focus, input[type="password"]:focus, input[type="date"]:focus, select:focus {
    outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px rgba(52, 211, 153, 0.3);
  }

  td input[type="number"] {
      padding: 8px;
      text-align: center;
      font-size: 15px;
  }

  #auth-error, #admin-action-status { color: var(--text-error); font-size: 14px; text-align: center; min-height: 20px; }
  #admin-action-status.success { color: var(--accent-primary); }

  .tab-navigation { display: flex; border-bottom: 1px solid var(--border-color); }
  .tab-link { padding: 12px 20px; cursor: pointer; background: none; border: none; color: var(--text-secondary); font-weight: 600; font-size: 16px; border-bottom: 3px solid transparent; transition: all 0.3s ease; font-family: var(--font-body); }
  .tab-link:hover { color: var(--text-primary); }
  .tab-link.active { color: var(--accent-primary); border-bottom-color: var(--accent-primary); }
  .tab-content { padding-top: 24px; display: flex; flex-direction: column; gap: 24px; }
  
  .mode-selector { display: flex; gap: 20px; background-color: var(--bg-tertiary); padding: 6px; border-radius: 10px; width: fit-content; }
  .mode-selector label { padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; }
  .mode-selector input[type="radio"] { display: none; }
  .mode-selector input[type="radio"]:checked + label { background-color: var(--bg-secondary); color: var(--accent-primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

  .distributor-container { background-color: rgba(120, 120, 120, 0.05); border: 1px dashed var(--border-color); padding: 24px; border-radius: 12px; display: flex; flex-direction: column; gap: 20px; }
  .token-filters { display: flex; flex-wrap: wrap; gap: 12px 20px; }
  .token-filters label { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px; }
  .distributor-controls { display: flex; gap: 16px; align-items: center; }
  .distributor-controls .input-group { flex-grow: 1; }
  #leftover-mush { margin-top: 16px; font-weight: 500; color: var(--text-secondary); }
  #leftover-mush span { color: var(--accent-primary); font-weight: 700; }
  
  table { width: 100%; border-collapse: collapse; }
  th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border-color); transition: background-color 0.3s ease; }
  td:nth-child(2), td:nth-child(3), td:nth-child(4), th:nth-child(2), th:nth-child(3), th:nth-child(4) { text-align: center; }
  th { font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
  tbody tr:hover { background-color: rgba(120, 120, 120, 0.05); }
  tfoot td { border-bottom: none; }
  tfoot b { color: var(--accent-primary); }
  
  .buttons { display: flex; justify-content: center; gap: 12px; margin-top: 16px; flex-wrap: wrap;}
  button { padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: transform 0.15s ease, background-color 0.2s, color 0.2s, box-shadow 0.2s; border: none; display: inline-flex; align-items: center; justify-content: center; }
  button:hover { transform: translateY(-2px) scale(1.02); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); }
  button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none;}
  #btnCalcular, #btnDistribute, #btnLogin, #history-apply-filter-btn, #btn-create-seller, .btn-promote-admin, #generate-txt-file-btn { background: var(--accent-primary); color: #fff; }
  #btnCalcular:hover, #btnDistribute:hover, #btnLogin:hover, #history-apply-filter-btn:hover, #btn-create-seller:hover, #btn-load-users:hover, .btn-promote-admin:hover, #generate-txt-file-btn:hover { background: var(--accent-hover); }
  #btnResetar, .delete-history-btn, .btn-delete-user { background: var(--accent-danger); color: var(--text-primary); }
  .btn-demote-admin { background: var(--accent-warning); color: var(--text-primary); }
  #btnGerarImagem, #btnLogout, #btnDistributeLeftover, #btn-prev-page, #btn-next-page, #export-txt-modal-btn, #cancel-txt-export-btn, .btn-view-receipt { background: var(--bg-tertiary); color: var(--text-primary); }

  .admin-section {
    padding: 20px;
    margin-bottom: 24px;
    border: 1px solid var(--border-color);
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  /* --- IN√çCIO DAS MELHORIAS DE DESIGN --- */
  .container {
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2), 0 8px 10px -6px rgba(0, 0, 0, 0.2);
  }
  #btnCalcular, #btnDistribute, #btnLogin, #history-apply-filter-btn, #btn-create-seller, .btn-promote-admin, #generate-txt-file-btn {
    background-image: linear-gradient(to right, var(--accent-primary) 0%, var(--accent-hover) 100%);
    background-size: 200% auto;
    transition: all 0.4s ease-in-out;
    border: none;
  }
  #btnCalcular:hover, #btnDistribute:hover, #btnLogin:hover, #history-apply-filter-btn:hover, #btn-create-seller:hover, .btn-promote-admin:hover, #generate-txt-file-btn:hover {
    background-position: right center;
    background-color: var(--accent-hover);
  }
  .input-group:focus-within label {
    color: var(--accent-primary);
    font-weight: 600;
  }
  button:active {
    transform: translateY(1px) scale(0.98);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  #auth-container, .container {
    animation: fadeIn 0.5s ease-out forwards;
  }
  tbody tr:nth-child(odd) {
    background-color: rgba(120, 120, 120, 0.03);
  }
  tbody tr:hover {
    background-color: rgba(52, 211, 153, 0.1);
  }
  .icon {
    width: 1.1em;
    height: 1.1em;
    margin-right: 0.5em;
    vertical-align: -0.2em;
  }
  label .icon {
    vertical-align: -0.25em;
  }
  th {
    letter-spacing: 0.8px;
    font-weight: 700;
  }
  .input-group {
    margin-bottom: 8px;
  }
  .tab-navigation {
    margin-bottom: 16px;
  }
  .tab-link {
    position: relative;
    top: 1px;
    margin-bottom: -1px;
  }
  #reseller-limit-status {
    text-align: center;
    border: 1px solid var(--border-color);
    font-size: 14px;
  }

  /* --- ESTILOS PARA O MODAL DE EXPORTA√á√ÉO --- */
  .modal {
    position: fixed;
    z-index: 1001;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.3s ease;
  }
  .modal-content {
    background-color: var(--bg-secondary);
    padding: 24px;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    border: 1px solid var(--border-color);
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
  }
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 16px;
    margin-bottom: 16px;
  }
  .modal-header h3 {
    border-bottom: none;
    padding-bottom: 0;
    margin-bottom: 0;
    color: var(--text-primary);
  }
  .close-btn {
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    line-height: 1;
  }
  .close-btn:hover {
    color: var(--text-primary);
  }
  #customer-list-for-export {
    overflow-y: auto;
    flex-grow: 1;
    margin-bottom: 16px;
    padding-right: 8px;
  }
  #customer-list-for-export label {
    display: flex;
    align-items: center;
    padding: 10px;
    cursor: pointer;
    border-radius: 6px;
    transition: background-color 0.2s ease;
  }
  #customer-list-for-export label:hover {
    background-color: var(--bg-tertiary);
  }
  #customer-list-for-export input[type="checkbox"] {
    margin-right: 12px;
    width: 18px;
    height: 18px;
  }
  #customer-list-for-export .customer-info {
    display: flex;
    justify-content: space-between;
    width: 100%;
  }
  #customer-list-for-export .customer-total {
    color: var(--accent-primary);
    font-weight: bold;
  }
  .modal-controls {
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border-color);
    margin-bottom: 10px;
  }
  .modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    padding-top: 16px;
    margin-top: auto;
    border-top: 1px solid var(--border-color);
  }
</style>
</head>
<body>

<svg width="0" height="0" style="position:absolute">
  <symbol id="icon-user" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></symbol>
  <symbol id="icon-discount" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-7-7A.997.997 0 012 10V5a1 1 0 011-1h5a1 1 0 01.707.293l7 7zM5 6a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></symbol>
  <symbol id="icon-reset" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></symbol>
  <symbol id="icon-image" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" /></symbol>
  <symbol id="icon-login" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 011-1v12a1 1 0 11-2 0V4a1 1 0 011-1zm7.707 3.293a1 1 0 010 1.414L9.414 9H17a1 1 0 110 2H9.414l1.293 1.293a1 1 0 01-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0z" clip-rule="evenodd" /></symbol>
  <symbol id="icon-calculator" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V4a2 2 0 00-2-2H6zm1 2a1 1 0 100 2h6a1 1 0 100-2H7zM6 7a1 1 0 011-1h2a1 1 0 110 2H7a1 1 0 01-1-1zm4 0a1 1 0 011-1h2a1 1 0 110 2h-2a1 1 0 01-1-1zM6 11a1 1 0 011-1h2a1 1 0 110 2H7a1 1 0 01-1-1zm4 0a1 1 0 011-1h2a1 1 0 110 2h-2a1 1 0 01-1-1z" clip-rule="evenodd" /></symbol>
  <symbol id="icon-export" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></symbol>
  <symbol id="icon-receipt" viewBox="0 0 20 20" fill="currentColor"><path d="M4 2a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V4a2 2 0 00-2-2H4zm0 2h12v3H4V4zm0 5h12v2H4V9zm0 4h12v2H4v-2z" /></symbol>
</svg>

<div id="auth-container">
    <h2 data-translate-key="loginHeader">Login</h2>
    <div class="input-group">
        <label for="username-input" data-translate-key="usernameLabel">Usu√°rio</label>
        <input type="text" id="username-input" autocomplete="username">
    </div>
    <div class="input-group">
        <label for="password-input" data-translate-key="passwordLabel">Senha</label>
        <input type="password" id="password-input" autocomplete="current-password">
    </div>
    <p id="auth-error"></p>
    <button id="btnLogin" data-translate-key="loginButton"><svg class="icon"><use xlink:href="#icon-login"></use></svg>Entrar</button>
</div>

<div id="app-container" class="hidden">
    <div class="container">
      <div class="settings-bar">
          <div class="language-switcher">
              <button id="lang-br">üáßüá∑</button>
              <button id="lang-en">üá∫üá∏</button>
          </div>
          <div class="settings-controls">
              <div class="theme-switcher">
                  <span class="theme-switcher-label" data-translate-key="themeLabel"></span>
                  <div class="toggle-track" id="theme-toggle">
                      <div class="toggle-thumb"></div>
                  </div>
              </div>
              <div id="logged-in-user"></div>
              <button id="btnLogout" data-translate-key="logoutButton">Sair</button>
          </div>
      </div>

      <div class="tab-navigation">
          <button class="tab-link" data-tab="calculator-view" data-translate-key="tabCalculator">Calculadora</button>
          <button class="tab-link" data-tab="history-view" data-translate-key="tabHistory">Hist√≥rico</button>
          <button class="tab-link" data-tab="dashboard-view">Dashboard</button>
          <button class="tab-link" data-tab="admin-view" style="display: none;">Admin</button>
      </div>

      <div id="calculator-view" class="tab-content">
          <h2 data-translate-key="mainHeader">Calculadora de Tokens</h2>
          
          <div class="input-group" id="customer-name-container">
            <label for="nomeCliente" data-translate-key="idLabel"><svg class="icon"><use xlink:href="#icon-user"></use></svg>Identificador / Nome do Cliente</label>
            <input type="text" id="nomeCliente" data-translate-key-placeholder="idPlaceholder">
          </div>

          <div class="input-group hidden" id="reseller-customer-selection-container">
              <label for="reseller-customer-select" data-translate-key="resellerCustomerLabel"><svg class="icon"><use xlink:href="#icon-user"></use></svg>Cliente Revendedor</label>
              <select id="reseller-customer-select"></select>
              <input type="text" id="reseller-customer-manual-input" class="hidden" data-translate-key-placeholder="resellerCustomerManualPlaceholder">
          </div>

          <div class="input-group">
            <label for="desconto" data-translate-key="discountLabel"><svg class="icon"><use xlink:href="#icon-discount"></use></svg>Desconto (%)</label>
            <input type="number" id="desconto" data-translate-key-placeholder="discountPlaceholder" min="0" max="100">
          </div>
          <div class="input-group">
              <label data-translate-key="calculationMode">Modo de C√°lculo</label>
              <div class="mode-selector">
                  <input type="radio" id="mode-qty" name="calculation-mode" value="quantity" checked>
                  <label for="mode-qty" data-translate-key="modeQty">Por Quantidade</label>
                  <input type="radio" id="mode-mush" name="calculation-mode" value="mush">
                  <label for="mode-mush" data-translate-key="modeMush">Por Mush</label>
              </div>
          </div>
          <div class="input-group hidden" id="reseller-mode-container">
              <label class="reseller-label">
                  <input type="checkbox" id="reseller-mode-toggle">
                  Modo Revendedor
              </label>
          </div>
          <div id="reseller-limit-status" class="hidden"></div>
          <div class="distributor-container" id="distributor-section" style="display: none;">
              <div>
                  <label data-translate-key="distributeTokensLabel">Tokens Desej√°veis para Distribui√ß√£o</label>
                  <div class="token-filters" id="token-filters-container"></div>
              </div>
              <div id="two-token-options" class="hidden" style="margin-top: 10px;">
                  <label>Estrat√©gia para 2 tokens:</label>
                  <div class="mode-selector">
                      <input type="radio" id="strategy-fair" name="two-token-strategy" value="fair" checked>
                      <label for="strategy-fair">Justa (Padr√£o)</label>
                      <input type="radio" id="strategy-split" name="two-token-strategy" value="split">
                      <label for="strategy-split">Dividir 50/50</label>
                  </div>
              </div>
              <div class="distributor-controls">
                  <div class="input-group">
                      <label for="total-mush" data-translate-key="totalMushLabel">Total de Mush a Gastar</label>
                      <input type="number" id="total-mush" placeholder="30000">
                  </div>
                  <button id="btnDistribute" data-translate-key="btnDistribute">Distribuir</button>
              </div>
              <div id="leftover-mush"></div>
              <div id="leftover-distributor-section" class="hidden" style="margin-top: 15px; border-top: 1px dashed var(--border-color); padding-top: 15px;">
                  <label>Distribuir o troco para:</label>
                  <div class="token-filters" id="leftover-token-filters-container"></div>
                  <div class="buttons" style="margin-top: 10px;">
                       <button id="btnDistributeLeftover">Distribuir Troco</button>
                  </div>
              </div>
          </div>
          <table>
            <thead>
              <tr>
                <th data-translate-key="tableItem">Item</th>
                <th data-translate-key="tablePrice">Pre√ßo Unit√°rio</th>
                <th data-translate-key="tableQty">Quantidade</th>
                <th data-translate-key="tableTotal">Valor Total</th>
              </tr>
            </thead>
            <tbody id="tabela-itens"></tbody>
            <tfoot>
              <tr>
                <td colspan="3"><b data-translate-key="tableGrandTotal">TOTAL GERAL</b></td>
                <td id="totalGeral" style="text-align: center;"><b>0.00</b></td>
              </tr>
            </tfoot>
          </table>
          <div class="buttons">
            <button id="btnCalcular" data-translate-key="btnCalculate"><svg class="icon"><use xlink:href="#icon-calculator"></use></svg>Calcular</button>
            <button id="btnResetar" data-translate-key="btnReset"><svg class="icon"><use xlink:href="#icon-reset"></use></svg>Resetar</button>
            <button id="btnGerarImagem" data-translate-key="btnExport"><svg class="icon"><use xlink:href="#icon-image"></use></svg>Exportar para PNG</button>
          </div>
      </div>
      
      <div id="history-view" class="tab-content hidden">
          <h2 data-translate-key="historyHeader">Hist√≥rico de Vendas</h2>
          <div class="input-group" style="align-items: center; margin-bottom: 20px;">
              <label>Visualizar:</label>
              <div class="mode-selector">
                  <input type="radio" id="history-view-all" name="history-view-mode" value="all" checked>
                  <label for="history-view-all">Todas as Vendas</label>
                  <input type="radio" id="history-view-summary" name="history-view-mode" value="summary">
                  <label for="history-view-summary">Resumo por Cliente</label>
              </div>
          </div>
          <div id="history-filter-bar" style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap; margin-bottom: 20px; padding: 15px; border: 1px solid var(--border-color); border-radius: 12px;">
              <div class="input-group" style="flex-grow: 1;">
                  <label for="history-search-input">Buscar por Nome</label>
                  <input type="text" id="history-search-input" placeholder="Digite o nome do cliente...">
              </div>
              <div class="input-group">
                  <label for="history-date-start">Data In√≠cio</label>
                  <input type="date" id="history-date-start">
              </div>
              <div class="input-group">
                  <label for="history-date-end">Data Fim</label>
                  <input type="date" id="history-date-end">
              </div>
              <div class="buttons" style="margin-top:0;">
                <button id="history-apply-filter-btn">Aplicar Filtros</button>
                <button id="export-txt-modal-btn"><svg class="icon"><use xlink:href="#icon-export"></use></svg>Exportar TXT</button>
              </div>
          </div>
          <div id="history-table-container"></div>
          <div id="history-pagination-controls" class="buttons hidden">
              <button id="btn-prev-page">Anterior</button>
              <span id="page-number-display" style="align-self: center; font-weight: 500;"></span>
              <button id="btn-next-page">Pr√≥xima</button>
          </div>
      </div>

      <div id="dashboard-view" class="tab-content hidden">
          <h2>Dashboard de Vendas</h2>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px;">
              <div class="chart-container" style="padding: 20px; background-color: var(--bg-primary); border-radius: 12px;">
                  <h3 style="text-align: center; margin-bottom: 15px;">Vendas por Dia</h3>
                  <canvas id="sales-over-time-chart"></canvas>
              </div>
              <div class="chart-container" style="padding: 20px; background-color: var(--bg-primary); border-radius: 12px;">
                  <h3 style="text-align: center; margin-bottom: 15px;">Tokens Mais Vendidos</h3>
                  <canvas id="tokens-sold-chart"></canvas>
              </div>
          </div>
      </div>
      
      <div id="admin-view" class="tab-content hidden">
        <h2>Gerenciamento</h2>
        <div id="admin-action-status"></div>

        <div class="admin-section">
            <h3>Adicionar Novo Vendedor</h3>
            <div class="input-group">
                <label for="new-seller-username">Usu√°rio do Vendedor</label>
                <input type="text" id="new-seller-username" placeholder="Ex: novo.vendedor">
            </div>
            <div class="input-group">
                <label for="new-seller-password">Senha Provis√≥ria</label>
                <input type="password" id="new-seller-password" placeholder="M√≠nimo 6 caracteres">
            </div>
            <div class="buttons" style="justify-content: flex-start;">
                <button id="btn-create-seller">Criar Vendedor</button>
            </div>
        </div>

        <div class="admin-section">
            <h3>Lista de Usu√°rios</h3>
            <div class="buttons" style="justify-content: flex-start;">
                <button id="btn-load-users">Carregar Lista de Usu√°rios</button>
            </div>
            <div id="user-list-container" style="margin-top: 16px;">
            </div>
        </div>
      </div>

    </div>
</div>

<div id="resultado" style="display: none; padding: 20px; background: var(--bg-secondary); color: var(--text-primary); width: 400px; border-radius: 15px; border: 1px solid var(--border-color); position: fixed; top: -100%; left: 50%; transform: translateX(-50%); z-index: -1;">
</div>

<div id="txt-export-modal" class="modal hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Exportar Relat√≥rio de Clientes</h3>
      <button class="close-btn" id="close-txt-export-modal">&times;</button>
    </div>
    <div class="modal-controls">
      <label>
        <input type="checkbox" id="select-all-customers-checkbox">
        Selecionar Todos
      </label>
    </div>
    <div id="customer-list-for-export">
    </div>
    <div class="modal-footer">
      <button id="cancel-txt-export-btn">Cancelar</button>
      <button id="generate-txt-file-btn">Gerar .TXT</button>
    </div>
  </div>
</div>

<script>
  // --- INICIALIZA√á√ÉO DO FIREBASE ---
  const firebaseConfig = {
    apiKey: "AIzaSyDgeTU4YmFpZIwcmE2-cxGKTkO2KqeQotE",
    authDomain: "token-calculator-a45d6.firebaseapp.com",
    projectId: "token-calculator-a45d6",
    storageBucket: "token-calculator-a45d6.firebasestorage.app",
    messagingSenderId: "597974335563",
    appId: "1:597974335563:web:9d07ada2708d61b7d30dce"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();
  const functions = firebase.app().functions('us-central1');

  // --- L√ìGICA DA APLICA√á√ÉO ---
    const MOEDA_BASE64 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAACUSURBVDhPY/j//z8DJYCJgUJWCiDPmPrP4P/fv//f//79//Pnx/+/f/8DNlDrAKSkG4B84BTg//+fA5AAYs4A5gA1zwBC/v/79w8gCajhF0D+jAar4f9/fv8DksAqsX4A8gNTAf8ZGP5/YOD5/wz8//P/D/gMWQBL/x/g/x8Y/v9g+P+DAAATz2sNmmNYXAAAAABJRU5ErkJggg==";
    const DUMMY_DOMAIN = '@painelriciv.com'; 
    const RESELLER_DAILY_LIMIT = 750;

    const ITENS_CATALOGO = {
      revive: { preco: 790, name_br: 'Revive Token', name_en: 'Revive Token' },
      max: { preco: 570, name_br: 'Max Growth Token', name_en: 'Max Growth Token' },
      partial: { preco: 195, name_br: 'Partial Growth Token', name_en: 'Partial Growth Token' },
      change: { preco: 90, name_br: 'Appearance Change Token', name_en: 'Appearance Change Token' }
    };
    
    const PRECOS_MINIMOS = {
      revive: 780,
      max: 540,
      partial: 180,
      change: 70
    };

    const PRECOS_RESELLER = {
      revive: 770,
      max: 530,
      partial: 175,
      change: 65
    };

    const TRANSLATIONS = {
      br: {
          pageTitle: "Painel", mainHeader: "Calculadora de Tokens", themeLabel: "Tema Claro",
          idLabel: "Identificador / Nome do Cliente", idPlaceholder: "Digite o nome ou ID do cliente", discountLabel: "Desconto (%)",
          discountPlaceholder: "Ex: 10", tableItem: "Item", tablePrice: "Pre√ßo Unit√°rio", tableQty: "Quantidade",
          tableTotal: "Valor Total", tableGrandTotal: "TOTAL GERAL", btnCalculate: "Calcular", btnReset: "Resetar",
          btnExport: "Exportar para PNG", alertNoItems: "Nenhum item foi selecionado para gerar o recibo.",
          receiptHeader: "Recibo", receiptItemsHeader: "Itens Comprados", receiptSubtotal: "Subtotal",
          receiptDiscount: "Desconto", receiptFinalTotal: "Total Final", receiptThanks: "‚ú® Agradecemos a prefer√™ncia! ‚ú®",
          calculationMode: "Modo de C√°lculo", modeQty: "Por Quantidade", modeMush: "Por Mush",
          distributeTokensLabel: "Tokens Desej√°veis para Distribui√ß√£o", totalMushLabel: "Total de Mush a Gastar",
          btnDistribute: "Distribuir", leftoverMushText: "Sobrou:",
          loginHeader: "Acessar Calculadora", usernameLabel: "Usu√°rio", passwordLabel: "Senha",
          loginButton: "Entrar", logoutButton: "Sair", errorInvalidCredentials: "Usu√°rio ou senha inv√°lidos.",
          errorGeneric: "Ocorreu um erro. Tente novamente.",
          tabCalculator: "Calculadora", tabHistory: "Hist√≥rico", historyHeader: "Hist√≥rico de Vendas",
          historyCustomer: "Cliente", historyDate: "Data", historyTotal: "Total", historySeller: "Vendedor",
          historyNoRecords: "Nenhum registro encontrado.", historyLoading: "Carregando hist√≥rico...",
          loggedInAs: "Usu√°rio:",
          resellerCustomerLabel: "Cliente Revendedor", resellerCustomerManualPlaceholder: "Digite o nome do cliente revendedor",
          resellerLimitStatus: (revive, max, total, time) => `Limite Cliente: <b>Revive</b> (${revive}/${total}) | <b>Max</b> (${max}/${total}). Reseta em <b>${time}</b>.`,
          resellerLimitExceededWarning: "Aten√ß√£o: O limite di√°rio do cliente para um ou mais itens foi excedido. Itens acima do limite ser√£o cobrados com o pre√ßo base."
      },
      en: {
          pageTitle: "Painel", mainHeader: "Token Calculator", themeLabel: "Light Theme",
          idLabel: "Customer Identifier / Name", idPlaceholder: "Enter customer's name or ID", discountLabel: "Discount (%)",
          discountPlaceholder: "Ex: 10", tableItem: "Item", tablePrice: "Unit Price", tableQty: "Quantity",
          tableTotal: "Total Value", tableGrandTotal: "GRAND TOTAL", btnCalculate: "Calculate", btnReset: "Reset",
          btnExport: "Export to PNG", alertNoItems: "No items were selected to generate the receipt.",
          receiptHeader: "Receipt", receiptItemsHeader: "Purchased Items", receiptSubtotal: "Subtotal",
          receiptDiscount: "Discount", receiptFinalTotal: "Final Total", receiptThanks: "‚ú® Thank you for your preference! ‚ú®",
          calculationMode: "Calculation Mode", modeQty: "By Quantity", modeMush: "By Mush",
          distributeTokensLabel: "Desirable Tokens for Distribution", totalMushLabel: "Total Mush to Spend",
          btnDistribute: "Distribute", leftoverMushText: "Leftover:",
          loginHeader: "Calculator Login", usernameLabel: "Username", passwordLabel: "Password",
          loginButton: "Login", logoutButton: "Logout", errorInvalidCredentials: "Invalid username or password.",
          errorGeneric: "An error occurred. Please try again.",
          tabCalculator: "Calculator", tabHistory: "History", historyHeader: "Sales History",
          historyCustomer: "Customer", historyDate: "Date", historyTotal: "Total", historySeller: "Seller",
          historyNoRecords: "No records found.", historyLoading: "Loading history...",
          loggedInAs: "User:",
          resellerCustomerLabel: "Reseller Customer", resellerCustomerManualPlaceholder: "Enter reseller customer's name",
          resellerLimitStatus: (revive, max, total, time) => `Customer Limit: <b>Revive</b> (${revive}/${total}) | <b>Max</b> (${max}/${total}). Resets in <b>${time}</b>.`,
          resellerLimitExceededWarning: "Warning: The customer's daily limit for one or more items has been exceeded. Items above the limit will be charged at the base price."
      }
    };
    
    const dom = {
      authContainer: document.getElementById('auth-container'),
      appContainer: document.getElementById('app-container'),
      usernameInput: document.getElementById('username-input'),
      passwordInput: document.getElementById('password-input'),
      btnLogin: document.getElementById('btnLogin'),
      btnLogout: document.getElementById('btnLogout'),
      authError: document.getElementById('auth-error'),
      html: document.documentElement,
      nomeClienteInput: document.getElementById('nomeCliente'),
      descontoInput: document.getElementById('desconto'),
      tabelaItensBody: document.getElementById('tabela-itens'),
      totalGeralCell: document.getElementById('totalGeral'),
      themeToggle: document.getElementById('theme-toggle'),
      langBr: document.getElementById('lang-br'),
      langEn: document.getElementById('lang-en'),
      modeQtyRadio: document.getElementById('mode-qty'),
      modeMushRadio: document.getElementById('mode-mush'),
      distributorSection: document.getElementById('distributor-section'),
      tokenFiltersContainer: document.getElementById('token-filters-container'),
      leftoverTokenFiltersContainer: document.getElementById('leftover-token-filters-container'),
      totalMushInput: document.getElementById('total-mush'),
      btnDistribute: document.getElementById('btnDistribute'),
      btnDistributeLeftover: document.getElementById('btnDistributeLeftover'),
      leftoverMushDiv: document.getElementById('leftover-mush'),
      leftoverDistributorSection: document.getElementById('leftover-distributor-section'),
      tabNavigation: document.querySelector('.tab-navigation'),
      tabLinks: document.querySelectorAll('.tab-link'),
      tabContents: document.querySelectorAll('.tab-content'),
      historyTableContainer: document.getElementById('history-table-container'),
      loggedInUserDiv: document.getElementById('logged-in-user'),
      historySearchInput: document.getElementById('history-search-input'),
      historyDateStart: document.getElementById('history-date-start'),
      historyDateEnd: document.getElementById('history-date-end'),
      historyApplyFilterBtn: document.getElementById('history-apply-filter-btn'),
      historyPaginationControls: document.getElementById('history-pagination-controls'),
      btnPrevPage: document.getElementById('btn-prev-page'),
      btnNextPage: document.getElementById('btn-next-page'),
      pageNumberDisplay: document.getElementById('page-number-display'),
      salesOverTimeChart: document.getElementById('sales-over-time-chart'),
      tokensSoldChart: document.getElementById('tokens-sold-chart'),
      adminView: document.getElementById('admin-view'),
      adminActionStatus: document.getElementById('admin-action-status'),
      btnLoadUsers: document.getElementById('btn-load-users'),
      userListContainer: document.getElementById('user-list-container'),
      btnCreateSeller: document.getElementById('btn-create-seller'),
      newSellerUsernameInput: document.getElementById('new-seller-username'),
      newSellerPasswordInput: document.getElementById('new-seller-password'),
      resellerModeContainer: document.getElementById('reseller-mode-container'),
      resellerModeToggle: document.getElementById('reseller-mode-toggle'),
      resellerLimitStatus: document.getElementById('reseller-limit-status'),
      customerNameContainer: document.getElementById('customer-name-container'),
      resellerCustomerSelectionContainer: document.getElementById('reseller-customer-selection-container'),
      resellerCustomerSelect: document.getElementById('reseller-customer-select'),
      resellerCustomerManualInput: document.getElementById('reseller-customer-manual-input'),
      txtExportModal: document.getElementById('txt-export-modal'),
      exportTxtModalBtn: document.getElementById('export-txt-modal-btn'),
      closeTxtExportModalBtn: document.getElementById('close-txt-export-modal'),
      cancelTxtExportBtn: document.getElementById('cancel-txt-export-btn'),
      generateTxtFileBtn: document.getElementById('generate-txt-file-btn'),
      customerListForExport: document.getElementById('customer-list-for-export'),
      selectAllCustomersCheckbox: document.getElementById('select-all-customers-checkbox'),
    };

    let currentLang = 'br';

    const app = {
      calculatorInitialized: false,
      currentLeftover: 0,
      historyPageSize: 15,
      historyPageCursors: [null],
      historyCurrentPage: 0,
      historyHasNextPage: true,
      salesChartInstance: null,
      tokensChartInstance: null,
      isCurrentUserAdmin: false,
      currentUsername: null,
      saveTimeout: null,
      currentCustomerUsage: { revive: 0, max: 0 },
      resellerLimitInterval: null, 

      init() {
        this.loadDevicePreferences();
        this.setLanguage(currentLang, true);
        this.addAuthListeners();
      },
      
      addAuthListeners() {
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                await user.getIdTokenResult(true).then(async (idTokenResult) => {
                    this.isCurrentUserAdmin = !!idTokenResult.claims.admin;
                    this.currentUsername = user.email.split('@')[0];
                    
                    document.querySelector('[data-tab="admin-view"]').style.display = this.isCurrentUserAdmin ? 'inline-block' : 'none';
                    if (this.isCurrentUserAdmin) {
                        dom.resellerModeContainer.classList.remove('hidden');
                    } else {
                        dom.resellerModeContainer.classList.add('hidden');
                    }

                    dom.authContainer.classList.add('hidden');
                    dom.appContainer.classList.remove('hidden');
                    
                    if (!this.calculatorInitialized) {
                        this.addAppEventListeners();
                        this.setLanguage(currentLang); 
                        await this.loadUserPreferences(user);
                        this.setDefaultTab(); 
                        const initialMode = dom.modeQtyRadio.checked ? 'quantity' : 'mush';
                        this.toggleMode(initialMode);
                        this.calculatorInitialized = true;
                    }
                    dom.loggedInUserDiv.innerHTML = `<span>${TRANSLATIONS[currentLang].loggedInAs}</span> <span class="username">${this.currentUsername}</span>`;
                });
            } else {
                this.isCurrentUserAdmin = false;
                this.currentUsername = null;
                dom.authContainer.classList.remove('hidden');
                dom.appContainer.classList.add('hidden');
                dom.resellerModeContainer.classList.add('hidden');
                this.calculatorInitialized = false; 
            }
        });
        dom.btnLogin.addEventListener('click', this.handleLogin.bind(this));
        dom.btnLogout.addEventListener('click', this.handleLogout.bind(this));
      },

      addAppEventListeners() {
          dom.descontoInput.addEventListener('input', this.updateUI.bind(this));
          document.getElementById('btnCalcular').addEventListener('click', this.updateUI.bind(this));
          document.getElementById('btnResetar').addEventListener('click', this.reset.bind(this));
          document.getElementById('btnGerarImagem').addEventListener('click', this.generateImage.bind(this));
          dom.themeToggle.addEventListener('click', () => {
              const newTheme = dom.html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
              this.setTheme(newTheme);
              if(document.getElementById('dashboard-view').classList.contains('active')) {
                  this.loadDashboardData();
              }
          });
          dom.langBr.addEventListener('click', () => this.setLanguage('br'));
          dom.langEn.addEventListener('click', () => this.setLanguage('en'));
          dom.modeQtyRadio.addEventListener('change', () => this.toggleMode('quantity'));
          dom.modeMushRadio.addEventListener('change', () => this.toggleMode('mush'));
          dom.resellerModeToggle.addEventListener('change', this.toggleResellerMode.bind(this));
          
          dom.nomeClienteInput.addEventListener('keyup', () => {});

          dom.resellerCustomerSelect.addEventListener('change', () => {
              if (dom.resellerCustomerSelect.value === 'manual') {
                  dom.resellerCustomerManualInput.classList.remove('hidden');
                  dom.resellerCustomerManualInput.focus();
              } else {
                  dom.resellerCustomerManualInput.classList.add('hidden');
              }
              this.checkResellerLimit();
          });

          dom.resellerCustomerManualInput.addEventListener('keyup', this.checkResellerLimit.bind(this));
          
          dom.btnDistribute.addEventListener('click', this.distributeMush.bind(this));
          dom.btnDistributeLeftover.addEventListener('click', this.distributeLeftoverMush.bind(this));
          dom.tabNavigation.addEventListener('click', this.handleTabClick.bind(this));
          dom.tokenFiltersContainer.addEventListener('change', () => {
              const selectedCount = dom.tokenFiltersContainer.querySelectorAll('input:checked').length;
              document.getElementById('two-token-options').classList.toggle('hidden', selectedCount !== 2);
          });
          document.querySelectorAll('input[name="history-view-mode"]').forEach(radio => {
              radio.addEventListener('change', () => this.loadHistory('first'));
          });
          dom.historyApplyFilterBtn.addEventListener('click', () => this.loadHistory('first'));
          dom.btnPrevPage.addEventListener('click', () => this.loadHistory('prev'));
          dom.btnNextPage.addEventListener('click', () => this.loadHistory('next'));
          dom.historyTableContainer.addEventListener('click', (event) => {
              const target = event.target.closest('button');
              if (!target) return;

              if (target.classList.contains('delete-history-btn')) {
                  this.handleHistoryDelete(target.dataset.id);
              }
              if (target.classList.contains('btn-view-receipt')) {
                  this.regenerateReceipt(target.dataset.id);
              }
          });
          
          dom.btnLoadUsers.addEventListener('click', this.loadUsers.bind(this));
          dom.userListContainer.addEventListener('click', this.handleUserAction.bind(this));
          dom.btnCreateSeller.addEventListener('click', this.handleCreateSeller.bind(this));

          dom.exportTxtModalBtn.addEventListener('click', this.openTxtExportModal.bind(this));
          dom.closeTxtExportModalBtn.addEventListener('click', () => dom.txtExportModal.classList.add('hidden'));
          dom.cancelTxtExportBtn.addEventListener('click', () => dom.txtExportModal.classList.add('hidden'));
          dom.selectAllCustomersCheckbox.addEventListener('change', this.handleSelectAllCustomers.bind(this));
          dom.generateTxtFileBtn.addEventListener('click', this.generateTxtFile.bind(this));
          dom.txtExportModal.addEventListener('click', (e) => {
            if (e.target === dom.txtExportModal) {
              dom.txtExportModal.classList.add('hidden');
            }
          });
      },
      
      async handleLogin() {
        const username = dom.usernameInput.value.trim();
        const password = dom.passwordInput.value;
        const t = TRANSLATIONS[currentLang];
        if (!username || !password) {
            dom.authError.textContent = t.errorInvalidCredentials;
            return;
        }
        const email = username + DUMMY_DOMAIN;
        try {
            dom.authError.textContent = '';
            await auth.signInWithEmailAndPassword(email, password);
        } catch (error) {
            if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-email') {
                dom.authError.textContent = t.errorInvalidCredentials;
            } else {
                dom.authError.textContent = t.errorGeneric;
            }
        }
      },
      
      handleLogout() {
        auth.signOut();
      },

      loadDevicePreferences() {
          const theme = localStorage.getItem('theme') || 'dark';
          this.setTheme(theme, false);
          currentLang = localStorage.getItem('language') || 'br';
      },
      
      async loadUserPreferences(user) {
        if (!user) return;
        try {
            const docRef = db.collection('userPreferences').doc(user.uid);
            const docSnap = await docRef.get();
            if (docSnap.exists) {
                const prefs = docSnap.data();
                if (prefs.theme) {
                    this.setTheme(prefs.theme, false);
                }
                if (prefs.language) {
                    this.setLanguage(prefs.language, false, true);
                }
                if (prefs.prices) {
                    for (const key in prefs.prices) {
                        const priceInput = document.getElementById(`price-${key}`);
                        if (priceInput && prefs.prices[key]) {
                            priceInput.value = prefs.prices[key];
                        }
                    }
                    this.updateUI();
                }
            }
        } catch (error) {
            console.error("Erro ao carregar prefer√™ncias do usu√°rio:", error);
        }
      },

      triggerSavePreferences() {
          clearTimeout(this.saveTimeout);
          this.saveTimeout = setTimeout(() => this.savePreferences(), 2000);
      },

      async savePreferences() {
          if (!auth.currentUser || dom.resellerModeToggle.checked) return;

          const pricesToSave = {};
          for (const key in ITENS_CATALOGO) {
              const priceInput = document.getElementById(`price-${key}`);
              if (priceInput) {
                  pricesToSave[key] = parseFloat(priceInput.value);
              }
          }

          const prefs = {
              theme: dom.html.getAttribute('data-theme'),
              language: currentLang,
              prices: pricesToSave
          };
          
          try {
              await db.collection('userPreferences').doc(auth.currentUser.uid).set(prefs, { merge: true });
          } catch (error) {
              console.error("Erro ao salvar prefer√™ncias:", error);
          }
      },
      
      setDefaultTab() {
        dom.tabLinks.forEach(link => link.classList.remove('active'));
        dom.tabContents.forEach(content => content.classList.add('hidden'));
        
        const firstTab = document.querySelector('.tab-link');
        const firstContentId = firstTab.dataset.tab;
        
        firstTab.classList.add('active');
        document.getElementById(firstContentId).classList.remove('hidden');
      },

      handleTabClick(event) {
          const clickedTab = event.target.closest('.tab-link');
          if (!clickedTab || clickedTab.classList.contains('active')) {
              return;
          }
          dom.tabLinks.forEach(link => link.classList.remove('active'));
          dom.tabContents.forEach(content => content.classList.add('hidden'));
          
          clickedTab.classList.add('active');
          const tabId = clickedTab.dataset.tab;
          document.getElementById(tabId).classList.remove('hidden');

          if (tabId === 'history-view') {
              this.loadHistory('first');
          } else if (tabId === 'dashboard-view') {
              this.loadDashboardData();
          } else if (tabId === 'admin-view' && this.isCurrentUserAdmin) {
              this.loadUsers();
          }
      },
      
      async handleHistoryDelete(docId) {
        if (!docId) return;
        
        const confirmDelete = confirm("Tem certeza que deseja excluir este registro de venda? Esta a√ß√£o n√£o pode ser desfeita.");
        
        if (confirmDelete) {
            try {
                await db.collection('receipts').doc(docId).delete();
                alert('Registro exclu√≠do com sucesso!');
                this.loadHistory('first');
            } catch (error) {
                console.error("Erro ao excluir registro:", error);
                alert("Ocorreu um erro ao excluir o registro. Verifique suas permiss√µes.");
            }
        }
      },
      
      displayAdminStatus(message, isSuccess = false) {
          dom.adminActionStatus.textContent = message;
          dom.adminActionStatus.className = isSuccess ? 'success' : '';
          setTimeout(() => dom.adminActionStatus.textContent = '', 5000);
      },

      async handleCreateSeller() {
          const username = dom.newSellerUsernameInput.value.trim();
          const password = dom.newSellerPasswordInput.value;

          if (!username || !password) {
              this.displayAdminStatus('Por favor, preencha o usu√°rio e a senha.');
              return;
          }
          if (password.length < 6) {
              this.displayAdminStatus('A senha deve ter no m√≠nimo 6 caracteres.');
              return;
          }

          dom.btnCreateSeller.disabled = true;
          this.displayAdminStatus('Criando vendedor...', true);

          try {
              const createUser = functions.httpsCallable('createUser');
              const result = await createUser({
                  email: username + DUMMY_DOMAIN,
                  password: password
              });
              this.displayAdminStatus(result.data.message, true);
              dom.newSellerUsernameInput.value = '';
              dom.newSellerPasswordInput.value = '';
              this.loadUsers();
          } catch (error) {
              console.error("Erro ao criar vendedor:", error);
              this.displayAdminStatus(`Erro: ${error.message}`);
          } finally {
              dom.btnCreateSeller.disabled = false;
          }
      },
      
      async loadUsers() {
          dom.userListContainer.innerHTML = '<p>Carregando usu√°rios...</p>';
          try {
              const listAllUsers = functions.httpsCallable('listAllUsers');
              const result = await listAllUsers();
              this.renderUserList(result.data);
          } catch (error) {
              console.error("Erro ao carregar usu√°rios:", error);
              dom.userListContainer.innerHTML = `<p style="color: var(--text-error);">Erro ao carregar usu√°rios: ${error.message}</p>`;
          }
      },
      
      async populateResellerCustomerDropdown() {
        try {
            const listAllUsers = functions.httpsCallable('listAllUsers');
            const result = await listAllUsers();
            const users = result.data;
            
            dom.resellerCustomerSelect.innerHTML = '<option value="">Selecione um cliente...</option>'; 

            users.forEach(user => {
                if (user.email === auth.currentUser.email) return;

                const username = user.email.split('@')[0];
                const option = document.createElement('option');
                option.value = username;
                option.textContent = username;
                dom.resellerCustomerSelect.appendChild(option);
            });
            
            const manualOption = document.createElement('option');
            manualOption.value = 'manual';
            manualOption.textContent = 'Digitar nome manualmente...';
            dom.resellerCustomerSelect.appendChild(manualOption);

        } catch (error) {
            console.error("Erro ao carregar lista de clientes revendedores:", error);
            dom.resellerCustomerSelect.innerHTML = `<option value="">Erro ao carregar</option>`;
        }
      },

      renderUserList(users) {
          if (!users || users.length === 0) {
              dom.userListContainer.innerHTML = '<p>Nenhum usu√°rio encontrado.</p>';
              return;
          }

          const isSuperAdmin = this.currentUsername === 'risk29';

          let tableHTML = `
              <table style="width: 100%;">
                  <thead>
                      <tr>
                          <th>Usu√°rio</th>
                          <th>Status</th>
                          <th style="text-align: center;">A√ß√µes</th>
                      </tr>
                  </thead>
                  <tbody>
          `;

          users.forEach(user => {
              const username = user.email.split('@')[0];
              const isCurrentUser = auth.currentUser.uid === user.uid;
              
              const canManageThisUser = !isCurrentUser && (isSuperAdmin || !user.isAdmin);

              tableHTML += `
                  <tr>
                      <td>${username}</td>
                      <td>${user.isAdmin ? '<b>Admin</b>' : 'Vendedor'}</td>
                      <td style="display: flex; justify-content: center; gap: 8px;">
              `;

              if (!user.isAdmin) {
                  tableHTML += `<button class="btn-promote-admin" data-uid="${user.uid}" data-email="${user.email}" ${!canManageThisUser ? 'disabled' : ''} title="Promover a admin">Promover</button>`;
              }
              
              if (user.isAdmin && isSuperAdmin && !isCurrentUser) {
                   tableHTML += `<button class="btn-demote-admin" data-uid="${user.uid}" data-email="${user.email}" title="Rebaixar para Vendedor">Demover</button>`;
              }

              tableHTML += `
                          <button class="btn-delete-user" data-uid="${user.uid}" ${!canManageThisUser ? 'disabled' : ''} title="${isCurrentUser ? 'N√£o pode se auto-excluir' : 'Excluir usu√°rio'}">Excluir</button>
                      </td>
                  </tr>
              `;
          });

          tableHTML += `</tbody></table>`;
          dom.userListContainer.innerHTML = tableHTML;
      },

      async handleUserAction(event) {
          const target = event.target;
          if (!target.matches('button')) return;

          const uid = target.dataset.uid;
          const email = target.dataset.email;
          const username = email ? email.split('@')[0] : target.closest('tr').cells[0].textContent;

          target.disabled = true;

          if (target.classList.contains('btn-promote-admin')) {
              if (confirm(`Tem certeza que deseja promover o usu√°rio ${username} a administrador?`)) {
                  this.callAdminFunction('setAdminClaim', { email }, `Usu√°rio ${username} promovido.`, `Erro ao promover ${username}.`, target);
              } else {
                  target.disabled = false;
              }
          }
          
          if (target.classList.contains('btn-demote-admin')) {
              if (confirm(`Tem certeza que deseja REBAIXAR o admin ${username} para vendedor? Ele perder√° as permiss√µes de admin.`)) {
                  this.callAdminFunction('removeAdminClaim', { email }, `Admin ${username} rebaixado para vendedor.`, `Erro ao rebaixar ${username}.`, target);
              } else {
                  target.disabled = false;
              }
          }

          if (target.classList.contains('btn-delete-user')) {
              if (confirm(`ATEN√á√ÉO: Esta a√ß√£o √© irrevers√≠vel!\nTem certeza que deseja excluir o usu√°rio ${username}?`)) {
                  this.callAdminFunction('deleteUserByUid', { uid }, `Usu√°rio ${username} exclu√≠do.`, `Erro ao excluir ${username}.`, target);
              } else {
                  target.disabled = false;
              }
          }
      },

      async callAdminFunction(functionName, params, successMsg, errorMsg, buttonElement) {
        try {
            const func = functions.httpsCallable(functionName);
            const result = await func(params);
            this.displayAdminStatus(result.data.message || successMsg, true);
            this.loadUsers();
        } catch (error) {
            console.error(`${errorMsg}:`, error);
            this.displayAdminStatus(`${errorMsg}: ${error.message}`);
            if (buttonElement) buttonElement.disabled = false;
        }
      },

      async loadHistory(direction = 'first') {
          const t = TRANSLATIONS[currentLang];
          dom.historyTableContainer.innerHTML = `<p>${t.historyLoading}</p>`;
          dom.historyPaginationControls.classList.add('hidden');

          if (direction === 'first') {
              this.historyPageCursors = [null];
              this.historyCurrentPage = 0;
          }

          let pageToLoad = this.historyCurrentPage;
          if (direction === 'next') {
              pageToLoad++;
          } else if (direction === 'prev' && pageToLoad > 0) {
              pageToLoad--;
          }
          
          const lastDoc = this.historyPageCursors[pageToLoad];
          const viewMode = document.querySelector('input[name="history-view-mode"]:checked').value;
          const searchTerm = dom.historySearchInput.value.toLowerCase().trim();
          
          let startDate = null;
          if (dom.historyDateStart.value) {
              const parts = dom.historyDateStart.value.split('-');
              startDate = new Date(parts[0], parts[1] - 1, parts[2]);
          }
          let endDate = null;
          if (dom.historyDateEnd.value) {
              const parts = dom.historyDateEnd.value.split('-');
              endDate = new Date(parts[0], parts[1] - 1, parts[2]);
              endDate.setHours(23, 59, 59, 999);
          }

          try {
              if (viewMode === 'summary') {
                  await this.renderSummaryView(searchTerm, startDate, endDate);
                  return;
              }

              let query = db.collection("receipts");
              if (startDate) query = query.where('createdAt', '>=', startDate);
              if (endDate) query = query.where('createdAt', '<=', endDate);
              query = query.orderBy('createdAt', 'desc');
              if (lastDoc) query = query.startAfter(lastDoc);
              query = query.limit(this.historyPageSize + 1);

              let querySnapshot = await query.get();
              let docs = querySnapshot.docs;
              
              this.historyHasNextPage = docs.length > this.historyPageSize;
              if (this.historyHasNextPage) docs.pop();
              
              const lastVisibleDoc = docs[docs.length - 1];
              if (direction === 'next' && lastVisibleDoc) {
                  this.historyPageCursors[pageToLoad] = lastVisibleDoc;
              }
              this.historyCurrentPage = pageToLoad;

              if (searchTerm) {
                  docs = docs.filter(doc => (doc.data().customerName || '').toLowerCase().includes(searchTerm));
              }

              if (docs.length === 0 && this.historyCurrentPage === 0) {
                  dom.historyTableContainer.innerHTML = `<p>${t.historyNoRecords}</p>`;
                  return;
              }
              
              this.renderAllSalesView(docs);
              
              dom.historyPaginationControls.classList.remove('hidden');
              dom.pageNumberDisplay.textContent = `P√°gina ${this.historyCurrentPage + 1}`;
              dom.btnPrevPage.disabled = this.historyCurrentPage === 0;
              dom.btnNextPage.disabled = !this.historyHasNextPage;

          } catch (error) {
              console.error("Erro ao buscar hist√≥rico: ", error);
              if (error.code === 'failed-precondition') {
                  dom.historyTableContainer.innerHTML = `<p style="color: var(--text-error);"><b>A√ß√£o Necess√°ria:</b> O filtro por data precisa de um √≠ndice no Firestore. Acesse o console do seu navegador (F12 ou Ctrl+Shift+I), procure por esta mensagem de erro em vermelho e clique no link fornecido pelo Firebase para criar o √≠ndice automaticamente.</p>`;
                  console.error("MENSAGEM DO FIREBASE (copie o link abaixo e cole no navegador para criar o √≠ndice): ", error.message);
              } else {
                  dom.historyTableContainer.innerHTML = `<p style="color: var(--text-error);">${t.errorGeneric}</p>`;
              }
          }
      },

      renderAllSalesView(docs) {
          const t = TRANSLATIONS[currentLang];
          let tableHTML = `<table><thead><tr><th>${t.historyCustomer}</th><th>${t.historySeller}</th><th>${t.historyTotal}</th><th>${t.historyDate}</th>`;
          
          if (this.isCurrentUserAdmin) {
              tableHTML += `<th>A√ß√µes</th>`;
          }
          tableHTML += `</tr></thead><tbody>`;

          docs.forEach(doc => {
              const data = doc.data();
              tableHTML += `<tr>
                                  <td>${data.customerName || 'N/A'}</td>
                                  <td>${(data.seller || 'N/A').split('@')[0]}</td>
                                  <td>${(data.grandTotal || 0).toFixed(2)}</td>
                                  <td>${data.createdAt?.toDate ? data.createdAt.toDate().toLocaleString(currentLang) : 'N/A'}</td>`;
              if (this.isCurrentUserAdmin) {
                  tableHTML += `
                      <td style="display: flex; gap: 8px; justify-content: center;">
                          <button class="btn-view-receipt" data-id="${doc.id}" title="Ver Recibo">
                              <svg class="icon" style="margin-right:0;"><use xlink:href="#icon-receipt"></use></svg>
                          </button>
                          <button class="delete-history-btn" data-id="${doc.id}" title="Excluir">
                              <svg class="icon" style="margin-right:0;"><use xlink:href="#icon-reset"></use></svg>
                          </button>
                      </td>`;
              }
              tableHTML += `</tr>`;
          });
          dom.historyTableContainer.innerHTML = tableHTML + `</tbody></table>`;
      },

      async renderSummaryView(searchTerm, startDate, endDate) {
          let query = db.collection("receipts");
          if (startDate) query = query.where('createdAt', '>=', startDate);
          if (endDate) query = query.where('createdAt', '<=', endDate);
          
          const allDocsSnapshot = await query.get();
          let docs = allDocsSnapshot.docs;
          
          if (searchTerm) {
              docs = docs.filter(doc => (doc.data().customerName || '').toLowerCase().includes(searchTerm));
          }
          if (docs.length === 0) {
              dom.historyTableContainer.innerHTML = `<p>${TRANSLATIONS[currentLang].historyNoRecords}</p>`;
              return;
          }
          const customerSummary = {};
          docs.forEach(doc => {
              const data = doc.data();
              const customerName = data.customerName || 'Cliente N√£o Identificado';
              if (!customerSummary[customerName]) {
                  customerSummary[customerName] = { totalSpent: 0, salesCount: 0, lastSaleDate: null };
              }
              customerSummary[customerName].totalSpent += data.grandTotal || 0;
              customerSummary[customerName].salesCount++;
              const saleDate = data.createdAt?.toDate;
              if (saleDate && (!customerSummary[customerName].lastSaleDate || saleDate > customerSummary[customerName].lastSaleDate)) {
                  customerSummary[customerName].lastSaleDate = saleDate;
              }
          });
          const summaryArray = Object.keys(customerSummary).map(name => ({ name, ...customerSummary[name] })).sort((a, b) => b.totalSpent - a.totalSpent);
          let tableHTML = `<table><thead><tr><th>Cliente</th><th>Total Gasto</th><th>N¬∫ de Compras</th><th>√öltima Compra</th></tr></thead><tbody>`;
          summaryArray.forEach(summary => {
              tableHTML += `<tr><td>${summary.name}</td><td>${summary.totalSpent.toFixed(2)}</td><td>${summary.salesCount}</td><td>${summary.lastSaleDate ? summary.lastSaleDate.toLocaleDateString(currentLang) : 'N/A'}</td></tr>`;
          });
          dom.historyTableContainer.innerHTML = tableHTML + `</tbody></table>`;
      },

      async loadDashboardData() {
        try {
            const querySnapshot = await db.collection("receipts").get();
            const receipts = querySnapshot.docs.map(doc => doc.data());
            const salesByDay = {};
            receipts.forEach(receipt => {
                if (receipt.createdAt) {
                    const date = receipt.createdAt.toDate();
                    const dateString = new Date(date.getFullYear(), date.getMonth(), date.getDate()).toLocaleDateString(currentLang, { year: '2-digit', month: '2-digit', day: '2-digit' });
                    salesByDay[dateString] = (salesByDay[dateString] || 0) + (receipt.grandTotal || 0);
                }
            });
            const sortedSales = Object.entries(salesByDay).sort((a, b) => {
                const dateA = new Date(a[0].split('/').reverse().join('-'));
                const dateB = new Date(b[0].split('/').reverse().join('-'));
                return dateA - dateB;
            });
            const salesLabels = sortedSales.map(entry => entry[0]);
            const salesData = sortedSales.map(entry => entry[1]);
            this.renderSalesChart(salesLabels, salesData);
            const tokenCounts = {};
            receipts.forEach(receipt => {
                if (receipt.itemsData && typeof receipt.itemsData === 'object') {
                    for (const tokenKey in receipt.itemsData) {
                        tokenCounts[tokenKey] = (tokenCounts[tokenKey] || 0) + receipt.itemsData[tokenKey].qty;
                    }
                }
            });
            const tokenLabels = Object.keys(tokenCounts).map(key => ITENS_CATALOGO[key]?.[`name_${currentLang}`] || key);
            const tokenData = Object.values(tokenCounts);
            this.renderTokensChart(tokenLabels, tokenData);
        } catch (error) {
            console.error("Erro ao carregar dados do dashboard:", error);
        }
      },

      renderSalesChart(labels, data) {
          if (this.salesChartInstance) {
              this.salesChartInstance.destroy();
          }
          const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text-primary');
          const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--grid-color');
          this.salesChartInstance = new Chart(dom.salesOverTimeChart, {
              type: 'line',
              data: {
                  labels: labels,
                  datasets: [{
                      label: 'Total de Vendas (Mush)',
                      data: data,
                      borderColor: 'rgba(52, 211, 153, 1)',
                      backgroundColor: 'rgba(52, 211, 153, 0.2)',
                      fill: true,
                      tension: 0.1
                  }]
              },
              options: {
                  responsive: true,
                  scales: {
                      y: { ticks: { color: textColor }, grid: { color: gridColor } },
                      x: { ticks: { color: textColor }, grid: { color: gridColor } }
                  },
                  plugins: {
                      legend: { labels: { color: textColor } }
                  }
              }
          });
      },

      renderTokensChart(labels, data) {
          if (this.tokensChartInstance) {
              this.tokensChartInstance.destroy();
          }
          const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text-primary');
          this.tokensChartInstance = new Chart(dom.tokensSoldChart, {
              type: 'doughnut',
              data: {
                  labels: labels,
                  datasets: [{
                      label: 'Quantidade Vendida',
                      data: data,
                      backgroundColor: [
                          'rgba(52, 211, 153, 0.7)', 'rgba(59, 130, 246, 0.7)',
                          'rgba(239, 68, 68, 0.7)', 'rgba(245, 158, 11, 0.7)'
                      ],
                      borderColor: getComputedStyle(document.documentElement).getPropertyValue('--bg-primary'),
                      borderWidth: 2
                  }]
              },
              options: {
                  responsive: true,
                  plugins: {
                      legend: { position: 'top', labels: { color: textColor } }
                  }
              }
          });
      },
      
      setLanguage(lang, shouldSave = true, skipReload = false) {
          currentLang = lang;
          localStorage.setItem('language', lang);
          document.querySelectorAll('[data-translate-key]').forEach(el => {
              const key = el.dataset.translateKey;
              const translation = TRANSLATIONS[lang][key];
              if (translation && typeof translation !== 'function') {
                  el.innerText = translation;
              }
          });
          document.querySelectorAll('[data-translate-key-placeholder]').forEach(el => {
              const key = el.dataset.translateKeyPlaceholder;
              if (TRANSLATIONS[lang][key]) {
                  el.placeholder = TRANSLATIONS[lang][key];
              }
          });
          document.title = TRANSLATIONS[lang].pageTitle;
          dom.langBr.classList.toggle('active', lang === 'br');
          dom.langEn.classList.toggle('active', lang === 'en');
          
          if (!skipReload) {
              this.loadTable();
              this.buildTokenFilters(dom.tokenFiltersContainer);
              this.updateUI();
          }

          if (shouldSave) {
              this.triggerSavePreferences();
          }
      },
      
      toggleMode(mode) {
        dom.distributorSection.style.display = mode === 'mush' ? 'flex' : 'none';
        const isMushMode = mode === 'mush';
        dom.tabelaItensBody.querySelectorAll('input').forEach(input => {
            if (input.id.startsWith('qtd-')) {
                input.disabled = isMushMode;
            }
        });
        document.getElementById('btnCalcular').style.display = isMushMode ? 'none' : 'inline-block';
        if (isMushMode) this.buildTokenFilters(dom.tokenFiltersContainer);
      },

      async toggleResellerMode(event) {
          const isResellerMode = event.target.checked;
          
          if (isResellerMode) {
              dom.customerNameContainer.classList.add('hidden');
              dom.resellerCustomerSelectionContainer.classList.remove('hidden');
              await this.populateResellerCustomerDropdown();
              this.checkResellerLimit();
          } else {
              dom.customerNameContainer.classList.remove('hidden');
              dom.resellerCustomerSelectionContainer.classList.add('hidden');
              dom.resellerLimitStatus.classList.add('hidden');
              clearInterval(this.resellerLimitInterval);
          }

          if (isResellerMode) {
              for (const key in PRECOS_RESELLER) {
                  const priceInput = document.getElementById(`price-${key}`);
                  if (priceInput) {
                      priceInput.value = PRECOS_RESELLER[key];
                      priceInput.disabled = true;
                  }
              }
          } else {
              for (const key in ITENS_CATALOGO) {
                  const priceInput = document.getElementById(`price-${key}`);
                  if (priceInput) {
                      priceInput.disabled = false;
                  }
              }
              await this.loadUserPreferences(auth.currentUser);
          }
          this.updateUI();
      },
      
      setTheme(theme, shouldSave = true) {
          dom.html.setAttribute('data-theme', theme);
          localStorage.setItem('theme', theme);
          if (shouldSave) {
            this.triggerSavePreferences();
          }
      },

      buildTokenFilters(container) {
          container.innerHTML = '';
          for (const key in ITENS_CATALOGO) {
              const item = ITENS_CATALOGO[key];
              const label = document.createElement('label');
              label.innerHTML = `<input type="checkbox" value="${key}" checked><span>${item[`name_${currentLang}`]}</span>`;
              container.appendChild(label);
          }
          if (container.id === 'token-filters-container') {
              container.dispatchEvent(new Event('change'));
          }
      },

      getFormattedDate() {
          const today = new Date();
          const year = today.getFullYear();
          const month = String(today.getMonth() + 1).padStart(2, '0');
          const day = String(today.getDate()).padStart(2, '0');
          return `${year}-${month}-${day}`;
      },

      async checkResellerLimit() {
          if (!dom.resellerModeToggle.checked) {
              dom.resellerLimitStatus.classList.add('hidden');
              clearInterval(this.resellerLimitInterval);
              return;
          }

          let customerName;
          if (dom.resellerCustomerSelect.value === 'manual') {
              customerName = dom.resellerCustomerManualInput.value.trim().toLowerCase();
          } else {
              customerName = dom.resellerCustomerSelect.value.trim().toLowerCase();
          }

          if (!customerName) {
              dom.resellerLimitStatus.classList.add('hidden');
              clearInterval(this.resellerLimitInterval);
              this.currentCustomerUsage = { revive: 0, max: 0 };
              return;
          }

          const dateStr = this.getFormattedDate();
          const docId = `${customerName}_${dateStr}`;
          
          try {
              const docRef = db.collection('resellerLimits').doc(docId);
              const docSnap = await docRef.get();

              if (docSnap.exists) {
                  const data = docSnap.data();
                  this.currentCustomerUsage.revive = data.reviveCount || 0;
                  this.currentCustomerUsage.max = data.maxCount || 0;
              } else {
                  this.currentCustomerUsage = { revive: 0, max: 0 };
              }
              
              this.updateResellerLimitStatusUI();
              dom.resellerLimitStatus.classList.remove('hidden');

          } catch (error) {
              console.error("Erro ao verificar limite do revendedor:", error);
              this.currentCustomerUsage = { revive: 0, max: 0 };
              dom.resellerLimitStatus.classList.add('hidden');
          }
      },
      
      updateResellerLimitStatusUI() {
            clearInterval(this.resellerLimitInterval);

            const updateTimer = () => {
                const now = new Date();
                const endOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                const diff = endOfDay - now;

                if (diff < 0) {
                    this.checkResellerLimit();
                    return;
                }

                const hours = String(Math.floor(diff / (1000 * 60 * 60))).padStart(2, '0');
                const minutes = String(Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60))).padStart(2, '0');
                const seconds = String(Math.floor((diff % (1000 * 60)) / 1000)).padStart(2, '0');
                const timeString = `${hours}:${minutes}:${seconds}`;
                
                const t = TRANSLATIONS[currentLang];
                dom.resellerLimitStatus.innerHTML = t.resellerLimitStatus(
                    this.currentCustomerUsage.revive,
                    this.currentCustomerUsage.max,
                    RESELLER_DAILY_LIMIT,
                    timeString
                );
            };

            updateTimer();
            this.resellerLimitInterval = setInterval(updateTimer, 1000);
      },
      
      loadTable() {
          dom.tabelaItensBody.innerHTML = '';
          for (const key in ITENS_CATALOGO) {
              const item = ITENS_CATALOGO[key];
              const tr = document.createElement('tr');
              
              tr.innerHTML = `
                  <td>${item[`name_${currentLang}`]}</td>
                  <td>
                      <div style="width: 100px; margin: 0 auto;">
                          <input type="number" class="price-input" id="price-${key}" value="${item.preco}" step="10" placeholder="Insira o valor aqui">
                      </div>
                  </td>
                  <td style="text-align: center;">
                      <div style="width: 80px; margin: 0 auto;">
                          <input type="number" id="qtd-${key}" value="0" min="0">
                      </div>
                  </td>
                  <td style="text-align: center;">0.00</td>
              `;
              
              tr.querySelector(`td:nth-child(4)`).appendChild(this.createCoinIcon());
              dom.tabelaItensBody.appendChild(tr);

              tr.querySelector(`#qtd-${key}`).addEventListener('input', this.updateUI.bind(this));
              tr.querySelector(`#price-${key}`).addEventListener('change', (event) => this.handlePriceChange(event, key));
          }
          this.updateUI();
      },

      handlePriceChange(event, key) {
          const input = event.target;
          let novoPreco = parseFloat(input.value);
          const precoMinimo = PRECOS_MINIMOS[key];

          if (!this.isCurrentUserAdmin) {
              if (novoPreco < precoMinimo) {
                  alert(`O valor m√≠nimo para este item √© ${precoMinimo}.`);
                  novoPreco = precoMinimo;
                  input.value = novoPreco;
              }
          }
          
          if (novoPreco < 0) {
               novoPreco = 0;
               input.value = novoPreco;
          }

          this.updateUI();
          this.triggerSavePreferences();
      },

      calculateValues() {
          const descontoPercentual = parseFloat(dom.descontoInput.value) || 0;
          const fatorDesconto = 1 - (descontoPercentual / 100);
          let totalFinal = 0;
          const itensCalculados = {};
          
          const isResellerMode = dom.resellerModeToggle.checked;
          
          let reviveLimitRemaining = RESELLER_DAILY_LIMIT - this.currentCustomerUsage.revive;
          let maxLimitRemaining = RESELLER_DAILY_LIMIT - this.currentCustomerUsage.max;
          
          for (const key in ITENS_CATALOGO) {
              const precoBase = ITENS_CATALOGO[key].preco;
              const precoRevendedor = PRECOS_RESELLER[key];
              
              const quantidadeInput = document.getElementById(`qtd-${key}`);
              const quantidade = quantidadeInput ? parseInt(quantidadeInput.value) || 0 : 0;
              let subtotal = 0;
              let precoAplicado = precoBase;

              if (isResellerMode && (key === 'revive' || key === 'max')) {
                  const limitRemaining = (key === 'revive') ? reviveLimitRemaining : maxLimitRemaining;
                  
                  const tokensDentroDoLimite = Math.max(0, Math.min(quantidade, limitRemaining));
                  const tokensForaDoLimite = Math.max(0, quantidade - tokensDentroDoLimite);
                  
                  subtotal += tokensDentroDoLimite * precoRevendedor;
                  subtotal += tokensForaDoLimite * precoBase;
                  
                  precoAplicado = precoRevendedor;

              } else {
                  const precoInput = document.getElementById(`price-${key}`);
                  precoAplicado = isResellerMode ? PRECOS_RESELLER[key] : (precoInput ? parseFloat(precoInput.value) : precoBase);
                  subtotal = quantidade * (precoAplicado * fatorDesconto);
              }

              totalFinal += subtotal;
              
              itensCalculados[key] = {
                  quantidade,
                  precoAtual: precoAplicado,
                  precoComDesconto: subtotal / quantidade || 0,
                  subtotal
              };
          }

          return { totalFinal, descontoPercentual, itens: itensCalculados };
      },
      
      updateUI() {
          const calculo = this.calculateValues();
          if (!calculo) return;
          
          Array.from(dom.tabelaItensBody.rows).forEach((row, index) => {
              const key = Object.keys(ITENS_CATALOGO)[index];
              const itemCalculado = calculo.itens[key];
              
              const totalCell = row.cells[3];
              totalCell.innerHTML = `${itemCalculado.subtotal.toFixed(2)} `;
              totalCell.appendChild(this.createCoinIcon());
          });
          
          dom.totalGeralCell.innerHTML = `<b>${calculo.totalFinal.toFixed(2)}</b> `;
          dom.totalGeralCell.appendChild(this.createCoinIcon());
      },

      reset(clearDistributor = true) {
          dom.nomeClienteInput.value = '';
          dom.descontoInput.value = '';
          dom.resellerCustomerSelect.value = '';
          dom.resellerCustomerManualInput.value = '';
          dom.resellerCustomerManualInput.classList.add('hidden');
          
          if (clearDistributor) {
              dom.totalMushInput.value = '';
              dom.leftoverMushDiv.innerHTML = '';
              dom.leftoverDistributorSection.classList.add('hidden');
          }
          Object.keys(ITENS_CATALOGO).forEach(key => {
              const qtdInput = document.getElementById(`qtd-${key}`);
              if (qtdInput) qtdInput.value = 0;

              if (!dom.resellerModeToggle.checked) {
                const priceInput = document.getElementById(`price-${key}`);
                if (priceInput) priceInput.value = ITENS_CATALOGO[key].preco;
              }
          });

          this.checkResellerLimit();
          this.updateUI();
          if(!dom.resellerModeToggle.checked) {
            this.triggerSavePreferences();
          }
      },
      
      distributeMush() {
          this.reset(false);
          const totalMush = parseFloat(dom.totalMushInput.value) || 0;
          if (totalMush <= 0) { this.updateUI(); return; }
          const selectedTokenKeys = Array.from(dom.tokenFiltersContainer.querySelectorAll('input:checked')).map(cb => cb.value);
          if (selectedTokenKeys.length === 0) { alert(TRANSLATIONS[currentLang].alertNoItems); return; }
          
          let tokens = selectedTokenKeys.map(key => ({ 
              key, 
              preco: parseFloat(document.getElementById(`price-${key}`).value) || ITENS_CATALOGO[key].preco, 
              quantidade: 0 
          }));
          
          if (tokens.length === 2 && document.querySelector('input[name="two-token-strategy"]:checked').value === 'split') {
              const mushPerToken = totalMush / 2;
              tokens.forEach(token => {
                  if(token.preco > 0) {
                     token.quantidade = Math.floor(mushPerToken / token.preco);
                  }
              });
          } else {
              this.runFairDistribution(tokens, totalMush);
          }
          this.updateDistributionUI(tokens);
      },

      distributeLeftoverMush() {
          const selectedTokenKeysForLeftover = Array.from(dom.leftoverTokenFiltersContainer.querySelectorAll('input:checked')).map(cb => cb.value);
          if (selectedTokenKeysForLeftover.length === 0) { alert(TRANSLATIONS[currentLang].alertNoItems); return; }

          let tokensForDistribution = selectedTokenKeysForLeftover.map(key => ({
              key,
              preco: parseFloat(document.getElementById(`price-${key}`).value) || ITENS_CATALOGO[key].preco,
              quantidade: 0
          }));

          this.runFairDistribution(tokensForDistribution, this.currentLeftover);

          tokensForDistribution.forEach(token => {
              const qtyInput = document.getElementById(`qtd-${token.key}`);
              const currentQty = parseInt(qtyInput.value) || 0;
              qtyInput.value = currentQty + token.quantidade;
          });

          dom.leftoverDistributorSection.classList.add('hidden');
          
          const newCalculo = this.calculateValues();
          const totalMushInputted = parseFloat(dom.totalMushInput.value) || 0;
          this.currentLeftover = totalMushInputted - newCalculo.totalFinal;
          dom.leftoverMushDiv.innerHTML = `${TRANSLATIONS[currentLang].leftoverMushText} <b>${this.currentLeftover.toFixed(2)}</b> `;
          dom.leftoverMushDiv.appendChild(this.createCoinIcon());

          this.updateUI();
      },
      
      runFairDistribution(tokens, totalMush) {
          tokens.sort(() => Math.random() - 0.5);
          let mushRestante = totalMush;
          let possivelComprar = true;
          while (possivelComprar) {
              let comprouNestaRodada = false;
              for (const token of tokens) {
                  if (mushRestante >= token.preco && token.preco > 0) {
                      token.quantidade++;
                      mushRestante -= token.preco;
                      comprouNestaRodada = true;
                  }
              }
              if (!comprouNestaRodada) possivelComprar = false;
          }
          return tokens;
      },

      updateDistributionUI(tokens) {
          let mushGasto = 0;
          tokens.forEach(token => {
              document.getElementById(`qtd-${token.key}`).value = token.quantidade;
              mushGasto += token.quantidade * token.preco;
          });
          const mushTotal = parseFloat(dom.totalMushInput.value) || 0;
          this.currentLeftover = mushTotal - mushGasto;
          dom.leftoverMushDiv.innerHTML = `${TRANSLATIONS[currentLang].leftoverMushText} <b>${this.currentLeftover.toFixed(2)}</b> `;
          dom.leftoverMushDiv.appendChild(this.createCoinIcon());
          const cheapestPrice = Math.min(...Object.values(ITENS_CATALOGO).map(t => t.preco));
          if (this.currentLeftover >= cheapestPrice) {
              dom.leftoverDistributorSection.classList.remove('hidden');
              this.buildTokenFilters(dom.leftoverTokenFiltersContainer);
          } else {
              dom.leftoverDistributorSection.classList.add('hidden');
          }
          this.updateUI();
      },

      createCoinIcon() {
          const img = document.createElement('img');
          img.src = MOEDA_BASE64;
          img.style.cssText = 'width: 16px; height: 16px; vertical-align: middle; margin-left: 4px;';
          img.alt = 'mush';
          return img;
      },

      buildReceiptHtml(receiptData) {
          const t = TRANSLATIONS[currentLang];
          let subtotalBrutoSemDesconto = 0;
          let itemsHtml = '';

          for (const key in receiptData.itemsData) {
              const item = receiptData.itemsData[key];
              const catalogoItem = ITENS_CATALOGO[key];
              if (item.qty > 0 && catalogoItem) {
                  const subtotalItem = item.qty * item.price;
                  itemsHtml += `<tr><td style="padding: 5px 0;">${catalogoItem[`name_${currentLang}`]} x ${item.qty}</td><td style="padding: 5px 0; text-align: right;">${subtotalItem.toFixed(2)}</td></tr>`;
                  subtotalBrutoSemDesconto += item.qty * item.price; 
              }
          }
          
          const valorDesconto = subtotalBrutoSemDesconto - receiptData.grandTotal;
          const dataVenda = receiptData.createdAt?.toDate ? receiptData.createdAt.toDate().toLocaleString(currentLang) : new Date().toLocaleString(currentLang);

          let receiptHtml = `
              <h2 style="font-family: 'Poppins', sans-serif; color: var(--accent-primary); text-align: center;">${t.receiptHeader}</h2>
              <p style="text-align: center; color: var(--text-secondary); margin-bottom: 10px;">${receiptData.customerName}</p>
              <p style="text-align: center; color: var(--text-secondary); margin-bottom: 20px; font-size: 0.8em;">${dataVenda}</p>
              <h3 style="margin-top: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; font-size: 1em;">${t.receiptItemsHeader}</h3>
              <table style="width: 100%; margin-top: 10px; border-collapse: collapse; font-size: 0.9em;"><tbody>${itemsHtml}</tbody></table>
              <div style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 10px; font-size: 0.9em;">
                  <p style="display: flex; justify-content: space-between;"><span>${t.receiptSubtotal}:</span> <span>${subtotalBrutoSemDesconto.toFixed(2)}</span></p>
                  <p style="display: flex; justify-content: space-between;"><span>${t.receiptDiscount} (${receiptData.discountApplied || 0}%):</span> <span>-${valorDesconto.toFixed(2)}</span></p>
                  <p style="display: flex; justify-content: space-between; font-weight: bold; color: var(--accent-primary); font-size: 1.2em; margin-top: 5px;"><span>${t.receiptFinalTotal}:</span> <span>${receiptData.grandTotal.toFixed(2)}</span></p>
              </div>
              <p style="text-align: center; margin-top: 20px; font-size: 0.9em;">${t.receiptThanks}</p>`;
          return receiptHtml;
      },

      async generateImage() {
        const isResellerMode = dom.resellerModeToggle.checked;
        if (isResellerMode) {
            const reviveQty = parseInt(document.getElementById('qtd-revive').value) || 0;
            const maxQty = parseInt(document.getElementById('qtd-max').value) || 0;
            const reviveLimitRemaining = RESELLER_DAILY_LIMIT - this.currentCustomerUsage.revive;
            const maxLimitRemaining = RESELLER_DAILY_LIMIT - this.currentCustomerUsage.max;

            if (reviveQty > reviveLimitRemaining || maxQty > maxLimitRemaining) {
                 alert(TRANSLATIONS[currentLang].resellerLimitExceededWarning);
            }
        }

        const calculo = this.calculateValues();
        if(!calculo) return;
        const t = TRANSLATIONS[currentLang];
        let temItens = Object.values(calculo.itens).some(item => item.quantidade > 0);
        if (!temItens) { alert(t.alertNoItems); return; }
        
        let customerName;
        if (isResellerMode) {
            if (dom.resellerCustomerSelect.value === 'manual') {
                customerName = dom.resellerCustomerManualInput.value.trim() || 'Revendedor_Nao_Identificado';
            } else {
                customerName = dom.resellerCustomerSelect.value || 'Revendedor_Nao_Identificado';
            }
        } else {
            customerName = dom.nomeClienteInput.value.trim() || 'Nao_Identificado';
        }
        
        const itemsToSave = {};
        for(const key in calculo.itens) {
            if(calculo.itens[key].quantidade > 0) {
                itemsToSave[key] = {
                    qty: calculo.itens[key].quantidade,
                    price: calculo.itens[key].precoAtual
                };
            }
        }
        const receiptData = {
            customerName: customerName, 
            discountApplied: calculo.descontoPercentual, 
            grandTotal: calculo.totalFinal,
            itemsData: itemsToSave, 
            seller: this.currentUsername, 
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            await db.collection("receipts").add(receiptData);

            if (isResellerMode && customerName !== 'Revendedor_Nao_Identificado') {
                const reviveComprados = calculo.itens.revive?.quantidade || 0;
                const maxComprados = calculo.itens.max?.quantidade || 0;

                if (reviveComprados > 0 || maxComprados > 0) {
                    const customerNameForDb = customerName.toLowerCase();
                    const dateStr = this.getFormattedDate();
                    const docId = `${customerNameForDb}_${dateStr}`;
                    const docRef = db.collection('resellerLimits').doc(docId);
                    
                    const updateData = {
                        customerName: customerNameForDb,
                        date: dateStr,
                        lastUpdatedBy: auth.currentUser.email
                    };
                    if (reviveComprados > 0) {
                        updateData.reviveCount = firebase.firestore.FieldValue.increment(reviveComprados);
                    }
                    if (maxComprados > 0) {
                        updateData.maxCount = firebase.firestore.FieldValue.increment(maxComprados);
                    }
                    
                    await docRef.set(updateData, { merge: true });
                    
                    this.currentCustomerUsage.revive += reviveComprados;
                    this.currentCustomerUsage.max += maxComprados;
                    this.updateResellerLimitStatusUI();
                }
            }
        } catch(e) {
            console.error("Erro ao salvar no Firestore: ", e);
            alert("Houve um erro ao salvar o recibo ou atualizar o limite no banco de dados.");
            return;
        }

        const receiptHtml = this.buildReceiptHtml(receiptData);

        const resultadoDiv = document.getElementById('resultado');
        resultadoDiv.innerHTML = receiptHtml;
        resultadoDiv.style.display = 'block';
        resultadoDiv.style.position = 'fixed';
        resultadoDiv.style.top = '50%';
        resultadoDiv.style.left = '50%';
        resultadoDiv.style.transform = 'translate(-50%, -50%)';
        resultadoDiv.style.zIndex = '1000';
        setTimeout(() => {
            html2canvas(resultadoDiv, { backgroundColor: getComputedStyle(document.body).getPropertyValue('--bg-secondary'), scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                const nomeSanitizado = customerName.normalize('NFD').replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '_').replace(/[^\w-]/g, '');
                link.download = `${nomeSanitizado}_recibo.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                resultadoDiv.style.display = 'none';
                resultadoDiv.style.top = '-100%';
                resultadoDiv.style.zIndex = '-1';
            });
        }, 300);
      },
      
      async regenerateReceipt(docId) {
        if (!docId) return;

        try {
          const docRef = db.collection('receipts').doc(docId);
          const docSnap = await docRef.get();

          if (!docSnap.exists) {
            alert("Erro: Recibo n√£o encontrado no banco de dados.");
            return;
          }

          const receiptData = docSnap.data();
          const receiptHtml = this.buildReceiptHtml(receiptData);
          
          const resultadoDiv = document.getElementById('resultado');
          resultadoDiv.innerHTML = receiptHtml;
          resultadoDiv.style.display = 'block';
          resultadoDiv.style.position = 'fixed';
          resultadoDiv.style.top = '50%';
          resultadoDiv.style.left = '50%';
          resultadoDiv.style.transform = 'translate(-50%, -50%)';
          resultadoDiv.style.zIndex = '1000';

          setTimeout(() => {
              html2canvas(resultadoDiv, { backgroundColor: getComputedStyle(document.body).getPropertyValue('--bg-secondary'), scale: 2 }).then(canvas => {
                  const link = document.createElement('a');
                  const customerName = receiptData.customerName || 'recibo';
                  const date = receiptData.createdAt.toDate().toISOString().split('T')[0];
                  const nomeSanitizado = customerName.normalize('NFD').replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '_').replace(/[^\w-]/g, '');
                  link.download = `${nomeSanitizado}_recibo_${date}.png`;
                  link.href = canvas.toDataURL('image/png');
                  link.click();
                  resultadoDiv.style.display = 'none';
                  resultadoDiv.style.top = '-100%';
                  resultadoDiv.style.zIndex = '-1';
              });
          }, 300);

        } catch (error) {
          console.error("Erro ao regenerar recibo:", error);
          alert("Ocorreu um erro ao buscar os dados do recibo.");
        }
      },

      async openTxtExportModal() {
        dom.customerListForExport.innerHTML = `<p>${TRANSLATIONS[currentLang].historyLoading}</p>`;
        dom.txtExportModal.classList.remove('hidden');

        const searchTerm = dom.historySearchInput.value.toLowerCase().trim();
        let startDate = null;
        if (dom.historyDateStart.value) {
            const parts = dom.historyDateStart.value.split('-');
            startDate = new Date(parts[0], parts[1] - 1, parts[2]);
        }
        let endDate = null;
        if (dom.historyDateEnd.value) {
            const parts = dom.historyDateEnd.value.split('-');
            endDate = new Date(parts[0], parts[1] - 1, parts[2]);
            endDate.setHours(23, 59, 59, 999);
        }
        
        let query = db.collection("receipts");
        if (startDate) query = query.where('createdAt', '>=', startDate);
        if (endDate) query = query.where('createdAt', '<=', endDate);
        
        try {
          const allDocsSnapshot = await query.get();
          let docs = allDocsSnapshot.docs;
          
          if (searchTerm) {
              docs = docs.filter(doc => (doc.data().customerName || '').toLowerCase().includes(searchTerm));
          }
          if (docs.length === 0) {
              dom.customerListForExport.innerHTML = `<p>${TRANSLATIONS[currentLang].historyNoRecords}</p>`;
              return;
          }
          const customerSummary = {};
          docs.forEach(doc => {
              const data = doc.data();
              const customerName = data.customerName || 'Cliente N√£o Identificado';
              if (!customerSummary[customerName]) {
                  customerSummary[customerName] = { totalSpent: 0 };
              }
              customerSummary[customerName].totalSpent += data.grandTotal || 0;
          });

          const summaryArray = Object.keys(customerSummary).map(name => ({ name, ...customerSummary[name] })).sort((a, b) => b.totalSpent - a.totalSpent);
          
          dom.customerListForExport.innerHTML = '';
          dom.selectAllCustomersCheckbox.checked = false;
          summaryArray.forEach(summary => {
            const label = document.createElement('label');
            label.innerHTML = `
              <input type="checkbox" value="${summary.name}" data-total="${summary.totalSpent.toFixed(2)}">
              <div class="customer-info">
                <span>${summary.name}</span>
                <span class="customer-total">R$ ${summary.totalSpent.toFixed(2)}</span>
              </div>
            `;
            dom.customerListForExport.appendChild(label);
          });

        } catch (error) {
          console.error("Erro ao gerar resumo para exporta√ß√£o:", error);
          dom.customerListForExport.innerHTML = `<p style="color: var(--text-error);">${TRANSLATIONS[currentLang].errorGeneric}</p>`;
        }
      },

      handleSelectAllCustomers(event) {
        const checkboxes = dom.customerListForExport.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
          checkbox.checked = event.target.checked;
        });
      },

      generateTxtFile() {
        const linesToExport = [];
        const checkedCustomers = dom.customerListForExport.querySelectorAll('input[type="checkbox"]:checked');

        if (checkedCustomers.length === 0) {
          alert("Nenhum cliente selecionado para exportar.");
          return;
        }

        checkedCustomers.forEach(checkbox => {
          const customerName = checkbox.value;
          const totalSpent = checkbox.dataset.total;
          linesToExport.push(`${customerName}: R$ ${totalSpent}`);
        });

        const fileContent = linesToExport.join('\r\n');
        const blob = new Blob([fileContent], { type: 'text/plain;charset=utf-8' });
        const dateStr = new Date().toISOString().slice(0, 10);
        const fileName = `Relatorio_Clientes_${dateStr}.txt`;
        
        const link = document.createElement("a");
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        dom.txtExportModal.classList.add('hidden');
      }

    };
    
    app.init();
</script>
</body>
</html>
