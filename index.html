<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Painel de vendas by Riciv</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Poppins:wght@700&family=Roboto+Mono&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-functions-compat.js"></script>

<style>
  :root {
    --font-header: 'Poppins', sans-serif;
    --font-body: 'Inter', sans-serif;
    --font-mono: 'Roboto Mono', monospace;
    --bg-primary: #18181b;
    --bg-secondary: #27272a;
    --bg-tertiary: #3f3f46;
    --border-color: #3f3f46;
    --accent-primary: #34d399;
    --accent-hover: #10b981;
    --accent-danger: #f43f5e;
    --accent-danger-hover: #be123c;
    --accent-warning: #f59e0b;
    --accent-warning-hover: #b45309;
    --text-primary: #f8fafc;
    --text-secondary: #a1a1aa;
    --text-error: #fca5a5;
    --grid-color: rgba(255, 255, 255, 0.15);
  }

  html[data-theme='light'] {
    --bg-primary: #f4f4f5;
    --bg-secondary: #ffffff;
    --bg-tertiary: #e4e4e7;
    --border-color: #d4d4d8;
    --accent-danger: #ef4444;
    --accent-danger-hover: #dc2626;
    --accent-warning: #f59e0b;
    --accent-warning-hover: #d97706;
    --text-primary: #18181b;
    --text-secondary: #71717a;
    --text-error: #b91c1c;
    --grid-color: rgba(0, 0, 0, 0.1);
  }
  
  html[data-accent-color='green'] { --accent-primary: #34d399; --accent-hover: #10b981; }
  html[data-accent-color='blue'] { --accent-primary: #3b82f6; --accent-hover: #2563eb; }
  html[data-accent-color='purple'] { --accent-primary: #8b5cf6; --accent-hover: #7c3aed; }
  html[data-accent-color='yellow'] { --accent-primary: #f59e0b; --accent-hover: #d97706; }
  html[data-theme='light'][data-accent-color='green'] { --accent-primary: #10b981; --accent-hover: #0f9a6c; }
  html[data-theme='light'][data-accent-color='blue'] { --accent-primary: #2563eb; --accent-hover: #1d4ed8; }
  html[data-theme='light'][data-accent-color='purple'] { --accent-primary: #7c3aed; --accent-hover: #6d28d9; }
  html[data-theme='light'][data-accent-color='yellow'] { --accent-primary: #d97706; --accent-hover: #b45309; }


  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background-color: var(--bg-primary);
    color: var(--text-primary);
    font-family: var(--font-body);
    padding: 40px 20px;
    transition: background-color 0.3s ease, color 0.3s ease;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    min-height: 100vh;
  }

  .hidden { display: none !important; }

  #auth-container {
    width: 100%;
    max-width: 400px;
    background: var(--bg-secondary);
    padding: 32px;
    border-radius: 16px;
    border: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    gap: 24px;
    margin-top: 10vh;
  }
  
  #app-container {
    width: 100%;
    max-width: 800px;
  }

  .container {
    width: 100%;
    background: var(--bg-secondary);
    padding: 32px;
    border-radius: 16px;
    border: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    gap: 24px;
  }
  
  .settings-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
      flex-wrap: wrap;
      gap: 16px;
  }
  .settings-controls { 
      position: relative;
      display: flex; 
      align-items: center; 
      gap: 12px; 
      flex-wrap: wrap; 
  }
  #logged-in-user { font-size: 14px; color: var(--text-secondary); }
  #logged-in-user .username { font-weight: 700; color: var(--text-primary); }

  .language-switcher button { background: none; border: none; padding: 4px; cursor: pointer; transition: all 0.3s ease; }
  .language-switcher button:not(.active) { filter: grayscale(100%); opacity: 0.6; }
  html[data-theme='dark'] .language-switcher button:not(.active) { filter: grayscale(100%) invert(100%); opacity: 0.8; }
  .language-switcher button.active, .language-switcher button:not(.active):hover { filter: none; opacity: 1; transform: scale(1.1); }
  
  .theme-switcher { display: flex; align-items: center; gap: 8px; }
  .theme-switcher-label { font-size: 12px; color: var(--text-secondary); font-weight: 500; }
  .toggle-track { width: 44px; height: 24px; background-color: var(--bg-tertiary); border-radius: 99px; position: relative; cursor: pointer; transition: background-color 0.3s ease; }
  .toggle-thumb { width: 18px; height: 18px; background-color: white; border-radius: 50%; position: absolute; top: 3px; left: 4px; transition: transform 0.3s ease; }
  html[data-theme='light'] .toggle-track { background-color: var(--accent-primary); }
  html[data-theme='light'] .toggle-thumb { transform: translateX(19px); }

  .accent-color-switcher { display: flex; align-items: center; gap: 8px; }
  .accent-color-switcher .color-box {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    cursor: pointer;
    border: 3px solid transparent;
    transition: all 0.3s ease;
  }
  .accent-color-switcher .color-box.active {
    border-color: var(--accent-primary);
    transform: scale(1.2);
  }
  #color-green { background-color: #34d399; }
  #color-blue { background-color: #3b82f6; }
  #color-purple { background-color: #8b5cf6; }
  #color-yellow { background-color: #f59e0b; }


  h2 { font-family: var(--font-header); color: var(--accent-primary); font-size: 28px; font-weight: 700; text-align: center; margin-bottom: 8px;}
  h3 { margin-bottom: 1rem; color: var(--text-secondary); border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; }
  .input-group { display: flex; flex-direction: column; gap: 8px; }
  .input-group label { font-size: 14px; font-weight: 500; color: var(--text-secondary); transition: color 0.3s ease, font-weight 0.3s ease; display: flex; align-items: center; gap: 8px; }

  .reseller-label {
    flex-direction: row;
    align-items: center;
    gap: 10px;
    cursor: pointer;
  }

  input[type="text"], input[type="number"], input[type="password"], input[type="date"], select {
    width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--bg-tertiary); color: var(--text-primary); font-size: 16px; transition: all 0.3s ease;
  }
  input[type="text"]:focus, input[type="number"]:focus, input[type="password"]:focus, input[type="date"]:focus, select:focus {
    outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px rgba(52, 211, 153, 0.3);
  }
  html[data-accent-color='blue'] input:focus { box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3); }
  html[data-accent-color='purple'] input:focus { box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.3); }
  html[data-accent-color='yellow'] input:focus { box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.3); }


  td input[type="number"] {
      padding: 8px;
      text-align: center;
      font-size: 15px;
  }

  #auth-error, #admin-action-status, #sub-reseller-action-status { color: var(--text-error); font-size: 14px; text-align: center; min-height: 20px; }
  #admin-action-status.success, #sub-reseller-action-status.success { color: var(--accent-primary); }

  .tab-navigation { 
    display: flex; 
    justify-content: center;
    flex-wrap: wrap; 
    border-bottom: 1px solid var(--border-color);
  }
  .tab-link { padding: 12px 20px; cursor: pointer; background: none; border: none; color: var(--text-secondary); font-weight: 600; font-size: 16px; border-bottom: 3px solid transparent; transition: all 0.3s ease; font-family: var(--font-body); white-space: nowrap; }
  .tab-link:hover { color: var(--text-primary); }
  .tab-link.active { color: var(--accent-primary); border-bottom-color: var(--accent-primary); }
  .tab-content { padding-top: 24px; display: flex; flex-direction: column; gap: 24px; }
  
  .mode-selector { display: flex; gap: 10px; background-color: var(--bg-tertiary); padding: 6px; border-radius: 10px; width: fit-content; flex-wrap: wrap; align-items: center; }
  .mode-selector label { padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; text-align: center; gap: 0; }
  .mode-selector input[type="radio"] { display: none; }
  .mode-selector input[type="radio"]:checked + label { background-color: var(--bg-secondary); color: var(--accent-primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

  .distributor-container { background-color: rgba(120, 120, 120, 0.05); border: 1px dashed var(--border-color); padding: 24px; border-radius: 12px; display: flex; flex-direction: column; gap: 20px; }
  .token-filters { display: flex; flex-wrap: wrap; gap: 12px 20px; }
  .token-filters label { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px; }
  .distributor-controls { display: flex; gap: 16px; align-items: center; }
  .distributor-controls .input-group { flex-grow: 1; }
  #leftover-mush { margin-top: 16px; font-weight: 500; color: var(--text-secondary); }
  #leftover-mush span { color: var(--accent-primary); font-weight: 700; }
  
  table { width: 100%; border-collapse: collapse; }
  th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border-color); transition: background-color 0.3s ease; }
  td:nth-child(n+2), th:nth-child(n+2) { text-align: center; }
  th { font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
  tbody tr:hover { background-color: rgba(120, 120, 120, 0.05); }
  tfoot td { border-bottom: none; }
  tfoot b { color: var(--accent-primary); }
  
  .buttons { display: flex; justify-content: center; gap: 12px; margin-top: 16px; flex-wrap: wrap;}
  button { padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: transform 0.15s ease, background-color 0.2s, color 0.2s, box-shadow 0.2s; border: none; display: inline-flex; align-items: center; justify-content: center; position: relative; }
  button:hover { transform: translateY(-2px) scale(1.02); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); }
  button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none;}
  
  #btnCalcular, #btnDistribute, #btnLogin, #history-apply-filter-btn, #btn-create-seller, #btn-create-sub-reseller, #btn-open-resale-modal { background: var(--accent-primary); color: #fff; }
  #btnCalcular:hover, #btnDistribute:hover, #btnLogin:hover, #history-apply-filter-btn:hover, #btn-create-seller:hover, #btn-load-users:hover, #btn-create-sub-reseller:hover, #btn-open-resale-modal:hover { background: var(--accent-hover); }

  #btnResetar { background: var(--accent-danger); color: var(--text-primary); }

  #btnGerarImagem, #btnLogout, #btnDistributeLeftover, #btn-prev-page, #btn-next-page, #export-txt-modal-btn, #cancel-txt-export-btn, .btn-view-receipt, #btn-load-my-resellers { background: var(--bg-tertiary); color: var(--text-primary); }

  .admin-section {
    padding: 20px;
    margin-bottom: 24px;
    border: 1px solid var(--border-color);
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  /* --- INÍCIO DAS MELHORIAS DE DESIGN --- */
  .container {
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2), 0 8px 10px -6px rgba(0, 0, 0, 0.2);
  }
  #btnCalcular, #btnDistribute, #btnLogin, #history-apply-filter-btn, #btn-create-seller, #generate-txt-file-btn, #btn-create-sub-reseller, #btn-open-resale-modal, #save-resale-prices-btn {
    background-image: linear-gradient(to right, var(--accent-primary) 0%, var(--accent-hover) 100%);
    background-size: 200% auto;
    transition: all 0.4s ease-in-out;
    border: none;
  }
  #btnCalcular:hover, #btnDistribute:hover, #btnLogin:hover, #history-apply-filter-btn:hover, #btn-create-seller:hover, #generate-txt-file-btn:hover, #btn-create-sub-reseller:hover, #btn-open-resale-modal:hover, #save-resale-prices-btn:hover {
    background-position: right center;
    background-color: var(--accent-hover);
  }
  .input-group:focus-within label {
    color: var(--accent-primary);
    font-weight: 600;
  }
  button:active {
    transform: translateY(1px) scale(0.98);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  #auth-container, .container {
    animation: fadeIn 0.5s ease-out forwards;
  }
  tbody tr:nth-child(odd) {
    background-color: rgba(120, 120, 120, 0.03);
  }
  tbody tr:hover {
    background-color: rgba(52, 211, 153, 0.1);
  }
  html[data-accent-color='blue'] tbody tr:hover { background-color: rgba(59, 130, 246, 0.1); }
  html[data-accent-color='purple'] tbody tr:hover { background-color: rgba(139, 92, 246, 0.1); }
  html[data-accent-color='yellow'] tbody tr:hover { background-color: rgba(245, 158, 11, 0.1); }

  .icon {
    width: 1.1em;
    height: 1.1em;
    margin-right: 0.5em;
    vertical-align: -0.2em;
  }
  label .icon {
    vertical-align: -0.25em;
  }
  th {
    letter-spacing: 0.8px;
    font-weight: 700;
  }
  .input-group {
    margin-bottom: 8px;
  }
  .tab-navigation {
    margin-bottom: 16px;
  }
  .tab-link {
    position: relative;
    top: 1px;
    margin-bottom: -1px;
  }
  #reseller-limit-status {
    text-align: center;
    border: 1px solid var(--border-color);
    font-size: 14px;
    padding: 8px;
    border-radius: 8px;
  }
  
  .btn-action {
    color: var(--text-primary) !important;
    padding: 6px 12px;
    font-size: 12px;
  }
  .btn-action.promote {
    background-color: var(--accent-primary);
  }
  .btn-action.promote:hover {
    background-color: var(--accent-hover);
  }
  .btn-action.attention {
    background-color: var(--accent-warning);
  }
  .btn-action.attention:hover {
    background-color: var(--accent-warning-hover);
  }
  .btn-action.demote, .btn-action.delete {
    background-color: var(--accent-danger);
  }
  .btn-action.demote:hover, .btn-action.delete:hover {
    background-color: var(--accent-danger-hover);
  }


  /* --- ESTILOS PARA O MODAL --- */
  .modal {
    position: fixed;
    z-index: 1001;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.3s ease;
  }
  .modal-content {
    background-color: var(--bg-secondary);
    padding: 24px;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    border: 1px solid var(--border-color);
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
  }
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 16px;
    margin-bottom: 16px;
  }
  .modal-header h3 {
    border-bottom: none;
    padding-bottom: 0;
    margin-bottom: 0;
    color: var(--text-primary);
  }
  .close-btn {
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    line-height: 1;
  }
  .close-btn:hover {
    color: var(--text-primary);
  }
  #customer-list-for-export {
    overflow-y: auto;
    flex-grow: 1;
    margin-bottom: 16px;
    padding-right: 8px;
  }
  #customer-list-for-export label {
    display: flex;
    align-items: center;
    padding: 10px;
    cursor: pointer;
    border-radius: 6px;
    transition: background-color 0.2s ease;
  }
  #customer-list-for-export label:hover {
    background-color: var(--bg-tertiary);
  }
  #customer-list-for-export input[type="checkbox"] {
    margin-right: 12px;
    width: 18px;
    height: 18px;
  }
  #customer-list-for-export .customer-info {
    display: flex;
    justify-content: space-between;
    width: 100%;
  }
  #customer-list-for-export .customer-total {
    color: var(--accent-primary);
    font-weight: bold;
  }
  .modal-controls {
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border-color);
    margin-bottom: 10px;
  }
  .modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    padding-top: 16px;
    margin-top: auto;
    border-top: 1px solid var(--border-color);
  }
  
  /* --- INÍCIO DAS MELHORIAS MOBILE --- */
  @media (max-width: 768px) {
    body {
      padding: 20px 10px;
    }
    .container {
      padding: 24px 16px;
    }
    h2 {
      font-size: 24px;
    }
    
    table thead {
      display: none;
    }
    table tr {
      display: block;
      margin-bottom: 1em;
      border-radius: 10px;
      border: 1px solid var(--border-color);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    table td {
      display: block;
      text-align: right;
      padding-left: 50%;
      position: relative;
      border-bottom: 1px dotted var(--border-color);
    }
    table td:last-child {
      border-bottom: none;
    }
    table td::before {
      content: attr(data-label);
      position: absolute;
      left: 12px;
      width: calc(50% - 24px);
      text-align: left;
      font-weight: 600;
      color: var(--text-secondary);
    }
    table td[data-label] div {
      width: 120px;
      margin: 0 0 0 auto;
    }
    tfoot td {
      padding-left: 12px;
      text-align: left;
    }
    tfoot td::before {
        display: none;
    }

    .buttons {
      flex-direction: column;
      gap: 16px;
    }
    .buttons button {
      width: 100%;
      padding: 12px;
      font-size: 16px;
    }

    #history-filter-bar {
      flex-direction: column;
      align-items: stretch;
    }
    #history-filter-bar .buttons {
        flex-direction: row;
        justify-content: space-around;
    }
    .settings-bar {
      flex-direction: column;
      gap: 16px;
      align-items: flex-start;
      justify-content: space-between;
    }
    .settings-bar .settings-controls {
      align-self: flex-end;
    }
    .modal-content {
      width: 95%;
      max-height: 85vh;
    }
  }

  @media (min-width: 769px) {
    body {
      padding: 60px 40px;
    }
    #app-container {
      max-width: 960px;
    }
    .container {
      padding: 40px;
      gap: 32px;
    }
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .tab-content > * {
      animation: fadeInUp 0.5s ease-out both;
    }
     .tab-content > *:nth-child(2) { animation-delay: 0.1s; }
     .tab-content > *:nth-child(3) { animation-delay: 0.2s; }

    .input-group {
      margin-bottom: 16px;
    }
    .input-group label {
      font-size: 15px;
      font-weight: 600;
    }
    .controls-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px 24px;
        align-items: flex-end;
    }
    .admin-section {
        background-color: var(--bg-primary);
        border: 1px solid var(--border-color);
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        max-width: 90%;
        margin-left: auto;
        margin-right: auto;
    }
    .distributor-container {
      background-color: var(--bg-primary);
      border: 1px solid var(--border-color);
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    table {
      border: 1px solid var(--border-color);
      border-radius: 12px;
      overflow: hidden;
      margin-top: 16px;
    }
    table th, table td {
      border-bottom: 1px solid var(--border-color);
      padding: 16px 20px;
    }
    table thead {
      background-color: var(--bg-primary);
      border-bottom: 2px solid var(--accent-primary);
    }
    table th {
      font-size: 14px;
      color: var(--text-primary);
    }
    table tbody tr:last-child td {
        border-bottom: none;
    }
    table tfoot {
        background-color: var(--bg-primary);
        border-top: 2px solid var(--border-color);
    }
    table tfoot td {
        font-size: 1.1em;
        font-weight: bold;
    }
    #totalGeral {
        font-size: 1.25em;
    }

    .buttons {
      justify-content: flex-end;
      gap: 16px;
    }
    #history-filter-bar .buttons {
        justify-content: center;
        width: 100%;
        grid-column: 1 / -1;
    }
    
    #btnResetar, #btnGerarImagem, #btnLogout {
        background: transparent;
        border: 2px solid var(--bg-tertiary);
        color: var(--text-secondary);
        background-image: none;
    }
    #btnResetar {
        border-color: var(--accent-danger);
        color: var(--accent-danger);
    }
    #btnResetar:hover {
        background-color: var(--accent-danger);
        color: white;
        transform: translateY(-2px) scale(1.02);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    #btnGerarImagem:hover, #btnLogout:hover {
        border-color: var(--accent-primary);
        color: var(--accent-primary);
        background-color: transparent;
    }
    
    /* --- INÍCIO DAS MODIFICAÇÕES PARA O HISTÓRICO --- */
    #history-view {
        display: flex;
        flex-direction: column;
        gap: 16px;
        min-height: 65vh; 
    }
    #history-filter-bar, 
    #history-selection-bar, 
    #history-pagination-controls {
        flex-shrink: 0; 
    }
    #history-table-wrapper {
        flex-grow: 1; 
        overflow-y: auto; 
        border: 1px solid var(--border-color);
        border-radius: 12px;
        background-color: var(--bg-primary);
    }
    #history-table-container table {
        border: none;
        margin-top: 0;
    }
    #history-table-container thead {
        position: sticky; 
        top: 0; 
        z-index: 10;
        background-color: var(--bg-secondary);
    }
    /* --- FIM DAS MODIFICAÇÕES PARA O HISTÓRICO --- */

    #history-pagination-controls {
        width: 100%;
        justify-content: center;
        margin-top: 24px;
        border-top: 1px solid var(--border-color);
        padding-top: 16px;
    }
  }
  
  .reseller-tag {
    display: inline-block;
    margin-left: 8px;
    padding: 3px 8px;
    font-size: 11px;
    font-weight: 700;
    border-radius: 6px;
    background-color: var(--accent-warning);
    color: #fff;
    vertical-align: middle;
    line-height: 1;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  html[data-theme='light'] .reseller-tag {
    color: var(--bg-secondary);
  }

  /* --- NOVOS ESTILOS PARA UX/UI --- */
  #notification-container {
    position: fixed;
    top: 80px;
    right: 20px;
    z-index: 2000;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .toast {
    padding: 16px 24px;
    border-radius: 8px;
    color: #fff;
    font-weight: 600;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    transform: translateX(120%);
    opacity: 0;
    transition: all 0.4s cubic-bezier(0.21, 1.02, 0.73, 1);
  }
  .toast.show {
    transform: translateX(0);
    opacity: 1;
  }
  .toast.success {
    background-color: var(--accent-primary);
  }
  .toast.error {
    background-color: var(--accent-danger);
  }

  #confirm-modal-confirm-btn {
    background: var(--accent-danger);
  }
  #confirm-modal-confirm-btn:hover {
    background: var(--accent-danger-hover);
  }

  .spinner-container, .empty-state-container {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 40px;
    min-height: 200px;
    color: var(--text-secondary);
    text-align: center;
  }
  .empty-state-container .icon {
    width: 48px;
    height: 48px;
    margin-bottom: 16px;
    opacity: 0.7;
  }
  .spinner {
    border: 5px solid var(--bg-tertiary);
    border-top: 5px solid var(--accent-primary);
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* --- NOVOS ESTILOS PARA MENU DE CONFIGURAÇÕES --- */
  #settings-toggle-btn {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--text-secondary);
    padding: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s ease;
  }
  #settings-toggle-btn:hover {
    color: var(--text-primary);
    background-color: var(--bg-tertiary);
  }
  #settings-toggle-btn .icon {
    width: 22px;
    height: 22px;
    margin: 0;
  }
  #settings-menu {
    position: absolute;
    top: calc(100% + 10px);
    right: 0;
    background-color: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    width: 260px;
    padding: 16px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    z-index: 1002;
    display: flex;
    flex-direction: column;
    gap: 20px;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px) scale(0.95);
    transform-origin: top right;
    transition: all 0.2s ease-out;
  }
  #settings-menu.active {
    opacity: 1;
    visibility: visible;
    transform: translateY(0) scale(1);
  }
  #settings-menu h4 {
    font-size: 12px;
    font-weight: 700;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.8px;
    margin: 0 0 12px 0;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border-color);
  }
  #settings-menu .language-switcher,
  #settings-menu .accent-color-switcher {
    padding-left: 8px;
  }
  
  /* --- NOVOS ESTILOS PARA SELEÇÃO EM MASSA --- */
  #history-table-container th:first-child,
  #history-table-container td:first-child {
      width: 40px;
      text-align: center;
      padding-right: 0;
  }
  #history-table-container input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
  }
  #history-selection-bar {
    background-color: var(--bg-secondary);
    border: 1px solid var(--accent-primary);
    border-radius: 12px;
    padding: 12px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 20px;
    margin-top: 16px;
    opacity: 0;
    transform: translateY(20px);
    visibility: hidden;
    transition: all 0.3s ease-out;
  }
  #history-selection-bar.active {
    opacity: 1;
    transform: translateY(0);
    visibility: visible;
  }
  #history-selection-count {
    font-weight: 600;
    color: var(--text-primary);
  }
  #history-selection-actions {
    display: flex;
    gap: 12px;
  }
  #history-selection-actions button {
    padding: 8px 16px;
  }

  /* --- NOVOS ESTILOS PARA RECIBO PNG --- */
  #receipt-generator-container {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    align-items: center;
    justify-content: center;
    z-index: 1002;
    background-color: rgba(0,0,0,0.5);
  }
  .receipt-body {
      background-color: var(--bg-secondary);
      color: var(--text-primary);
      font-family: var(--font-body);
      width: 450px;
      padding: 25px;
      border: 1px solid var(--border-color);
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  }
  .receipt-header h2 {
      font-family: var(--font-header);
      font-size: 26px;
      color: var(--accent-primary);
      margin-bottom: 5px;
  }
  .receipt-header p {
      text-align: center;
      color: var(--text-secondary);
      font-size: 14px;
      margin-bottom: 2px;
  }
  .receipt-header .receipt-id {
      font-family: var(--font-mono);
      font-size: 12px;
      margin-top: 10px;
      margin-bottom: 20px;
  }
  .receipt-section-title {
      font-weight: 700;
      color: var(--text-secondary);
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px dashed var(--border-color);
      padding-bottom: 6px;
      margin: 20px 0 10px 0;
  }
  .receipt-items-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
  }
  .receipt-items-table th {
      text-align: left;
      padding: 8px 2px;
      color: var(--text-secondary);
      font-weight: 500;
  }
  .receipt-items-table td {
      padding: 6px 2px;
      border-bottom: 1px solid var(--bg-primary);
  }
  .receipt-items-table td:nth-child(2),
  .receipt-items-table td:nth-child(3),
  .receipt-items-table th:nth-child(2),
  .receipt-items-table th:nth-child(3) {
      text-align: right;
      font-family: var(--font-mono);
  }
  .receipt-totals {
      margin-top: 20px;
      padding-top: 10px;
      border-top: 1px solid var(--border-color);
      font-size: 14px;
  }
  .receipt-totals div {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
      padding: 2px 0;
  }
  .receipt-totals .final-total {
      font-size: 18px;
      font-weight: 700;
      color: var(--accent-primary);
      margin-top: 10px;
      border-top: 1px dashed var(--border-color);
      padding-top: 10px;
  }
  .receipt-totals .final-total span:first-child {
      color: var(--text-primary);
  }
  .receipt-footer {
      text-align: center;
      margin-top: 25px;
      font-size: 12px;
      color: var(--text-secondary);
  }
  .coin-icon {
      width: 1em;
      height: 1em;
      vertical-align: -0.125em;
      margin-left: 4px;
  }

  /* --- ESTILOS DO NOVO DASHBOARD --- */
  .dashboard-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
      margin-bottom: 32px;
  }
  .stat-card {
      background-color: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: all 0.3s ease;
  }
  .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      border-color: var(--accent-primary);
  }
  .stat-card h4 {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin: 0;
      padding: 0;
      border-bottom: none;
  }
  .stat-card .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 12px;
      line-height: 1.2;
  }
  .stat-card .stat-value .icon {
      width: 28px;
      height: 28px;
      color: var(--accent-primary);
      margin: 0;
  }
  .stat-card .stat-subtitle {
      font-size: 14px;
      color: var(--text-secondary);
      margin-top: auto;
  }
  #top-customer-value b, #top-seller-value b {
      color: var(--accent-primary);
      font-weight: 700;
  }

  /* --- NOVOS REFINAMENTOS VISUAIS E DE LAYOUT --- */
  .buttons-center {
      justify-content: center;
  }
  .discounted-price-col {
    display: none;
  }
  table.show-discount .discounted-price-col {
    display: table-cell;
  }
  .discounted-price-value {
    color: var(--text-secondary);
    font-style: italic;
    font-family: var(--font-mono);
  }
  /* --- ESTILOS PARA TELA CHEIA (FULL-SCREEN UX - 1200px+) --- */
  @media (min-width: 1200px) {
      body { padding: 40px; }
      #app-container { max-width: 90vw; }
      .container { padding: 48px; }
      #calculator-view {
        display: grid;
        grid-template-columns: minmax(450px, 1.2fr) 2fr;
        grid-template-areas: "controls results";
        align-items: start;
        gap: 40px;
      }
      #calculator-controls {
          grid-area: controls;
          display: flex;
          flex-direction: column;
          gap: 24px;
      }
      #calculator-results {
          grid-area: results;
          position: sticky;
          top: 40px;
          gap: 24px;
          display: flex;
          flex-direction: column;
      }
      #dashboard-view .chart-container {
        grid-template-columns: 1fr 1fr;
        gap: 40px;
      }
      #history-filter-bar {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 16px 24px;
          align-items: end;
      }
      #history-filter-bar .buttons {
          grid-column: 1 / -1;
          justify-content: center;
          margin-top: 16px;
      }
      table tfoot td:first-child {
        colspan: 3;
      }
      table.show-discount tfoot td:first-child {
        colspan: 4;
      }
  }

  /* --- REFINAMENTOS VISUAIS PARA DESKTOPS GRANDES (1440px+) --- */
  @media (min-width: 1440px) {
      body { padding: 40px 60px; }
      #app-container { max-width: 1600px; }
      .container { padding: 32px 40px; }
      .panel {
          background-color: var(--bg-primary);
          border: 1px solid var(--border-color);
          border-radius: 12px;
          padding: 24px;
          display: flex;
          flex-direction: column;
          gap: 20px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      }
      .panel h2, .panel h3 {
          margin-bottom: 0;
          text-align: left;
          border-bottom: 1px solid var(--border-color);
          padding-bottom: 12px;
      }
      .panel .input-group { margin-bottom: 0; }
      #calculator-controls { gap: 32px; }
      .control-section {
          display: flex;
          flex-direction: column;
          gap: 12px;
      }
      .control-section:not(:last-child) {
          padding-bottom: 16px;
          border-bottom: 1px dashed var(--border-color);
      }
      .distributor-container.panel {
        background-color: var(--bg-primary);
        border: 1px solid var(--border-color);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        padding: 24px;
      }
      #calculator-results table { margin-top: 0; }
      
      #history-table-container th {
        padding: 14px 16px;
      }
      #history-table-container td {
        padding: 12px 16px;
        font-size: 14px;
      }
      #history-pagination-controls {
          margin-top: 0;
      }
      #history-table-container .btn-view-receipt,
      #history-table-container .delete-history-btn {
          background: transparent;
          border: none;
          color: var(--text-secondary);
          padding: 4px;
          box-shadow: none;
      }
      #history-table-container .btn-view-receipt:hover,
      #history-table-container .delete-history-btn:hover {
          background-color: var(--bg-tertiary);
          color: var(--text-primary);
      }
  }

</style>
</head>
<body>

<!-- SVG Icons -->
<svg width="0" height="0" style="position:absolute">
  <symbol id="icon-user" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></symbol>
  <symbol id="icon-crown" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m2 4 3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"></path></symbol>
  <symbol id="icon-calculator" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect><line x1="8" y1="6" x2="16" y2="6"></line><line x1="16" y1="14" x2="8" y2="14"></line><line x1="16" y1="18" x2="8" y2="18"></line><line x1="12" y1="10" x2="12" y2="22"></line></symbol>
  <symbol id="icon-team" viewBox="0 0 20 20" fill="currentColor"><path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 15v-3a2 2 0 00-2-2H6a2 2 0 00-2 2v3h12z" /></symbol>
  <symbol id="icon-discount" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-7-7A.997.997 0 012 10V5a1 1 0 011-1h5a1 1 0 01.707.293l7 7zM5 6a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></symbol>
  <symbol id="icon-reset" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></symbol>
  <symbol id="icon-image" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" /></symbol>
  <symbol id="icon-login" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 011-1v12a1 1 0 11-2 0V4a1 1 0 011-1zm7.707 3.293a1 1 0 010 1.414L9.414 9H17a1 1 0 110 2H9.414l1.293 1.293a1 1 0 01-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0z" clip-rule="evenodd" /></symbol>
  <symbol id="icon-export" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></symbol>
  <symbol id="icon-receipt" viewBox="0 0 20 20" fill="currentColor"><path d="M4 2a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V4a2 2 0 00-2-2H4zm0 2h12v3H4V4zm0 5h12v2H4V9zm0 4h12v2H4v-2z" /></symbol>
  <symbol id="icon-gear" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></symbol>
  <symbol id="icon-empty" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></symbol>
</svg>

<div id="auth-container">
    <h2 data-translate-key="loginHeader">Login</h2>
    <div class="input-group">
        <label for="username-input" data-translate-key="usernameLabel">Usuário</label>
        <input type="text" id="username-input" autocomplete="username">
    </div>
    <div class="input-group">
        <label for="password-input" data-translate-key="passwordLabel">Senha</label>
        <input type="password" id="password-input" autocomplete="current-password">
    </div>
    <p id="auth-error"></p>
    <button id="btnLogin" data-translate-key="loginButton"><svg class="icon"><use xlink:href="#icon-login"></use></svg>Entrar</button>
</div>

<div id="app-container" class="hidden">
    <div class="container">
      <div class="settings-bar">
          <div id="logged-in-user"></div>
          <div class="settings-controls">
              <div class="theme-switcher">
                  <span class="theme-switcher-label" data-translate-key="themeLabel"></span>
                  <div class="toggle-track" id="theme-toggle">
                      <div class="toggle-thumb"></div>
                  </div>
              </div>
              <button id="settings-toggle-btn" title="Configurações">
                <svg class="icon"><use xlink:href="#icon-gear"></use></svg>
              </button>
              <div id="settings-menu">
                <div>
                  <h4>Idioma</h4>
                  <div class="language-switcher">
                    <button id="lang-br">🇧🇷</button>
                    <button id="lang-en">🇺🇸</button>
                  </div>
                </div>
                <div>
                  <h4>Cor de Destaque</h4>
                  <div class="accent-color-switcher" id="accent-color-switcher">
                    <div class="color-box" id="color-green" data-color="green" title="Verde"></div>
                    <div class="color-box" id="color-blue" data-color="blue" title="Azul"></div>
                    <div class="color-box" id="color-purple" data-color="purple" title="Roxo"></div>
                    <div class="color-box" id="color-yellow" data-color="yellow" title="Amarelo"></div>
                  </div>
                </div>
              </div>
              <button id="btnLogout" data-translate-key="logoutButton">Sair</button>
          </div>
      </div>

      <div class="tab-navigation">
          <button class="tab-link" data-tab="calculator-view" data-translate-key="tabCalculator">Calculadora</button>
          <button class="tab-link" data-tab="history-view" data-translate-key="tabHistory">Histórico</button>
          <button class="tab-link" data-tab="dashboard-view">Dashboard</button>
          <button class="tab-link" data-tab="reseller-panel-view" style="display: none;">Meus Vendedores</button>
          <button class="tab-link" data-tab="admin-view" style="display: none;">Administração</button>
      </div>
      
      <div id="calculator-view" class="tab-content">
        <div id="calculator-controls">
            <div class="panel">
                <h2 data-translate-key="mainHeader">Calculadora de Tokens</h2>
                <div class="controls-grid">
                    <div class="input-group" id="customer-name-container">
                        <label for="nomeCliente" data-translate-key="idLabel"><svg class="icon"><use xlink:href="#icon-user"></use></svg>Identificador / Nome do Cliente</label>
                        <input type="text" id="nomeCliente" data-translate-key-placeholder="idPlaceholder">
                    </div>
                    <div class="input-group hidden" id="reseller-customer-selection-container">
                        <label for="reseller-customer-select" data-translate-key="resellerCustomerLabel"><svg class="icon"><use xlink:href="#icon-user"></use></svg>Cliente Revendedor</label>
                        <select id="reseller-customer-select"></select>
                        <input type="text" id="reseller-customer-manual-input" class="hidden" data-translate-key-placeholder="resellerCustomerManualPlaceholder">
                    </div>
                    <div class="input-group">
                        <label for="desconto" data-translate-key="discountLabel"><svg class="icon"><use xlink:href="#icon-discount"></use></svg>Desconto (%)</label>
                        <input type="number" id="desconto" data-translate-key-placeholder="discountPlaceholder" min="0" max="100">
                    </div>
                </div>
            </div>
            <div class="panel">
                <h3>Modos de Operação</h3>
                <div class="input-group">
                    <label data-translate-key="calculationMode">Modo de Cálculo</label>
                    <div class="mode-selector">
                        <input type="radio" id="mode-qty" name="calculation-mode" value="quantity" checked>
                        <label for="mode-qty" data-translate-key="modeQty">Por Quantidade</label>
                        <input type="radio" id="mode-mush" name="calculation-mode" value="mush">
                        <label for="mode-mush" data-translate-key="modeMush">Por Mush</label>
                    </div>
                </div>
                <div class="control-section">
                    <div class="input-group hidden" id="reseller-mode-container">
                        <label class="reseller-label"><input type="checkbox" id="reseller-mode-toggle">Modo Revendedor</label>
                    </div>
                    <div class="input-group" id="custom-resale-mode-container">
                        <label class="reseller-label"><input type="checkbox" id="custom-resale-toggle"><span data-translate-key="customResaleModeLabel">Modo Revenda (Preços Personalizados)</span></label>
                    </div>
                     <button id="btn-open-resale-modal" data-translate-key="resalePricesBtn">Definir Preços de Revenda</button>
                </div>
                <div id="reseller-limit-status" class="hidden"></div>
            </div>
            <div class="distributor-container panel" id="distributor-section" style="display: none;">
                <h3>Distribuidor de Mush</h3>
                <div class="input-group">
                    <label for="total-mush" data-translate-key="totalMushLabel">Total de Mush a Gastar</label>
                    <input type="number" id="total-mush" placeholder="30000">
                </div>
                 <div class="token-filters" id="token-filters-container"></div>
                <div id="two-token-options" class="hidden" style="margin-top: 10px;">
                    <label>Estratégia para 2 tokens:</label>
                    <div class="mode-selector">
                        <input type="radio" id="strategy-fair" name="two-token-strategy" value="fair" checked><label for="strategy-fair">Justa (Padrão)</label>
                        <input type="radio" id="strategy-split" name="two-token-strategy" value="split"><label for="strategy-split">Dividir 50/50</label>
                    </div>
                </div>
                <div class="buttons" style="justify-content:center; margin-top:0;">
                     <button id="btnDistribute" data-translate-key="btnDistribute">Distribuir</button>
                </div>
                <div id="leftover-mush"></div>
                <div id="leftover-distributor-section" class="hidden" style="margin-top: 15px; border-top: 1px dashed var(--border-color); padding-top: 15px;">
                    <label>Distribuir o troco para:</label>
                    <div class="token-filters" id="leftover-token-filters-container"></div>
                    <div class="buttons" style="margin-top: 10px;"><button id="btnDistributeLeftover">Distribuir Troco</button></div>
                </div>
            </div>
        </div>
        <div id="calculator-results">
            <table id="calculator-table">
                <thead>
                    <tr>
                        <th data-translate-key="tableItem">Item</th>
                        <th data-translate-key="tablePrice">Preço Unitário</th>
                        <th class="discounted-price-col">Preço c/ Desc.</th>
                        <th data-translate-key="tableQty">Quantidade</th>
                        <th data-translate-key="tableTotal">Valor Total</th>
                    </tr>
                </thead>
                <tbody id="tabela-itens"></tbody>
                <tfoot>
                    <tr>
                        <td><b data-translate-key="tableGrandTotal">TOTAL GERAL</b></td>
                        <td id="totalGeral" style="text-align: center;"><b>0,00</b></td>
                    </tr>
                </tfoot>
            </table>
            <div class="buttons buttons-center">
                <button id="btnCalcular" data-translate-key="btnCalculate"><svg class="icon"><use xlink:href="#icon-calculator"></use></svg>Calcular</button>
                <button id="btnResetar" data-translate-key="btnReset"><svg class="icon"><use xlink:href="#icon-reset"></use></svg>Resetar</button>
                <button id="btnGerarImagem" data-translate-key="btnExport"><svg class="icon"><use xlink:href="#icon-image"></use></svg>Exportar para PNG</button>
            </div>
        </div>
      </div>
      
      <div id="history-view" class="tab-content hidden">
          <h2 data-translate-key="historyHeader">Histórico de Vendas</h2>
          <div class="input-group" style="align-items: center; margin-bottom: 20px;">
              <label>Visualizar:</label>
              <div class="mode-selector" style="margin: 0 auto;">
                  <input type="radio" id="history-view-all" name="history-view-mode" value="all" checked>
                  <label for="history-view-all">Todas as Vendas</label>
                  <input type="radio" id="history-view-summary" name="history-view-mode" value="summary">
                  <label for="history-view-summary">Resumo por Cliente</label>
                  <div id="history-view-team-container">
                    <input type="radio" id="history-view-team" name="history-view-mode" value="team">
                    <label for="history-view-team">Minha Equipe</label>
                  </div>
              </div>
          </div>
          <div id="history-filter-bar" style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap; margin-bottom: 20px; padding: 15px; border: 1px solid var(--border-color); border-radius: 12px;">
              <div class="input-group" style="flex-grow: 1;">
                  <label for="history-search-input">Buscar por Nome</label>
                  <input type="text" id="history-search-input" placeholder="Digite o nome do cliente...">
              </div>
              <div class="input-group">
                  <label for="history-sale-type-filter">Tipo de Venda</label>
                  <select id="history-sale-type-filter">
                      <option value="all">Todas as Vendas</option>
                      <option value="regular">Vendas Normais</option>
                      <option value="reseller">Apenas Revendedores</option>
                  </select>
              </div>
              <div class="input-group">
                  <label for="history-date-start">Data Início</label>
                  <input type="date" id="history-date-start">
              </div>
              <div class="input-group">
                  <label for="history-date-end">Data Fim</label>
                  <input type="date" id="history-date-end">
              </div>
              <div class="input-group hidden" id="history-seller-filter-container">
                  <label for="history-seller-filter">Filtrar por Vendedor</label>
                  <select id="history-seller-filter"></select>
              </div>
              <div class="buttons" style="margin-top:0;">
                <button id="history-apply-filter-btn">Aplicar Filtros</button>
                <button id="export-txt-modal-btn"><svg class="icon"><use xlink:href="#icon-export"></use></svg>Exportar TXT</button>
              </div>
          </div>
          <div id="history-selection-bar">
            <span id="history-selection-count">0 itens selecionados</span>
            <div id="history-selection-actions" class="buttons">
              <button id="btn-bulk-download">Baixar PNGs</button>
              <button id="btn-bulk-delete" class="btn-action delete">Excluir</button>
            </div>
          </div>
          <div id="history-table-wrapper">
              <div id="history-table-container">
              </div>
          </div>
          <div id="history-pagination-controls" class="buttons hidden">
              <button id="btn-prev-page">Anterior</button>
              <span id="page-number-display" style="align-self: center; font-weight: 500;"></span>
              <button id="btn-next-page">Próxima</button>
          </div>
      </div>

      <div id="dashboard-view" class="tab-content hidden">
          <h2>Dashboard de Vendas</h2>
          <div class="dashboard-stats-grid">
              <div class="stat-card" id="total-sales-card">
                  <h4>Meu Faturamento Total</h4>
                  <div class="stat-value">
                      <svg class="icon"><use xlink:href="#icon-calculator"></use></svg>
                      <span id="total-sales-value">--</span>
                  </div>
                  <p class="stat-subtitle">Soma de todas as suas vendas</p>
              </div>
              <div class="stat-card" id="top-customer-card">
                  <h4>Meu Top Cliente</h4>
                  <div class="stat-value">
                      <svg class="icon"><use xlink:href="#icon-crown"></use></svg>
                      <span id="top-customer-name">--</span>
                  </div>
                  <p id="top-customer-value" class="stat-subtitle">Nenhuma venda registrada</p>
              </div>
              <div class="stat-card hidden" id="top-seller-card">
                  <h4>Top Vendedor Geral</h4>
                  <div class="stat-value">
                      <svg class="icon"><use xlink:href="#icon-user"></use></svg>
                      <span id="top-seller-name">--</span>
                  </div>
                  <p id="top-seller-value" class="stat-subtitle">Calculando...</p>
              </div>
          </div>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px;">
              <div class="chart-container" style="padding: 20px; background-color: var(--bg-primary); border-radius: 12px;">
                  <h3 style="text-align: center; margin-bottom: 15px;">Vendas por Dia</h3>
                  <canvas id="sales-over-time-chart"></canvas>
              </div>
              <div class="chart-container" style="padding: 20px; background-color: var(--bg-primary); border-radius: 12px;">
                  <h3 style="text-align: center; margin-bottom: 15px;">Tokens Mais Vendidos</h3>
                  <canvas id="tokens-sold-chart"></canvas>
              </div>
          </div>
      </div>

      <div id="reseller-panel-view" class="tab-content hidden">
        <h2>Gerenciar Meus Vendedores</h2>
        <div id="sub-reseller-action-status"></div>
        <div class="admin-section" id="add-sub-reseller-section">
            <h3>Adicionar Novo Sub-revendedor</h3>
            <div class="input-group">
                <label for="new-sub-reseller-username">Usuário do Sub-revendedor</label>
                <input type="text" id="new-sub-reseller-username" placeholder="Ex: novo.sub.revendedor">
            </div>
            <div class="input-group">
                <label for="new-sub-reseller-password">Senha Provisória</label>
                <input type="password" id="new-sub-reseller-password" placeholder="Mínimo 6 caracteres">
            </div>
            <div class="buttons" style="justify-content: flex-start;">
                <button id="btn-create-sub-reseller">Criar Sub-revendedor</button>
            </div>
        </div>
        <div class="admin-section">
            <h3>Lista de Vendedores</h3>
            <div class="buttons" style="justify-content: flex-start;">
                <button id="btn-load-my-resellers">Carregar Lista</button>
            </div>
            <div id="sub-reseller-list-container" style="margin-top: 16px;">
            </div>
        </div>
      </div>
      
      <div id="admin-view" class="tab-content hidden">
        <h2>Administração e Gestão</h2>
        <div id="admin-action-status"></div>
        <div class="admin-section">
            <h3>Adicionar Novo Vendedor</h3>
            <div class="input-group">
                <label for="new-seller-username">Usuário do Vendedor</label>
                <input type="text" id="new-seller-username" placeholder="Ex: novo.vendedor">
            </div>
            <div class="input-group">
                <label for="new-seller-password">Senha Provisória</label>
                <input type="password" id="new-seller-password" placeholder="Mínimo 6 caracteres">
            </div>
            <div class="buttons" style="justify-content: flex-start;">
                <button id="btn-create-seller">Criar Vendedor</button>
            </div>
        </div>
        <div class="admin-section">
            <h3>Lista de Usuários</h3>
            <div class="buttons" style="justify-content: flex-start;">
                <button id="btn-load-users">Carregar Lista de Usuários</button>
            </div>
            <div id="user-list-container" style="margin-top: 16px;">
            </div>
        </div>
      </div>

    </div>
</div>

<div id="receipt-generator-container"></div>
<div id="txt-export-modal" class="modal hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Exportar Relatório de Clientes</h3>
      <button class="close-btn" id="close-txt-export-modal">&times;</button>
    </div>
    <div class="modal-controls">
      <label>
        <input type="checkbox" id="select-all-customers-checkbox">
        Selecionar Todos
      </label>
    </div>
    <div id="customer-list-for-export"></div>
    <div class="modal-footer">
      <button id="cancel-txt-export-btn">Cancelar</button>
      <button id="generate-txt-file-btn">Gerar .TXT</button>
    </div>
  </div>
</div>
<div id="resale-price-modal" class="modal hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h3 data-translate-key="resaleModalHeader">Definir Preços de Revenda</h3>
      <button class="close-btn" id="close-resale-modal-btn">&times;</button>
    </div>
    <div class="modal-body" style="display: flex; flex-direction: column; gap: 16px; margin: 16px 0;">
        <p data-translate-key="resaleModalDesc" style="color: var(--text-secondary); font-size: 14px;">
            Estes preços serão usados quando o "Modo Revenda" estiver ativo. Para editar, use este modal.
        </p>
        <div class="input-group">
            <label for="resale-price-revive">Revive Token</label>
            <input type="number" id="resale-price-revive" placeholder="Preço de revenda do Revive">
        </div>
        <div class="input-group">
            <label for="resale-price-max">Max Growth Token</label>
            <input type="number" id="resale-price-max" placeholder="Preço de revenda do Max">
        </div>
        <div class="input-group">
            <label for="resale-price-partial">Partial Growth Token</label>
            <input type="number" id="resale-price-partial" placeholder="Preço de revenda do Partial">
        </div>
        <div class="input-group">
            <label for="resale-price-change">Appearance Change Token</label>
            <input type="number" id="resale-price-change" placeholder="Preço de revenda do Change">
        </div>
    </div>
    <div class="modal-footer">
      <button id="cancel-resale-prices-btn" data-translate-key="cancelButton">Cancelar</button>
      <button id="save-resale-prices-btn" data-translate-key="saveButton">Salvar</button>
    </div>
  </div>
</div>
<div id="notification-container"></div>
<div id="confirm-modal" class="modal hidden">
  <div class="modal-content" style="max-width: 450px;">
    <div class="modal-header">
      <h3 id="confirm-modal-title">Confirmar Ação</h3>
      <button class="close-btn" id="confirm-modal-close-btn">&times;</button>
    </div>
    <p id="confirm-modal-body" style="margin: 24px 0; line-height: 1.6;"></p>
    <div class="modal-footer">
      <button id="confirm-modal-cancel-btn">Cancelar</button>
      <button id="confirm-modal-confirm-btn">Confirmar</button>
    </div>
  </div>
</div>

<script>
  // --- INICIALIZAÇÃO DO FIREBASE ---
  const firebaseConfig = {
    apiKey: "AIzaSyDgeTU4YmFpZIwcmE2-cxGKTkO2KqeQotE",
    authDomain: "token-calculator-a45d6.firebaseapp.com",
    projectId: "token-calculator-a45d6",
    storageBucket: "token-calculator-a45d6.firebasestorage.app",
    messagingSenderId: "597974335563",
    appId: "1:597974335563:web:9d07ada2708d61b7d30dce"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();
  const functions = firebase.app().functions('us-central1');

  // --- LÓGICA DA APLICAÇÃO ---
  const MOEDA_BASE64 = "data:image/webp;base64,UklGRtQNAABXRUJQVlA4TMcNAAAvTQANEA0waCRJUfp6nv/9Cz54MhDR/wngl+sdBZIhpSLJHVlD0tHNosuGB0mlLoc1QAqgbBzQkFJtcDFqpz47vx+4qm1bVdYDAjDIQf8MpHCHK0+u3/OHQwG3kSQpUt7dM0tMK73/Br3MNPFMghvbttXklMH/DEiJu82/YwQuD3eIe7L6PwHg16eUgLcBM9D5846QNiwTc3FxzssaryGhlZmruT8CAAx1NqTGGq84Bp2zOp5UBADgqOIv16X0IyhkT4qgJ+Yq9F70XgDAwUNdb8eKvxefGz2SPOK/KCEmvuf9T50FAllgjTVapIqbWm5qje5SjZac96IiIYBA1gCscXCcNly1MtI/TEPutjiS41/WjCPS3eCqCEXUQoU2gvYattcgTAlJk2ERAECHmaqTuERKvQnOaSb5TGrbuR59Eq7LFn3o6eAxPcDfGjxv235I0rZt+xERGeksV7b7tG3bNmbn9Bz7HOu/8Hletm3bRhtpZ/B37Ceyi+foHP2SrrVtjiPl/avayI4WNLj13u+meEJiIlIugkM+t8E1kHvvybyHseu1rTE6akld1fX/lCPJVm071b3WOfehmJlp+u2QE+gATT9/HyRz5IBmzAyf8b779zlr0YFt27RttX19n23btm3btt/LrMi2FTl7mW3b/jau794M3DZS5GU4xjcAAvsRZDiJp/JUhqNkkrmv0Xn8+PCoLiDtw+JCnsprLhws948zY/b4SGQWWKXCrDVDqM/WyD3abfvX7//NA0Sb7wTIu3X0wIqz8563s4fh87ek42GUHdm1hauqK37dHPk6+yRtdSb7gsAZ2dpuOP1w3MMfZG+uyyH5hNXllAfr4VzdOnRs9oXXcejURnC475q9y65p/vaX8sgvj08q/cu8ptT8ZE93Y0A9cmLtnT9L4iYCHYwXy6bF9YpOu7BTFNvN8MD2UL2PQwE6tyWwOEStKJ31rWJ3a4ahBFxkz4+Tv30SfyYzZg/GJG6aCzkVX1jfdLjoegULgyAYxbZSrt4cFh6jTQOFJBhECoB1QR6UQJl28KfZqOmcRkk2aQ1CbgSb4zrIVbv+ysOdTzc3K6kVAnXYKsW737gy6a2O3RUBWTAPfBecPBJST3wa5w7YOBNsBkBw2oUXPjzsbpULKDFNDQL+n8LIm3isvDcOCMuhR0Azo8tcTowyD2+cCTbY/VAEwN6QDioEiRufffrQ8y++7IpeuKyH/7fy7R56p4ECACsDAg3mh/LKO+957o2PiUacF9SoQQUbCvCLtYD3xWmNYFrgtS/94K2vxNOgVciMi/d0A2W1BDM3hIs+x5NFaofBN4lSxHpJeZeIaIOr5fnYrLPkbx/xY8mMLwNiQbOrJask2Skv/BdOLoKjyNCunpdShJsofPAkCRsqCzDdqVWPqlZFAGhr2B0SgKgm/Xn16tsfCYpBsKizgG9nL9spLUliVKmkacn9vJsACDYMYH5huoTNO+a3qWQCYFcHRAkCgLgOC81pSbYwHoYWJLDA9rPtG6F9blEZXiAlL75x4fFTcRulSH4Z7e0MK6sCFyFp8M8bdhZIZuDAGsmCKlHDSqNEKCIAAF3bo5Itz1EA2lQRuhboZH/Y+HiDX9ekD3suXX7wU86N6czgP51qsf8f8xPmAaT5HjeXDzv5SWhClGEA7vok8edkQlhhf95LFNMQ6C06Jg09TbyIA4AlEIKtWfoME4w2ieNeFB253HgdJGLjTMz63docb8oupHFH0mhzDXKU4qVf/bKy7WXyihJLSygq8uK7Hzjh8+TM0oSJ+wAadPMRJ7Io/WlpE5p9q+s5rsPEngwKfGqY/vPqpLJ2W3jMyUEvWzd5Yt8p739RYL0VT6iSazHeHJqblqXNCVIJw1yQzvIyGIoKAArAFhFJaWKUCIC11g1p5797Hp/+64nVTd7h7F/H8ab73O2kS58wHwDYnE2q7piMj+XX71ioh+Zka8+dO+kDz7+m0d+ivIb3AmwQsx6Anj5BDkrjn2aQvEiOhi72TjHXPc8gEwuKNJhMoMgHMk3YsZOu4F+7dSEphD38ZrxneS6Xmy0bROWHvV/1e1sFF1Iv812Z786E1qyHQ2dx+Fnpwb9a8ystVp/xB3HrkMGbMwu07odoLllQFFBWHGA8k3J5gUEm9mOgZlxZYZcEEBuHPUc7lxxkZnIAGXbAZJWF5IOgxe9P/yQY3VFxkjUB0uxJgIyTDbupO0hjH5JUtOxc6tfMv0P22rmKYIr+fAbgIT4t6uwcaATxvLzMBPlAKGj5Ic0XK03RXEZD7FvbM+qKYjSBgGaajEmAcLyFsgyxBjIQDJFoiWRuaUwmBVgQX+BFPAmOZW68R7g2dzdHmyg9z1jQFMZVIOZQHCCyCo8bHsiljWzNzzGuxR7ve+C6ZfdgwowmxwLN60pmDcgbAQUwAChgMkctF0MpFpq13UYYzTSS1il/MJldmo85akOXDvdATUKiV5rXHvVdEyg3VWC8sAiSmSEogdhUfDHXgEZKEzmtexacAIQu9BRHQltKIjOQCbHJaUAsrNEEgAAGIgACmExScJNJsBRLMBMlncrsrOyscfJKqtLUw83RJ32JpJbEtXjV/2v/sfJrAThhhHT1gAOcEBNmTrMhmgBA4cmCbjj42LKc1eOcTlG60o6A/9LipUyuEwgAMaZg4kytUQXAQhoFAKBpm6CBCekK8RGcsrhRtv1WLo64uC/bvbRF2rRFMWP4cROivrl+FQczi3EeEKzuzubwrIFEDiw7gOuKMUtTWF6E0w9SbgIAi2IFj2Akv6vl36V0CzGD4PVDZpiENjFjCoRqmkxbM+1EaQAWJmIAsGzB1ggAtAV+GbbGyZbaTjmcnZDZ9kwCcBiZd1gWo6DfhsPX0bveYguD1fbj6smAJCvo2/JVmTsL0Do2S6azG5ztHtjydjjmEaaJBSBirQAAdUKESaZqaUoVGCwRCChGsykAEWtWzW9TKWDX3mU3Kip56Dv0k6QmCRISturKBYUgaWZXL2bObKZRNJZVvwOpcCQu4YywcMGyfYlBjEQEHNm5q1IdhIQAxFoASwTIFEDA+zMAgBiEBqqoChEIAKwYiMEAQDUmA9AWGqw4KZdV7SwJ28qJevm/wzLSTtJXRJQRraBWCUGQKDcYCgeT/j1hTbRa+m7x+8nByFFmJDPdwQPAckiBoFhiKZmCTUt6gYTpdOIqAVggVjUxCc3UoCYwUAQGAEsRGKZMgAIGKjS07CHKOzsPFbPzu8k4/E9LzbWKoAlikUjQM4zE5mJyTfpm/wnymi3+u4v6b6S7UscB4SqWJhremu5JNLgJeZGS2JyIVcwmhNCCh4gIEEr4gNCIEKMK1TQFOyUCAw0EABYGqDBBI7QBEW1FQwg277r9QdCunVwglfaX1JrWPCdDkww4GkNKSARtgDYcDfbNGb5f7Xz//k59dyjl+q+quWu1TOZL7079GSnE1WBADIxBAYAAYilwEcHUwSCJAwGAADiBCpGpEqYAlgY6szChEwKVQBWNE7am0dImeLuXnfHgqtuGhxp5IlDaf7x0BVVDVWwWKYtkU4jFEtBI6ed9+02/1RcYTZUxC/8g8K9zRCVs/Bqs4u7m+GxzeTcul19kylBfk16NKIIYpAGIg5Mhk8N1RgFUBIk91AEKEVBMAMVUA2gwURdgAIAJESWkwdIgbi4AGi2pQ7JrJ+6W+9YOzeThT4KWBA9UxbYr5pG+SANM50Cq4c+GH9L+GdGuZXwkkvT/jOiHnHDyV28+e2XVP6Pr9DBsxqHRu+iPctq/j0QbgQEAvjmFuD04HRGPIEiSxKgoIgJxBQLXFzdbmZiUJA7EACxVICDGVphERdIVTGpGToz+tZ0P5W4vXiH7BV1woaGELIJYkCBFxAMjkd+uht/O7tmzDIcPMJy2ZAkxpWREKQWn5yfMHuwMyF59zaePH49qSOMohAeWLgwABquNiBenIwBwAJDCBIMBgiloUygGfyL7nOSONycDVYilNeCD4wGgLaIwDOY3RNPrtv532wUiWwpkBNUgVawvKIEIpIpxXDSt/LLeamn5184P2tW/kuUdJip9Zkhq2EQEU4akeB9Q7QFZgHD1dH96eMCvb3NaxRy/YmuqCKt7TpwNOwztLHSzhSsyFGnlC+3viCsUEb/yBy0zEH8AoaQi9cUbCqDc+ZNfnhABwNhSUllylMKHKT1AHMM4IgzFAZV1K43ggLyVMvAz6SoZsSEoMHZKCEEoiFbw8/5LtTMI2XPB/5VzNf4//AuIANb0+/cA+81+fmW+2Zk0wypZKad8/bUbkpR9GWWlAXoxdVo7BA5SOusIMjhIzhdqccqJOLiliaB24FWV9ehfZqmNYqC1pIVGuCMwDBpuU+4xykHdYDI2iAAV4FXXS/zHQjvFqAgR0ExYUASQVoAMVUegQyr/nNq45p8hBWDt/5GAIN+dwu60dA4kqFtndMT41k6lGcugxajG6EiGdQsXUECvDBixYooFsE6WxAsAIEikg4Jk6LNHJCQMCfcxrCRzNrLoDjh37B4DkgFtAQv94UHNgtTgbtxcBkTr/SG9DuLqkytqYn+69LIf3H5HFO4LFlvR4kS8uEeTEEBqD9TTJ3YRkAe5x0HyIgLPASEdMRf9fSf2d9fpgc7ebczv/gwRGAA2PsxA/r7THxCBwRIAwJCDMYBjAB+OsI29MgNO/n8K/vwbBGdCBAgBPvIKFgA=";
  
  const ITENS_CATALOGO = {
    revive: { preco: 780, name_br: 'Revive Token', name_en: 'Revive Token' },
    max: { preco: 540, name_br: 'Max Growth Token', name_en: 'Max Growth Token' },
    partial: { preco: 180, name_br: 'Partial Growth Token', name_en: 'Partial Growth Token' },
    change: { preco: 70, name_br: 'Appearance Change Token', name_en: 'Appearance Change Token' }
  };

  const PRECOS_MINIMOS = { revive: 780, max: 540, partial: 180, change: 70 };
  const PRECOS_RESELLER = { revive: 770, max: 530, partial: 175, change: 65 };
  const PRECOS_VOLUME = { revive: 795, max: 555, partial: 185, change: 75 };

  const TRANSLATIONS = {
    br: {
        pageTitle: "Painel", mainHeader: "Calculadora de Tokens", themeLabel: "Tema Claro",
        idLabel: "Identificador / Nome do Cliente", idPlaceholder: "Digite o nome ou ID do cliente", discountLabel: "Desconto (%)",
        discountPlaceholder: "Ex: 10", tableItem: "Item", tablePrice: "Preço Unitário", tableQty: "Quantidade",
        tableTotal: "Valor Total", tableGrandTotal: "TOTAL GERAL", btnCalculate: "Calcular", btnReset: "Resetar",
        btnExport: "Exportar para PNG", alertNoItems: "Nenhum item foi selecionado para gerar o recibo.",
        receiptHeader: "Recibo", receiptItemsHeader: "Itens Comprados", receiptSubtotal: "Subtotal",
        receiptDiscount: "Desconto", receiptFinalTotal: "Total Final", receiptThanks: "Gerado pelo Painel de Vendas by Riciv",
        receiptUnitPrice: "Preço Unit.", receiptSeller: "Venda por", receiptTransactionId: "ID da Transação",
        volumePriceLegend: "* Preço aplicado p/ compras > 84 unidades",
        calculationMode: "Modo de Cálculo", modeQty: "Por Quantidade", modeMush: "Por Mush",
        distributeTokensLabel: "Tokens Desejáveis para Distribuição", totalMushLabel: "Total de Mush a Gastar",
        btnDistribute: "Distribuir", leftoverMushText: "Sobrou:",
        loginHeader: "Acessar painel", usernameLabel: "Usuário", passwordLabel: "Senha",
        loginButton: "Entrar", logoutButton: "Sair", errorInvalidCredentials: "Usuário ou senha inválidos.",
        errorGeneric: "Ocorreu um erro. Tente novamente.",
        tabCalculator: "Calculadora", tabHistory: "Histórico", historyHeader: "Histórico de Vendas",
        historyCustomer: "Cliente", historyDate: "Data", historyTotal: "Total", historySeller: "Vendedor",
        historyNoRecords: "Nenhum registro encontrado.", historyLoading: "Carregando histórico...",
        historyEmptyStateMessage: "Ainda não há vendas registradas aqui.",
        usersEmptyStateMessage: "Nenhum usuário encontrado.",
        loggedInAs: "Usuário:",
        resellerCustomerLabel: "Cliente Revendedor", resellerCustomerManualPlaceholder: "Digite o nome do cliente revendedor",
        resellerLimitStatus: (revive, max, total, time) => `Limite Cliente: <b>Revive</b> (${revive}/${total}) | <b>Max</b> (${max}/${total}). Reseta em <b>${time}</b>.`,
        resellerLimitExceededWarning: "Atenção: O limite diário do cliente para um ou mais itens foi excedido. Itens acima do limite serão cobrados com o preço base.",
        resalePricesLabel: "Preços Personalizados",
        resalePricesBtn: "Definir Preços de Revenda",
        customResaleModeLabel: "Modo Revenda (Preços Personalizados)",
        resaleModalHeader: "Definir Preços de Revenda",
        resaleModalDesc: "Estes preços serão usados quando o \"Modo Revenda\" estiver ativo. Para editar, use este modal.",
        cancelButton: "Cancelar",
        saveButton: "Salvar"
    },
    en: {
        pageTitle: "Panel", mainHeader: "Token Calculator", themeLabel: "Light Theme",
        idLabel: "Customer Identifier / Name", idPlaceholder: "Enter customer's name or ID", discountLabel: "Discount (%)",
        discountPlaceholder: "Ex: 10", tableItem: "Item", tablePrice: "Unit Price", tableQty: "Quantity",
        tableTotal: "Total Value", tableGrandTotal: "GRAND TOTAL", btnCalculate: "Calculate", btnReset: "Reset",
        btnExport: "Export to PNG", alertNoItems: "No items were selected to generate the receipt.",
        receiptHeader: "Receipt", receiptItemsHeader: "Purchased Items", receiptSubtotal: "Subtotal",
        receiptDiscount: "Discount", receiptFinalTotal: "Final Total", receiptThanks: "Generated by Sales Panel by Riciv",
        receiptUnitPrice: "Unit Price", receiptSeller: "Sold by", receiptTransactionId: "Transaction ID",
        volumePriceLegend: "* Price applied for purchases > 84 units",
        calculationMode: "Calculation Mode", modeQty: "By Quantity", modeMush: "By Mush",
        distributeTokensLabel: "Desirable Tokens for Distribution", totalMushLabel: "Total Mush to Spend",
        btnDistribute: "Distribute", leftoverMushText: "Leftover:",
        loginHeader: "Calculator Login", usernameLabel: "Username", passwordLabel: "Password",
        loginButton: "Login", logoutButton: "Logout", errorInvalidCredentials: "Invalid username or password.",
        errorGeneric: "An error occurred. Please try again.",
        tabCalculator: "Calculator", tabHistory: "History", historyHeader: "Sales History",
        historyCustomer: "Customer", historyDate: "Date", historyTotal: "Total", historySeller: "Seller",
        historyNoRecords: "No records found.", historyLoading: "Loading history...",
        historyEmptyStateMessage: "No sales have been recorded here yet.",
        usersEmptyStateMessage: "No users found.",
        loggedInAs: "User:",
        resellerCustomerLabel: "Reseller Customer", resellerCustomerManualPlaceholder: "Enter reseller customer's name",
        resellerLimitStatus: (revive, max, total, time) => `Customer Limit: <b>Revive</b> (${revive}/${total}) | <b>Max</b> (${max}/${total}). Resets in <b>${time}</b>.`,
        resellerLimitExceededWarning: "Warning: The customer's daily limit for one or more items has been exceeded. Items above the limit will be charged at the base price.",
        resalePricesLabel: "Custom Prices",
        resalePricesBtn: "Set Resale Prices",
        customResaleModeLabel: "Resale Mode (Custom Prices)",
        resaleModalHeader: "Set Resale Prices",
        resaleModalDesc: "These prices will be used when \"Resale Mode\" is active. To edit, use this modal.",
        cancelButton: "Cancel",
        saveButton: "Save"
    }
  };

  const dom = {
    authContainer: document.getElementById('auth-container'),
    appContainer: document.getElementById('app-container'),
    usernameInput: document.getElementById('username-input'),
    passwordInput: document.getElementById('password-input'),
    btnLogin: document.getElementById('btnLogin'),
    btnLogout: document.getElementById('btnLogout'),
    authError: document.getElementById('auth-error'),
    html: document.documentElement,
    nomeClienteInput: document.getElementById('nomeCliente'),
    descontoInput: document.getElementById('desconto'),
    tabelaItensBody: document.getElementById('tabela-itens'),
    totalGeralCell: document.getElementById('totalGeral'),
    themeToggle: document.getElementById('theme-toggle'),
    accentColorSwitcher: document.getElementById('accent-color-switcher'),
    langBr: document.getElementById('lang-br'),
    langEn: document.getElementById('lang-en'),
    modeQtyRadio: document.getElementById('mode-qty'),
    modeMushRadio: document.getElementById('mode-mush'),
    calculatorTable: document.getElementById('calculator-table'),
    distributorSection: document.getElementById('distributor-section'),
    tokenFiltersContainer: document.getElementById('token-filters-container'),
    leftoverTokenFiltersContainer: document.getElementById('leftover-token-filters-container'),
    totalMushInput: document.getElementById('total-mush'),
    btnDistribute: document.getElementById('btnDistribute'),
    btnDistributeLeftover: document.getElementById('btnDistributeLeftover'),
    leftoverMushDiv: document.getElementById('leftover-mush'),
    leftoverDistributorSection: document.getElementById('leftover-distributor-section'),
    tabNavigation: document.querySelector('.tab-navigation'),
    tabLinks: document.querySelectorAll('.tab-link'),
    tabContents: document.querySelectorAll('.tab-content'),
    historyTableContainer: document.getElementById('history-table-container'),
    loggedInUserDiv: document.getElementById('logged-in-user'),
    historySearchInput: document.getElementById('history-search-input'),
    historyDateStart: document.getElementById('history-date-start'),
    historyDateEnd: document.getElementById('history-date-end'),
    historyApplyFilterBtn: document.getElementById('history-apply-filter-btn'),
    historyPaginationControls: document.getElementById('history-pagination-controls'),
    btnPrevPage: document.getElementById('btn-prev-page'),
    btnNextPage: document.getElementById('btn-next-page'),
    pageNumberDisplay: document.getElementById('page-number-display'),
    salesOverTimeChart: document.getElementById('sales-over-time-chart'),
    tokensSoldChart: document.getElementById('tokens-sold-chart'),
    adminView: document.getElementById('admin-view'),
    adminActionStatus: document.getElementById('admin-action-status'),
    btnLoadUsers: document.getElementById('btn-load-users'),
    userListContainer: document.getElementById('user-list-container'),
    btnCreateSeller: document.getElementById('btn-create-seller'),
    newSellerUsernameInput: document.getElementById('new-seller-username'),
    newSellerPasswordInput: document.getElementById('new-seller-password'),
    resellerModeContainer: document.getElementById('reseller-mode-container'),
    resellerModeToggle: document.getElementById('reseller-mode-toggle'),
    resellerLimitStatus: document.getElementById('reseller-limit-status'),
    customerNameContainer: document.getElementById('customer-name-container'),
    resellerCustomerSelectionContainer: document.getElementById('reseller-customer-selection-container'),
    resellerCustomerSelect: document.getElementById('reseller-customer-select'),
    resellerCustomerManualInput: document.getElementById('reseller-customer-manual-input'),
    txtExportModal: document.getElementById('txt-export-modal'),
    exportTxtModalBtn: document.getElementById('export-txt-modal-btn'),
    closeTxtExportModalBtn: document.getElementById('close-txt-export-modal'),
    cancelTxtExportBtn: document.getElementById('cancel-txt-export-btn'),
    generateTxtFileBtn: document.getElementById('generate-txt-file-btn'),
    customerListForExport: document.getElementById('customer-list-for-export'),
    selectAllCustomersCheckbox: document.getElementById('select-all-customers-checkbox'),
    historySellerFilterContainer: document.getElementById('history-seller-filter-container'),
    historySellerFilter: document.getElementById('history-seller-filter'),
	historySaleTypeFilter: document.getElementById('history-sale-type-filter'),
    resellerPanelView: document.getElementById('reseller-panel-view'),
    subResellerActionStatus: document.getElementById('sub-reseller-action-status'),
    newSubResellerUsernameInput: document.getElementById('new-sub-reseller-username'),
    newSubResellerPasswordInput: document.getElementById('new-sub-reseller-password'),
    btnCreateSubReseller: document.getElementById('btn-create-sub-reseller'),
    btnLoadMyResellers: document.getElementById('btn-load-my-resellers'),
    subResellerListContainer: document.getElementById('sub-reseller-list-container'),
    addSubResellerSection: document.getElementById('add-sub-reseller-section'),
    historyViewTeamContainer: document.getElementById('history-view-team-container'),
    btnOpenResaleModal: document.getElementById('btn-open-resale-modal'),
    resalePriceModal: document.getElementById('resale-price-modal'),
    closeResaleModalBtn: document.getElementById('close-resale-modal-btn'),
    saveResalePricesBtn: document.getElementById('save-resale-prices-btn'),
    cancelResalePricesBtn: document.getElementById('cancel-resale-prices-btn'),
    customResaleToggle: document.getElementById('custom-resale-toggle'),
    customResaleModeContainer: document.getElementById('custom-resale-mode-container'),
    settingsToggleBtn: document.getElementById('settings-toggle-btn'),
    settingsMenu: document.getElementById('settings-menu'),
    historySelectionBar: document.getElementById('history-selection-bar'),
    historySelectionCount: document.getElementById('history-selection-count'),
    btnBulkDelete: document.getElementById('btn-bulk-delete'),
    btnBulkDownload: document.getElementById('btn-bulk-download'),
    receiptGeneratorContainer: document.getElementById('receipt-generator-container'),
    topCustomerCard: document.getElementById('top-customer-card'),
    topCustomerName: document.getElementById('top-customer-name'),
    topCustomerValue: document.getElementById('top-customer-value'),
    totalSalesCard: document.getElementById('total-sales-card'),
    totalSalesValue: document.getElementById('total-sales-value'),
    topSellerCard: document.getElementById('top-seller-card'),
    topSellerName: document.getElementById('top-seller-name'),
    topSellerValue: document.getElementById('top-seller-value'),
  };

  let currentLang = 'br';

  const app = {
    CONFIG: {
        RESELLER_DAILY_LIMIT: 750,
        HISTORY_PAGE_SIZE: 20,
        DUMMY_DOMAIN: '@painelriciv.com',
        SAVE_PREFS_DEBOUNCE_MS: 1500,
    },
    utils: {
        hexToRgb(hex, asString = false) {
            let c;
            if (/^#([A-Fa-f0-9]{3}){1,2}$/.test(hex)) {
                c = hex.substring(1).split('');
                if (c.length === 3) c = [c[0], c[0], c[1], c[1], c[2], c[2]];
                c = '0x' + c.join('');
                const r = (c >> 16) & 255;
                const g = (c >> 8) & 255;
                const b = c & 255;
                return asString ? `${r}, ${g}, ${b}` : { r, g, b };
            }
            return asString ? '0, 0, 0' : { r: 0, g: 0, b: 0 };
        }
    },
    calculatorInitialized: false,
    currentLeftover: 0,
    historyPageCursors: [null],
    historyCurrentPage: 0,
    historySelectedIds: new Set(),
    salesChartInstance: null,
    tokensChartInstance: null,
    isCurrentUserOwner: false,
    isCurrentUserAdmin: false, 
    isOfficialReseller: false, 
    currentUsername: null,
    saveTimeout: null,
    currentCustomerUsage: { revive: 0, max: 0 },
    resellerLimitInterval: null,
    manualPrices: {},
    customResalePrices: {},

    init() {
        app.loadDevicePreferences();
        app.setLanguage(currentLang, true);
        app.addAuthListeners();
    },

    showNotification(message, type = 'success') {
        const container = document.getElementById('notification-container');
        const notification = document.createElement('div');
        notification.className = `toast ${type}`;
        notification.textContent = message;
        container.appendChild(notification);
        setTimeout(() => notification.classList.add('show'), 10);
        setTimeout(() => {
            notification.classList.remove('show');
            notification.addEventListener('transitionend', () => notification.remove());
        }, 4000);
    },

    showConfirmation(message, onConfirm) {
        const modal = document.getElementById('confirm-modal');
        const body = document.getElementById('confirm-modal-body');
        const confirmBtn = document.getElementById('confirm-modal-confirm-btn');
        const cancelBtn = document.getElementById('confirm-modal-cancel-btn');
        const closeBtn = document.getElementById('confirm-modal-close-btn');
        body.textContent = message;
        modal.classList.remove('hidden');
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        const closeModal = () => modal.classList.add('hidden');
        newConfirmBtn.addEventListener('click', () => { onConfirm(); closeModal(); });
        cancelBtn.addEventListener('click', closeModal);
        closeBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => { if(e.target === modal) closeModal(); });
    },

    addAuthListeners() {
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                await user.getIdTokenResult(true).then(async (idTokenResult) => {
                    app.isCurrentUserOwner = !!idTokenResult.claims.owner;
                    app.isCurrentUserAdmin = !!idTokenResult.claims.admin; 
                    app.isOfficialReseller = !!idTokenResult.claims.officialReseller;
                    app.currentUsername = user.email.split('@')[0];
                    const canManage = app.isCurrentUserOwner || app.isCurrentUserAdmin;
                    document.querySelector('[data-tab="admin-view"]').style.display = canManage ? 'inline-block' : 'none';
                    document.querySelector('[data-tab="reseller-panel-view"]').style.display = (app.isOfficialReseller || app.isCurrentUserOwner) ? 'inline-block' : 'none';
                    if(dom.historyViewTeamContainer) {
                        dom.historyViewTeamContainer.style.display = (app.isOfficialReseller || app.isCurrentUserOwner) ? 'contents' : 'none';
                    }
                    if (app.isCurrentUserOwner || app.isCurrentUserAdmin) {
                        dom.resellerModeContainer.classList.remove('hidden');
                    } else {
                        dom.resellerModeContainer.classList.add('hidden');
                    }
                    dom.authContainer.classList.add('hidden');
                    dom.appContainer.classList.remove('hidden');
                    if (!app.calculatorInitialized) {
                        app.addAppEventListeners(); 
                        app.setLanguage(currentLang, false, true); 
                        await app.loadUserPreferences(user);
                        app.setDefaultTab();
                        app.toggleMode(dom.modeQtyRadio.checked ? 'quantity' : 'mush');
                        app.calculatorInitialized = true;
                    }
                    dom.loggedInUserDiv.innerHTML = `<span>${TRANSLATIONS[currentLang].loggedInAs}</span> <span class="username">${app.currentUsername}</span>`;
                });
            } else {
                app.isCurrentUserOwner = false;
                app.isCurrentUserAdmin = false;
                app.isOfficialReseller = false;
                app.currentUsername = null;
                dom.authContainer.classList.remove('hidden');
                dom.appContainer.classList.add('hidden');
                dom.resellerModeContainer.classList.add('hidden');
                document.querySelector('[data-tab="reseller-panel-view"]').style.display = 'none';
                document.querySelector('[data-tab="admin-view"]').style.display = 'none';
                app.calculatorInitialized = false;
            }
        });
        dom.btnLogin.addEventListener('click', () => app.handleLogin());
        dom.btnLogout.addEventListener('click', () => app.handleLogout());
    },

    addAppEventListeners() {
      dom.settingsToggleBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        dom.settingsMenu.classList.toggle('active');
      });
      document.addEventListener('click', (e) => {
        if (dom.settingsMenu.classList.contains('active') && !dom.settingsMenu.contains(e.target) && !dom.settingsToggleBtn.contains(e.target)) {
            dom.settingsMenu.classList.remove('active');
        }
      });
      dom.descontoInput.addEventListener('input', () => { app.updateUI(); app.triggerSaveCalculatorPreferences(); });
      document.getElementById('btnCalcular').addEventListener('click', () => app.updateUI());
      document.getElementById('btnResetar').addEventListener('click', () => app.reset({ fullReset: true }));
      document.getElementById('btnGerarImagem').addEventListener('click', () => app.processSaleAndGenerateReceipt());
      dom.themeToggle.addEventListener('click', () => {
          const newTheme = dom.html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
          app.setTheme(newTheme);
      });
      dom.accentColorSwitcher.addEventListener('click', (event) => {
          const color = event.target.dataset.color;
          if (color) app.setAccentColor(color);
      });
      dom.langBr.addEventListener('click', () => app.setLanguage('br'));
      dom.langEn.addEventListener('click', () => app.setLanguage('en'));
      dom.modeQtyRadio.addEventListener('change', () => app.toggleMode('quantity'));
      dom.modeMushRadio.addEventListener('change', () => app.toggleMode('mush'));
      dom.resellerModeToggle.addEventListener('change', (e) => app.toggleResellerMode(e.target.checked));
      dom.resellerCustomerSelect.addEventListener('change', () => {
          if (dom.resellerCustomerSelect.value === 'manual') {
              dom.resellerCustomerManualInput.classList.remove('hidden');
              dom.resellerCustomerManualInput.focus();
          } else {
              dom.resellerCustomerManualInput.classList.add('hidden');
          }
          app.checkResellerLimit();
      });
      dom.resellerCustomerManualInput.addEventListener('keyup', () => app.checkResellerLimit());
      dom.totalMushInput.addEventListener('input', () => app.triggerSaveCalculatorPreferences());
      dom.btnDistribute.addEventListener('click', () => app.distributeMush());
      dom.btnDistributeLeftover.addEventListener('click', () => app.distributeLeftoverMush());
      dom.tabNavigation.addEventListener('click', (e) => app.handleTabClick(e));
      dom.tokenFiltersContainer.addEventListener('change', () => {
          const selectedCount = dom.tokenFiltersContainer.querySelectorAll('input:checked').length;
          document.getElementById('two-token-options').classList.toggle('hidden', selectedCount !== 2);
      });
      document.querySelectorAll('input[name="history-view-mode"]').forEach(radio => {
          radio.addEventListener('change', () => app.loadHistory('first'));
      });
      dom.historyApplyFilterBtn.addEventListener('click', () => app.loadHistory('first'));
      dom.btnPrevPage.addEventListener('click', () => app.loadHistory('prev'));
      dom.btnNextPage.addEventListener('click', () => app.loadHistory('next'));
      dom.historyTableContainer.addEventListener('click', (event) => {
          const target = event.target;
          if (target.matches('.history-row-checkbox, #history-select-all')) {
            app.handleHistorySelectionChange(event);
          }
          if(target.closest('button')){
            const button = target.closest('button');
            if (button.classList.contains('delete-history-btn')) app.handleHistoryDelete([button.dataset.id]);
            if (button.classList.contains('btn-view-receipt')) app.regenerateReceipt(button.dataset.id);
          }
      });
      dom.btnBulkDelete.addEventListener('click', () => app.handleBulkDelete());
      dom.btnBulkDownload.addEventListener('click', () => app.handleBulkDownload());
      dom.btnLoadUsers.addEventListener('click', () => app.loadUsers());
      dom.userListContainer.addEventListener('click', (e) => app.handleUserAction(e));
      dom.btnCreateSeller.addEventListener('click', () => app.handleCreateSeller());
      dom.btnCreateSubReseller.addEventListener('click', () => app.handleCreateSubReseller());
      dom.btnLoadMyResellers.addEventListener('click', () => app.loadResellerPanelData());
      dom.subResellerListContainer.addEventListener('click', (e) => app.handleSubResellerAction(e));
      dom.exportTxtModalBtn.addEventListener('click', () => app.openTxtExportModal());
      dom.closeTxtExportModalBtn.addEventListener('click', () => dom.txtExportModal.classList.add('hidden'));
      dom.cancelTxtExportBtn.addEventListener('click', () => dom.txtExportModal.classList.add('hidden'));
      dom.selectAllCustomersCheckbox.addEventListener('change', (e) => app.handleSelectAllCustomers(e));
      dom.generateTxtFileBtn.addEventListener('click', () => app.generateTxtFile());
      dom.txtExportModal.addEventListener('click', (e) => { if (e.target === dom.txtExportModal) dom.txtExportModal.classList.add('hidden'); });
      dom.btnOpenResaleModal.addEventListener('click', () => app.openResaleModal());
      dom.closeResaleModalBtn.addEventListener('click', () => dom.resalePriceModal.classList.add('hidden'));
      dom.cancelResalePricesBtn.addEventListener('click', () => dom.resalePriceModal.classList.add('hidden'));
      dom.saveResalePricesBtn.addEventListener('click', () => app.saveResalePrices());
      dom.customResaleToggle.addEventListener('change', (e) => app.toggleCustomResaleMode(e.target.checked));
      dom.resalePriceModal.addEventListener('click', (e) => { if (e.target === dom.resalePriceModal) dom.resalePriceModal.classList.add('hidden'); });
    },

    async handleLogin() {
        const username = dom.usernameInput.value.trim();
        const password = dom.passwordInput.value;
        const t = TRANSLATIONS[currentLang];
        if (!username || !password) {
            dom.authError.textContent = t.errorInvalidCredentials;
            return;
        }
        const email = username + app.CONFIG.DUMMY_DOMAIN;
        try {
            dom.authError.textContent = '';
            await auth.signInWithEmailAndPassword(email, password);
        } catch (error) {
            if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-email') {
                dom.authError.textContent = t.errorInvalidCredentials;
            } else {
                dom.authError.textContent = t.errorGeneric;
            }
        }
    },

    handleLogout() { auth.signOut(); },

    loadDevicePreferences() {
        const theme = localStorage.getItem('theme') || 'dark';
        const accentColor = localStorage.getItem('accentColor') || 'green';
        app.setTheme(theme, false);
        app.setAccentColor(accentColor, false);
        currentLang = localStorage.getItem('language') || 'br';
    },

    async loadUserPreferences(user) {
        if (!user) return;
        try {
            const docRef = db.collection('userPreferences').doc(user.uid);
            const docSnap = await docRef.get();
            app.manualPrices = {};
            app.customResalePrices = {};
            if (docSnap.exists) {
                const prefs = docSnap.data();
                if (prefs.theme) app.setTheme(prefs.theme, false);
                if (prefs.accentColor) app.setAccentColor(prefs.accentColor, false);
                if (prefs.language) app.setLanguage(prefs.language, false, true);
                if (prefs.customResalePrices) app.customResalePrices = prefs.customResalePrices;
                if (prefs.prices) app.manualPrices = prefs.prices;
                if (prefs.calculator) {
                    dom.descontoInput.value = prefs.calculator.discount || '';
                    dom.totalMushInput.value = prefs.calculator.totalMush || '';
                    if (prefs.calculator.quantities) {
                        for (const key in prefs.calculator.quantities) {
                            const qtyInput = document.getElementById(`qtd-${key}`);
                            if (qtyInput) qtyInput.value = prefs.calculator.quantities[key];
                        }
                    }
                }
            }
            app.applyManualOrCatalogPrices();
            app.populateResaleModalInputs();
            app.updateUI();
        } catch (error) { console.error("Erro ao carregar preferências:", error); }
    },

    triggerSaveCalculatorPreferences() {
        clearTimeout(app.saveTimeout);
        app.saveTimeout = setTimeout(() => {
            if (dom.resellerModeToggle.checked || dom.customResaleToggle.checked) return;
            app.saveManualPricesToFirestore();
        }, app.CONFIG.SAVE_PREFS_DEBOUNCE_MS);
    },

    async saveUiPreferences() {
        if (!auth.currentUser) return;
        const prefs = {
            theme: dom.html.getAttribute('data-theme'),
            accentColor: dom.html.getAttribute('data-accent-color'),
            language: currentLang,
        };
        try {
            await db.collection('userPreferences').doc(auth.currentUser.uid).set(prefs, { merge: true });
        } catch (error) { console.error("Erro ao salvar preferências de UI:", error); }
    },

    async saveManualPricesToFirestore() {
        if (!auth.currentUser) return;
        const quantitiesToSave = {};
        for (const key in ITENS_CATALOGO) {
            const qtyInput = document.getElementById(`qtd-${key}`);
            if (qtyInput) quantitiesToSave[key] = parseInt(qtyInput.value) || 0;
        }
        const prefs = {
            prices: app.manualPrices,
            calculator: {
                discount: parseFloat(dom.descontoInput.value) || 0,
                totalMush: parseFloat(dom.totalMushInput.value) || 0,
                quantities: quantitiesToSave
            }
        };
        try {
            await db.collection('userPreferences').doc(auth.currentUser.uid).set(prefs, { merge: true });
        } catch (error) { console.error("Erro ao salvar preferências da calculadora:", error); }
    },
    
    async saveCustomResalePricesToFirestore() {
        if (!auth.currentUser) return;
        try {
            await db.collection('userPreferences').doc(auth.currentUser.uid).set({ customResalePrices: app.customResalePrices }, { merge: true });
            app.showNotification("Preços de revenda salvos!", 'success');
        } catch (error) {
            console.error("Erro ao salvar preços de revenda personalizados:", error);
            app.showNotification("Erro ao salvar preços.", 'error');
        }
    },
    
    setDefaultTab() {
        dom.tabLinks.forEach(link => link.classList.remove('active'));
        dom.tabContents.forEach(content => content.classList.add('hidden'));
        const firstTab = document.querySelector('.tab-link');
        firstTab.classList.add('active');
        document.getElementById(firstTab.dataset.tab).classList.remove('hidden');
    },

    handleTabClick(event) {
        const clickedTab = event.target.closest('.tab-link');
        if (!clickedTab || clickedTab.classList.contains('active')) return;
        dom.tabLinks.forEach(link => link.classList.remove('active'));
        dom.tabContents.forEach(content => content.classList.add('hidden'));
        clickedTab.classList.add('active');
        const tabId = clickedTab.dataset.tab;
        document.getElementById(tabId).classList.remove('hidden');
        if (tabId === 'dashboard-view') app.loadDashboardData();
        else if (tabId === 'history-view') {
            app.loadHistory('first');
            if (app.isCurrentUserOwner) app.populateHistorySellerFilter();
            else dom.historySellerFilterContainer.classList.add('hidden');
        } 
        else if (tabId === 'admin-view' && (app.isCurrentUserOwner || app.isCurrentUserAdmin)) app.loadUsers();
        else if (tabId === 'reseller-panel-view' && (app.isOfficialReseller || app.isCurrentUserOwner)) app.loadResellerPanelData();
    },

    handleHistoryDelete(docIds) {
        if (!docIds || docIds.length === 0) return;
        const message = docIds.length > 1 ? `Tem certeza que deseja excluir os ${docIds.length} registros?` : "Tem certeza que deseja excluir este registro?";
        app.showConfirmation(message, async () => {
            const batch = db.batch();
            docIds.forEach(id => batch.delete(db.collection('receipts').doc(id)));
            try {
                await batch.commit();
                app.showNotification(`${docIds.length} registro(s) excluído(s).`, 'success');
                app.loadHistory('first');
            } catch (error) {
                app.showNotification(`Erro ao excluir: ${error.message}`, 'error');
            }
        });
    },

    handleBulkDelete() { app.handleHistoryDelete(Array.from(app.historySelectedIds)); },

    async handleBulkDownload() {
        const idsToDownload = Array.from(app.historySelectedIds);
        if (idsToDownload.length === 0) return;
        app.showNotification(`Iniciando download de ${idsToDownload.length} recibos...`, 'success');
        for (const id of idsToDownload) {
            await app.regenerateReceipt(id, true);
            await new Promise(resolve => setTimeout(resolve, 300));
        }
    },

    handleHistorySelectionChange(event) {
        app.historySelectedIds.clear();
        dom.historyTableContainer.querySelectorAll('.history-row-checkbox').forEach(cb => {
            if (cb.checked) app.historySelectedIds.add(cb.dataset.id);
        });
        if (event.target.id === 'history-select-all') {
            const isChecked = event.target.checked;
            dom.historyTableContainer.querySelectorAll('.history-row-checkbox').forEach(cb => {
                cb.checked = isChecked;
                if(isChecked) app.historySelectedIds.add(cb.dataset.id);
            });
        }
        app.updateSelectionActionsBar();
    },

    updateSelectionActionsBar() {
        const count = app.historySelectedIds.size;
        dom.historySelectionBar.classList.toggle('active', count > 0);
        if (count > 0) dom.historySelectionCount.textContent = `${count} item(ns) selecionado(s)`;
        const selectAllCheckbox = document.getElementById('history-select-all');
        if (selectAllCheckbox) {
            const totalRows = dom.historyTableContainer.querySelectorAll('.history-row-checkbox').length;
            selectAllCheckbox.checked = count > 0 && count === totalRows;
            selectAllCheckbox.indeterminate = count > 0 && count < totalRows;
        }
    },

    displayAdminStatus(message, isSuccess = false) {
        dom.adminActionStatus.textContent = message;
        dom.adminActionStatus.className = isSuccess ? 'success' : '';
        setTimeout(() => dom.adminActionStatus.textContent = '', 5000);
    },
    
    async callCloudFunction(functionName, params = {}) {
        try {
            const func = functions.httpsCallable(functionName);
            const result = await func(params);
            return { success: true, data: result.data };
        } catch (error) {
            console.error(`Erro ao chamar '${functionName}':`, error);
            return { success: false, error: error.message };
        }
    },

    async handleCreateSeller() {
        const username = dom.newSellerUsernameInput.value.trim();
        const password = dom.newSellerPasswordInput.value;
        if (!username || !password) { app.displayAdminStatus('Preencha usuário e senha.'); return; }
        if (password.length < 6) { app.displayAdminStatus('A senha deve ter no mínimo 6 caracteres.'); return; }
        dom.btnCreateSeller.disabled = true;
        app.displayAdminStatus('Criando...', true);
        const result = await app.callCloudFunction('createUser', { email: username + app.CONFIG.DUMMY_DOMAIN, password });
        if (result.success) {
            app.displayAdminStatus(result.data.message, true);
            dom.newSellerUsernameInput.value = '';
            dom.newSellerPasswordInput.value = '';
            app.loadUsers();
        } else {
            app.displayAdminStatus(`Erro: ${result.error}`);
        }
        dom.btnCreateSeller.disabled = false;
    },

    displaySubResellerStatus(message, isSuccess = false) {
        dom.subResellerActionStatus.textContent = message;
        dom.subResellerActionStatus.className = isSuccess ? 'success' : '';
        setTimeout(() => dom.subResellerActionStatus.textContent = '', 5000);
    },

    async handleCreateSubReseller() {
        const username = dom.newSubResellerUsernameInput.value.trim();
        const password = dom.newSubResellerPasswordInput.value;
        if (!username || !password) { app.displaySubResellerStatus('Preencha usuário e senha.'); return; }
        if (password.length < 6) { app.displaySubResellerStatus('A senha deve ter no mínimo 6 caracteres.'); return; }
        dom.btnCreateSubReseller.disabled = true;
        app.displaySubResellerStatus('Criando...', true);
        const result = await app.callCloudFunction('createSubReseller', { email: username + app.CONFIG.DUMMY_DOMAIN, password });
        if(result.success) {
            app.displaySubResellerStatus(result.data.message, true);
            dom.newSubResellerUsernameInput.value = '';
            dom.newSubResellerPasswordInput.value = '';
            app.loadResellerPanelData();
        } else {
            app.displaySubResellerStatus(`Erro: ${result.error}`);
        }
        dom.btnCreateSubReseller.disabled = false;
    },
    
    async loadResellerPanelData() {
        app.showLoading(dom.subResellerListContainer);
        if (dom.addSubResellerSection) {
            dom.addSubResellerSection.style.display = (app.isOfficialReseller || app.isCurrentUserOwner) ? 'flex' : 'none';
        }
        const result = await app.callCloudFunction('listMySubResellers');
        if (result.success) {
            app.renderSubResellerList(result.data);
        } else {
            dom.subResellerListContainer.innerHTML = `<p style="color: var(--text-error);">Erro ao carregar: ${result.error}</p>`;
        }
    },
    
    handleSubResellerAction(event) {
        const target = event.target.closest('button.delete');
        if (!target) return;
        const uid = target.dataset.uid;
        const username = target.closest('tr').cells[0].textContent;
        if (!uid || !username) return;
        app.showConfirmation(`Tem certeza que deseja EXCLUIR "${username}"?`, async () => {
            target.disabled = true;
            app.displaySubResellerStatus('Excluindo...', true);
            const result = await app.callCloudFunction('deleteUserByUid', { uid: uid });
            if (result.success) {
                app.displaySubResellerStatus(result.data.message, true);
                app.loadResellerPanelData();
            } else {
                app.displaySubResellerStatus(`Erro: ${result.error}`);
                target.disabled = false;
            }
        });
    },

    renderSubResellerList(subResellers) {
        if (!subResellers || subResellers.length === 0) {
            app.renderEmptyState(dom.subResellerListContainer, 'Nenhum sub-revendedor encontrado.');
            return;
        }
        let tableHTML = `<table><thead><tr><th>Usuário</th><th>Email</th><th style="text-align: center;">Ações</th></tr></thead><tbody>`;
        subResellers.forEach(user => {
            tableHTML += `<tr>
                    <td data-label="Usuário">${user.username}</td>
                    <td data-label="Email">${user.email}</td>
                    <td data-label="Ações" style="text-align: center;">
                        <button class="btn-action delete" data-uid="${user.uid}" title="Excluir sub-revendedor">Excluir</button>
                    </td>
                </tr>`;
        });
        dom.subResellerListContainer.innerHTML = tableHTML + `</tbody></table>`;
    },

    async loadUsers() {
        app.showLoading(dom.userListContainer);
        const result = await app.callCloudFunction('listAllUsers');
        if (result.success) {
            app.renderUserList(result.data);
        } else {
            dom.userListContainer.innerHTML = `<p style="color: var(--text-error);">Erro ao carregar: ${result.error}</p>`;
        }
    },

    renderUserList(users) {
        if (!users || users.length === 0) {
            app.renderEmptyState(dom.userListContainer, TRANSLATIONS[currentLang].usersEmptyStateMessage);
            return;
        }
        let tableHTML = `<table><thead><tr><th>Usuário</th><th>Cargo</th><th style="text-align: center;">Ações</th></tr></thead><tbody>`;
        users.forEach(user => {
            const username = user.username;
            const isCurrentUser = auth.currentUser.uid === user.uid;
            const userRole = user.role;
            let roleDisplay = '';
            switch(userRole) {
                case 'owner': roleDisplay = '<b>👑 Dono</b>'; break;
                case 'admin': roleDisplay = '<b>🛡️ Admin</b>'; break;
                case 'official_reseller': roleDisplay = '<b>Revendedor Oficial</b>'; break;
                case 'sub_reseller': roleDisplay = `Sub-revendedor (de: ${user.parentResellerUsername || 'N/A'})`; break;
                default: roleDisplay = 'Vendedor';
            }
            let actionsHtml = '';
            if (app.isCurrentUserOwner && !isCurrentUser) {
                if (userRole !== 'owner') actionsHtml += `<button class="btn-action attention" data-action="promote-owner" data-uid="${user.uid}" title="Promover a Dono">Tornar Dono</button>`;
                if (userRole !== 'admin') actionsHtml += `<button class="btn-action attention" data-action="promote-admin" data-uid="${user.uid}" title="Promover a Admin">Tornar Admin</button>`;
                else actionsHtml += `<button class="btn-action demote" data-action="demote-admin" data-uid="${user.uid}" title="Rebaixar para Vendedor">Rebaixar Admin</button>`;
                if (userRole === 'seller') actionsHtml += `<button class="btn-action promote" data-action="promote-official" data-uid="${user.uid}" title="Promover a Revendedor Oficial">Tornar Oficial</button>`;
                if (userRole === 'official_reseller') actionsHtml += `<button class="btn-action demote" data-action="demote-seller" data-uid="${user.uid}" title="Rebaixar para Vendedor">Rebaixar</button>`;
                actionsHtml += `<button class="btn-action delete" data-action="delete-user" data-uid="${user.uid}" title="Excluir usuário">Excluir</button>`;
            } 
            else if (app.isCurrentUserAdmin && !isCurrentUser && userRole !== 'owner' && userRole !== 'admin') {
                if (userRole === 'seller') actionsHtml += `<button class="btn-action promote" data-action="promote-official" data-uid="${user.uid}" title="Promover a Revendedor Oficial">Tornar Oficial</button>`;
                if (userRole === 'official_reseller') actionsHtml += `<button class="btn-action demote" data-action="demote-seller" data-uid="${user.uid}" title="Rebaixar para Vendedor">Rebaixar</button>`;
                actionsHtml += `<button class="btn-action delete" data-action="delete-user" data-uid="${user.uid}" title="Excluir usuário">Excluir</button>`;
            }
            tableHTML += `<tr><td data-label="Usuário">${username}</td><td data-label="Cargo">${roleDisplay}</td><td data-label="Ações" style="text-align:center; display:flex; flex-wrap:wrap; gap: 8px; justify-content: flex-end;">${actionsHtml}</td></tr>`;
        });
        dom.userListContainer.innerHTML = tableHTML + `</tbody></table>`;
    },

    async handleUserAction(event) {
        const target = event.target;
        if (!target.matches('button.btn-action')) return;
        const uid = target.dataset.uid;
        const action = target.dataset.action;
        const username = target.closest('tr').cells[0].textContent;
        const fullEmail = username + app.CONFIG.DUMMY_DOMAIN;
        const confirmAndCall = (message, functionName, params) => {
            app.showConfirmation(message, async () => {
                target.disabled = true;
                const result = await app.callCloudFunction(functionName, params);
                if (result.success) {
                    app.displayAdminStatus(result.data.message || 'Ação concluída.', true);
                    app.loadUsers();
                } else {
                    app.displayAdminStatus(`Erro: ${result.error}`);
                    target.disabled = false;
                }
            });
        };
        switch (action) {
            case 'promote-owner': confirmAndCall(`ATENÇÃO: Privilégios TOTAIS para ${username}. Promover?`, 'setOwnerClaim', { email: fullEmail }); break;
            case 'promote-admin': confirmAndCall(`Promover ${username} a Admin?`, 'setAdminClaim', { uid }); break;
            case 'demote-admin': confirmAndCall(`Rebaixar Admin ${username} para Vendedor?`, 'demoteAdminToSeller', { uid }); break;
            case 'promote-official': confirmAndCall(`Promover ${username} a Revendedor Oficial?`, 'setOfficialReseller', { uid }); break;
            case 'demote-seller': confirmAndCall(`Rebaixar ${username} para Vendedor?`, 'demoteToSeller', { uid }); break;
            case 'delete-user': confirmAndCall(`ATENÇÃO: Irreversível! Excluir ${username}?`, 'deleteUserByUid', { uid }); break;
        }
    },
    
    showLoading(container) { container.innerHTML = `<div class="spinner-container"><div class="spinner"></div></div>`; },
    renderEmptyState(container, message, iconId = 'icon-empty') { container.innerHTML = `<div class="empty-state-container"><svg class="icon"><use xlink:href="#${iconId}"></use></svg><p>${message}</p></div>`; },

    async loadHistory(direction = 'first') {
        app.historySelectedIds.clear();
        app.updateSelectionActionsBar();
        app.showLoading(dom.historyTableContainer);
        dom.historyPaginationControls.classList.add('hidden');
        if (direction === 'first') {
            app.historyPageCursors = [null];
            app.historyCurrentPage = 0;
        }
        let pageToLoad = app.historyCurrentPage;
        if (direction === 'next') pageToLoad++;
        else if (direction === 'prev' && pageToLoad > 0) pageToLoad--;
        const lastDoc = app.historyPageCursors[pageToLoad];
        const { value: viewMode = 'all' } = document.querySelector('input[name="history-view-mode"]:checked') || {};
        const searchTerm = dom.historySearchInput.value.toLowerCase().trim();
        const selectedSeller = dom.historySellerFilter.value;
        const saleTypeFilter = dom.historySaleTypeFilter.value;
        const startDate = dom.historyDateStart.value ? new Date(dom.historyDateStart.value + 'T00:00:00') : null;
        const endDate = dom.historyDateEnd.value ? new Date(dom.historyDateEnd.value + 'T23:59:59') : null;
        try {
            if (viewMode === 'summary') return await app.renderSummaryView(searchTerm, startDate, endDate, selectedSeller, saleTypeFilter);
            if (viewMode === 'team' && (app.isOfficialReseller || app.isCurrentUserOwner)) return await app.renderTeamView(searchTerm, startDate, endDate, selectedSeller, saleTypeFilter);
            let query = db.collection("receipts");
            if (saleTypeFilter === 'reseller') query = query.where('isResellerSale', '==', true);
            else if (saleTypeFilter === 'regular') query = query.where('isResellerSale', 'in', [false, null]);
            if (!app.isCurrentUserOwner && !app.isCurrentUserAdmin) query = query.where('seller', '==', app.currentUsername);
            else if (selectedSeller) query = query.where('seller', '==', selectedSeller);
            if (startDate) query = query.where('createdAt', '>=', startDate);
            if (endDate) query = query.where('createdAt', '<=', endDate);
            query = query.orderBy('createdAt', 'desc');
            if (lastDoc) query = query.startAfter(lastDoc);
            query = query.limit(app.CONFIG.HISTORY_PAGE_SIZE + 1);
            let querySnapshot = await query.get();
            let docs = querySnapshot.docs;
            
            app.historyHasNextPage = docs.length > app.CONFIG.HISTORY_PAGE_SIZE;
            
            if (app.historyHasNextPage) {
                app.historyPageCursors[pageToLoad + 1] = docs.pop();
            }
            
            app.historyCurrentPage = pageToLoad;

            if (searchTerm) docs = docs.filter(doc => (doc.data().customerName || '').toLowerCase().includes(searchTerm));
            if (docs.length === 0 && app.historyCurrentPage === 0) return app.renderEmptyState(dom.historyTableContainer, TRANSLATIONS[currentLang].historyEmptyStateMessage);
            
            app.renderAllSalesView(docs);
            dom.historyPaginationControls.classList.remove('hidden');
            dom.pageNumberDisplay.textContent = `Página ${app.historyCurrentPage + 1}`;
            dom.btnPrevPage.disabled = app.historyCurrentPage === 0;
            dom.btnNextPage.disabled = !app.historyHasNextPage;
        } catch (error) {
            console.error("Erro ao buscar histórico: ", error);
            if (error.code === 'failed-precondition') {
                dom.historyTableContainer.innerHTML = `<p style="color: var(--text-error);"><b>Ação Necessária:</b> O filtro que você está tentando usar precisa de um índice no banco de dados. Por favor, abra o console do seu navegador (F12), encontre a mensagem de erro em vermelho do Firebase e clique no link fornecido para criar o índice automaticamente. A criação pode levar alguns minutos.</p>`;
            } else {
                dom.historyTableContainer.innerHTML = `<p style="color: var(--text-error);">${TRANSLATIONS[currentLang].errorGeneric}</p>`;
            }
        }
    },

    async renderTeamView(searchTerm, startDate, endDate, selectedSeller, saleTypeFilter) {
        app.showLoading(dom.historyTableContainer);
        dom.historyPaginationControls.classList.add('hidden');
        try {
            const teamUsernames = [app.currentUsername];
            const result = await app.callCloudFunction('listMySubResellers');
            if (result.success && result.data.length > 0) {
                teamUsernames.push(...result.data.map(sub => sub.username));
            }
            if (teamUsernames.length === 0) {
                return app.renderEmptyState(dom.historyTableContainer, 'Nenhum vendedor na sua equipe.');
            }

            let finalTeamFilter = teamUsernames;
            if (selectedSeller && teamUsernames.includes(selectedSeller)) {
                finalTeamFilter = [selectedSeller];
            }

            // --- INÍCIO DA CORREÇÃO ---
            // 1. Construímos a consulta base ao Firestore sem o filtro de tipo de venda.
            let query = db.collection("receipts").where('seller', 'in', finalTeamFilter);
            if (startDate) query = query.where('createdAt', '>=', startDate);
            if (endDate) query = query.where('createdAt', '<=', endDate);
            query = query.orderBy('createdAt', 'desc');

            const querySnapshot = await query.get();
            let docs = querySnapshot.docs;

            // 2. Aplicamos o filtro de tipo de venda e busca AQUI, no lado do cliente.
            if (saleTypeFilter === 'reseller') {
                docs = docs.filter(doc => doc.data().isResellerSale === true);
            } else if (saleTypeFilter === 'regular') {
                // Esta condição cobre os casos onde isResellerSale é `false` ou não existe (null/undefined)
                docs = docs.filter(doc => !doc.data().isResellerSale);
            }

            if (searchTerm) {
                docs = docs.filter(doc => (doc.data().customerName || '').toLowerCase().includes(searchTerm));
            }
            // --- FIM DA CORREÇÃO ---

            // 3. Renderizamos a lista já filtrada.
            app.renderAllSalesView(docs);

        } catch (error) {
            console.error("Erro ao carregar vendas da equipe:", error);
            dom.historyTableContainer.innerHTML = `<p style="color: var(--text-error);">Erro: ${error.message}</p>`;
        }
    },

    renderAllSalesView(docs) {
        const t = TRANSLATIONS[currentLang];
        let tableHTML = `<table><thead><tr>
                            <th><input type="checkbox" id="history-select-all" title="Selecionar Todos"></th>
                            <th>${t.historyCustomer}</th>`;
        if (app.isCurrentUserOwner || app.isCurrentUserAdmin || document.querySelector('input[name="history-view-mode"]:checked').value === 'team') {
          tableHTML += `<th>${t.historySeller}</th>`;
        }
        tableHTML += `<th>${t.historyTotal}</th><th>${t.historyDate}</th><th>Ações</th></tr></thead><tbody>`;
        docs.forEach(doc => {
            const data = doc.data();
            const resellerTagHtml = data.isResellerSale ? '<span class="reseller-tag">Revendedor</span>' : '';
            tableHTML += `<tr data-id="${doc.id}"><td><input type="checkbox" class="history-row-checkbox" data-id="${doc.id}"></td><td data-label="${t.historyCustomer}">${data.customerName || 'N/A'} ${resellerTagHtml}</td>`;
            if (app.isCurrentUserOwner || app.isCurrentUserAdmin || document.querySelector('input[name="history-view-mode"]:checked').value === 'team') {
              tableHTML += `<td data-label="${t.historySeller}">${(data.seller || 'N/A').split('@')[0]}</td>`;
            }
            tableHTML += `<td data-label="${t.historyTotal}">${app.formatCurrency(data.grandTotal || 0)}</td>
                          <td data-label="${t.historyDate}">${data.createdAt?.toDate ? data.createdAt.toDate().toLocaleString(currentLang) : 'N/A'}</td>
                          <td data-label="Ações" style="display: flex; gap: 8px; justify-content: center;">
                              <button class="btn-view-receipt" data-id="${doc.id}" title="Ver Recibo"><svg class="icon" style="margin-right:0;"><use xlink:href="#icon-receipt"></use></svg></button>`;
            if (app.isCurrentUserOwner) {
                tableHTML += `<button class="delete-history-btn btn-action delete" data-id="${doc.id}" title="Excluir"><svg class="icon" style="margin-right:0;"><use xlink:href="#icon-reset"></use></svg></button>`;
            }
            tableHTML += `</td></tr>`;
        });
        dom.historyTableContainer.innerHTML = tableHTML + `</tbody></table>`;
        app.updateSelectionActionsBar();
    },

    async renderSummaryView(searchTerm, startDate, endDate, selectedSeller, saleTypeFilter) {
      dom.historyPaginationControls.classList.add('hidden');
      let query = db.collection("receipts");
      if (saleTypeFilter === 'reseller') query = query.where('isResellerSale', '==', true);
      else if (saleTypeFilter === 'regular') query = query.where('isResellerSale', 'in', [false, null]);
      if (!app.isCurrentUserOwner && !app.isCurrentUserAdmin) query = query.where('seller', '==', app.currentUsername);
      else if (selectedSeller) query = query.where('seller', '==', selectedSeller);
      if (startDate) query = query.where('createdAt', '>=', startDate);
      if (endDate) query = query.where('createdAt', '<=', endDate);
      const allDocsSnapshot = await query.get();
      let docs = allDocsSnapshot.docs;
      if (searchTerm) docs = docs.filter(doc => (doc.data().customerName || '').toLowerCase().includes(searchTerm));
      if (docs.length === 0) return app.renderEmptyState(dom.historyTableContainer, TRANSLATIONS[currentLang].historyEmptyStateMessage);
      const customerSummary = {};
      docs.forEach(doc => {
          const data = doc.data();
          const customerName = data.customerName || 'Cliente Não Identificado';
          if (!customerSummary[customerName]) customerSummary[customerName] = { totalSpent: 0, salesCount: 0, lastSaleDate: null };
          customerSummary[customerName].totalSpent += data.grandTotal || 0;
          customerSummary[customerName].salesCount++;
          const saleDate = data.createdAt?.toDate(); 
          if (saleDate && (!customerSummary[customerName].lastSaleDate || saleDate > customerSummary[customerName].lastSaleDate)) {
              customerSummary[customerName].lastSaleDate = saleDate;
          }
      });
      const summaryArray = Object.keys(customerSummary).map(name => ({ name, ...customerSummary[name] })).sort((a, b) => b.totalSpent - a.totalSpent);
      let tableHTML = `<table><thead><tr><th>Cliente</th><th>Total Gasto</th><th>Nº de Compras</th><th>Última Compra</th></tr></thead><tbody>`;
      summaryArray.forEach(summary => {
          tableHTML += `<tr><td data-label="Cliente">${summary.name}</td><td data-label="Total Gasto">${app.formatCurrency(summary.totalSpent)}</td><td data-label="Nº de Compras">${summary.salesCount}</td><td data-label="Última Compra">${summary.lastSaleDate ? summary.lastSaleDate.toLocaleDateString(currentLang) : 'N/A'}</td></tr>`;
      });
      dom.historyTableContainer.innerHTML = tableHTML + `</tbody></table>`;
    },
    
    async populateHistorySellerFilter() {
        if (!app.isCurrentUserOwner && !app.isCurrentUserAdmin) return;
        dom.historySellerFilterContainer.classList.remove('hidden');
        const result = await app.callCloudFunction('listAllUsers');
        if (result.success) {
            dom.historySellerFilter.innerHTML = '<option value="">Todos os Vendedores</option>';
            result.data.forEach(user => {
                const username = user.email.split('@')[0];
                const option = document.createElement('option');
                option.value = username;
                option.textContent = username;
                dom.historySellerFilter.appendChild(option);
            });
        } else {
             dom.historySellerFilter.innerHTML = `<option value="">Erro</option>`;
        }
    },

    async loadDashboardData() {
        if (app.salesChartInstance) app.salesChartInstance.destroy();
        if (app.tokensChartInstance) app.tokensChartInstance.destroy();
        dom.totalSalesValue.textContent = 'Calculando...';
        dom.topCustomerName.textContent = 'Calculando...';
        dom.topCustomerValue.textContent = '';
        dom.topSellerCard.classList.add('hidden');
        try {
            let query = db.collection("receipts");
            if (!app.isCurrentUserOwner && !app.isCurrentUserAdmin) {
                query = query.where('seller', '==', app.currentUsername);
            }
            const querySnapshot = await query.get();
            const receipts = querySnapshot.docs.map(doc => doc.data());
            let myTotalSales = 0;
            const customerSales = {};
            const salesByUser = {};
            const salesByDay = {};
            const tokenCounts = {};
            receipts.forEach(receipt => {
                const saleAmount = receipt.grandTotal || 0;
                const seller = receipt.seller || 'N/A';
                const customer = receipt.customerName || 'N/A';
                if (seller === app.currentUsername) {
                    myTotalSales += saleAmount;
                    customerSales[customer] = (customerSales[customer] || 0) + saleAmount;
                }
                if (receipt.createdAt) {
                    const date = receipt.createdAt.toDate();
                    const dateString = new Date(date.getFullYear(), date.getMonth(), date.getDate()).toLocaleDateString(currentLang, { year: '2-digit', month: '2-digit', day: '2-digit' });
                    salesByDay[dateString] = (salesByDay[dateString] || 0) + saleAmount;
                }
                if (receipt.itemsData && typeof receipt.itemsData === 'object') {
                    for (const tokenKey in receipt.itemsData) {
                        tokenCounts[tokenKey] = (tokenCounts[tokenKey] || 0) + receipt.itemsData[tokenKey].qty;
                    }
                }
                if (app.isCurrentUserOwner || app.isCurrentUserAdmin) {
                    salesByUser[seller] = (salesByUser[seller] || 0) + saleAmount;
                }
            });
            dom.totalSalesValue.textContent = `M$ ${app.formatCurrency(myTotalSales)}`;
            const topCustomer = Object.entries(customerSales).sort((a, b) => b[1] - a[1])[0];
            if (topCustomer) {
                dom.topCustomerName.textContent = topCustomer[0];
                dom.topCustomerValue.innerHTML = `Comprou <b>M$ ${app.formatCurrency(topCustomer[1])}</b>`;
            } else {
                dom.topCustomerName.textContent = 'Nenhum';
                dom.topCustomerValue.textContent = 'Nenhuma venda registrada';
            }
            if (app.isCurrentUserOwner || app.isCurrentUserAdmin) {
                const topSeller = Object.entries(salesByUser).sort((a, b) => b[1] - a[1])[0];
                if (topSeller) {
                    dom.topSellerName.textContent = topSeller[0];
                    dom.topSellerValue.innerHTML = `Faturou <b>M$ ${app.formatCurrency(topSeller[1])}</b>`;
                    dom.topSellerCard.classList.remove('hidden');
                }
            }
            const sortedSales = Object.entries(salesByDay).sort((a, b) => new Date(a[0].split('/').reverse().join('-')) - new Date(b[0].split('/').reverse().join('-')));
            const salesLabels = sortedSales.map(entry => entry[0]);
            const salesData = sortedSales.map(entry => entry[1]);
            app.renderSalesChart(salesLabels, salesData);
            const tokenLabels = Object.keys(tokenCounts).map(key => ITENS_CATALOGO[key]?.[`name_${currentLang}`] || key);
            const tokenData = Object.values(tokenCounts);
            app.renderTokensChart(tokenLabels, tokenData);
        } catch (error) { 
            console.error("Erro ao carregar dados do dashboard:", error);
            dom.totalSalesValue.textContent = 'Erro';
            dom.topCustomerName.textContent = 'Erro';
        }
    },

    renderSalesChart(labels, data) {
        if (app.salesChartInstance) app.salesChartInstance.destroy();
        const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-primary').trim();
        const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text-primary');
        const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--grid-color');
        const accentRgb = app.utils.hexToRgb(accentColor, true);
        app.salesChartInstance = new Chart(dom.salesOverTimeChart, {
            type: 'line', 
            data: { 
                labels, 
                datasets: [{ 
                    label: 'Total de Vendas (Mush)', 
                    data, 
                    borderColor: accentColor, 
                    backgroundColor: `rgba(${accentRgb}, 0.2)`,
                    fill: true, 
                    tension: 0.1 
                }] 
            },
            options: { 
                responsive: true, 
                scales: { 
                    y: { ticks: { color: textColor, callback: (v) => app.formatCurrency(v) }, grid: { color: gridColor } }, 
                    x: { ticks: { color: textColor }, grid: { color: gridColor } } 
                }, 
                plugins: { 
                    legend: { labels: { color: textColor } }, 
                    tooltip: { callbacks: { label: (c) => `${c.dataset.label || ''}: ${app.formatCurrency(c.parsed.y)}` } } 
                } 
            }
        });
    },

    renderTokensChart(labels, data) {
        if (app.tokensChartInstance) app.tokensChartInstance.destroy();
        const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text-primary');
        const colorSet = { green: ['#34d399', '#10b981', '#059669', '#047857'], blue: ['#60a5fa', '#3b82f6', '#2563eb', '#1d4ed8'], purple: ['#a78bfa', '#8b5cf6', '#7c3aed', '#6d28d9'], yellow: ['#facc15', '#f59e0b', '#d97706', '#b45309'] };
        const currentAccent = dom.html.dataset.accentColor || 'green';
        app.tokensChartInstance = new Chart(dom.tokensSoldChart, {
            type: 'doughnut', data: { labels, datasets: [{ label: 'Quantidade Vendida', data, backgroundColor: colorSet[currentAccent], borderColor: getComputedStyle(document.body).getPropertyValue('--bg-primary'), borderWidth: 2 }] },
            options: { responsive: true, plugins: { legend: { position: 'top', labels: { color: textColor } } } }
        });
    },
    
    setLanguage(lang, shouldSave = true, skipReload = false) {
      currentLang = lang;
      if (shouldSave) localStorage.setItem('language', lang);
      document.querySelectorAll('[data-translate-key]').forEach(el => {
          const key = el.dataset.translateKey;
          const translation = TRANSLATIONS[lang][key];
          if (translation && typeof translation !== 'function') el.innerText = translation;
      });
      document.querySelectorAll('[data-translate-key-placeholder]').forEach(el => {
          const key = el.dataset.translateKeyPlaceholder;
          if (TRANSLATIONS[lang][key]) el.placeholder = TRANSLATIONS[lang][key];
      });
      document.title = TRANSLATIONS[lang].pageTitle;
      dom.langBr.classList.toggle('active', lang === 'br');
      dom.langEn.classList.toggle('active', lang === 'en');
      if (!skipReload) {
          app.loadTable();
          app.buildTokenFilters(dom.tokenFiltersContainer);
          app.updateUI();
      }
      if (shouldSave) app.saveUiPreferences();
    },

    toggleMode(mode) {
        const isDistributor = mode === 'mush';
        dom.distributorSection.style.display = isDistributor ? 'flex' : 'none';
        dom.tabelaItensBody.querySelectorAll('input[id^="qtd-"]').forEach(input => {
            input.disabled = isDistributor;
        });
        if (isDistributor) app.buildTokenFilters(dom.tokenFiltersContainer);
    },

    async toggleResellerMode(isChecked) {
        if (isChecked && dom.customResaleToggle.checked) dom.customResaleToggle.checked = false;
        dom.customResaleModeContainer.style.display = isChecked ? 'none' : 'flex';
        if (isChecked) {
            dom.customerNameContainer.classList.add('hidden');
            dom.resellerCustomerSelectionContainer.classList.remove('hidden');
            await app.populateResellerCustomerDropdown();
            app.checkResellerLimit();
        } else {
            dom.customerNameContainer.classList.remove('hidden');
            dom.resellerCustomerSelectionContainer.classList.add('hidden');
            dom.resellerLimitStatus.classList.add('hidden');
            clearInterval(app.resellerLimitInterval);
        }
        for (const key in ITENS_CATALOGO) {
            const priceInput = document.getElementById(`price-${key}`);
            if (priceInput) {
                priceInput.disabled = isChecked;
                priceInput.value = isChecked ? PRECOS_RESELLER[key] : (app.manualPrices[key] || ITENS_CATALOGO[key].preco);
            }
        }
        app.updateUI();
    },

    async populateResellerCustomerDropdown() {
        dom.resellerCustomerSelect.innerHTML = `<option value="">Selecione...</option><option value="manual">Digitar nome</option>`;
        const result = await app.callCloudFunction('listAllUsers');
        if (result.success && result.data.length > 0) {
            const sortedUsers = result.data.sort((a, b) => a.username.localeCompare(b.username));
            sortedUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.username;
                option.textContent = user.username;
                dom.resellerCustomerSelect.appendChild(option);
            });
        }
    },

    setTheme(theme, shouldSave = true) {
        dom.html.setAttribute('data-theme', theme);
        if(shouldSave) localStorage.setItem('theme', theme);
        if(!document.getElementById('dashboard-view').classList.contains('hidden')) app.loadDashboardData();
        if (shouldSave) app.saveUiPreferences();
    },

    setAccentColor(color, shouldSave = true) {
        dom.html.setAttribute('data-accent-color', color);
        if(shouldSave) localStorage.setItem('accentColor', color);
        document.querySelectorAll('.color-box').forEach(box => box.classList.toggle('active', box.dataset.color === color));
        if (!document.getElementById('dashboard-view').classList.contains('hidden')) app.loadDashboardData();
        if (shouldSave) app.saveUiPreferences();
    },

    buildTokenFilters(container) {
        container.innerHTML = '';
        for (const key in ITENS_CATALOGO) {
            const item = ITENS_CATALOGO[key];
            const label = document.createElement('label');
            label.innerHTML = `<input type="checkbox" value="${key}" checked><span>${item[`name_${currentLang}`]}</span>`;
            container.appendChild(label);
        }
        if (container.id === 'token-filters-container') container.dispatchEvent(new Event('change'));
    },

    getFormattedDate(date = new Date()) { return date.toISOString().slice(0, 10); },

    async checkResellerLimit() {
        if (!dom.resellerModeToggle.checked) {
            dom.resellerLimitStatus.classList.add('hidden');
            clearInterval(app.resellerLimitInterval);
            return;
        }
        let customerName = (dom.resellerCustomerSelect.value === 'manual' ? dom.resellerCustomerManualInput.value : dom.resellerCustomerSelect.value).trim().toLowerCase();
        if (!customerName) {
            dom.resellerLimitStatus.classList.add('hidden');
            clearInterval(app.resellerLimitInterval);
            app.currentCustomerUsage = { revive: 0, max: 0 };
            return;
        }
        const docId = `${customerName}_${app.getFormattedDate()}`;
        try {
            const docSnap = await db.collection('resellerLimits').doc(docId).get();
            app.currentCustomerUsage = docSnap.exists ? { revive: docSnap.data().reviveCount || 0, max: docSnap.data().maxCount || 0 } : { revive: 0, max: 0 };
            app.updateResellerLimitStatusUI();
            dom.resellerLimitStatus.classList.remove('hidden');
        } catch (error) {
            console.error("Erro ao verificar limite:", error);
            dom.resellerLimitStatus.classList.add('hidden');
        }
    },

    updateResellerLimitStatusUI() {
        clearInterval(app.resellerLimitInterval);
        const updateTimer = () => {
            const now = new Date();
            const endOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
            const diff = endOfDay - now;
            if (diff < 0) { app.checkResellerLimit(); return; }
            const hours = String(Math.floor(diff / 36e5)).padStart(2, '0');
            const minutes = String(Math.floor((diff % 36e5) / 6e4)).padStart(2, '0');
            const seconds = String(Math.floor((diff % 6e4) / 1000)).padStart(2, '0');
            dom.resellerLimitStatus.innerHTML = TRANSLATIONS[currentLang].resellerLimitStatus(
                app.currentCustomerUsage.revive, app.currentCustomerUsage.max, app.CONFIG.RESELLER_DAILY_LIMIT, `${hours}:${minutes}:${seconds}`
            );
        };
        updateTimer();
        app.resellerLimitInterval = setInterval(updateTimer, 1000);
    },

    loadTable() {
        const tfootTD = dom.calculatorTable.querySelector('tfoot td:first-child');
        tfootTD.setAttribute('colspan', '3'); 
        tfootTD.nextElementSibling.id = 'totalGeral'; 
        tfootTD.nextElementSibling.style.textAlign = 'center';
    
        dom.tabelaItensBody.innerHTML = '';
        const t = TRANSLATIONS[currentLang];
        for (const key in ITENS_CATALOGO) {
            const item = ITENS_CATALOGO[key];
            const tr = document.createElement('tr');
            tr.innerHTML = `<td data-label="${t.tableItem}">${item[`name_${currentLang}`]}</td>
                <td data-label="${t.tablePrice}"><div style="width:100px;margin:0 auto;"><input type="number" class="price-input" id="price-${key}" step="10"></div></td>
                <td data-label="Preço c/ Desc." class="discounted-price-col"><span class="discounted-price-value" id="discounted-price-${key}">-</span></td>
                <td data-label="${t.tableQty}"><div style="width:80px;margin:0 auto;"><input type="number" id="qtd-${key}" value="0" min="0"></div></td>
                <td data-label="${t.tableTotal}">0,00</td>`;
            tr.querySelector('td:last-child').appendChild(app.createCoinIcon());
            dom.tabelaItensBody.appendChild(tr);
            tr.querySelector(`#qtd-${key}`).addEventListener('input', () => { app.updateUI(); app.triggerSaveCalculatorPreferences(); });
            tr.querySelector(`#price-${key}`).addEventListener('input', (event) => app.handlePriceChange(event, key));
        }
        app.applyManualOrCatalogPrices();
        app.updateUI();
    },

    handlePriceChange(event, key) {
        const input = event.target;
        let novoPreco = parseFloat(input.value);
        if (isNaN(novoPreco)) return;
        const precoMinimo = PRECOS_MINIMOS[key];
        if (!app.isCurrentUserOwner && novoPreco < precoMinimo) {
            app.showNotification(`O valor mínimo para este item é ${precoMinimo}.`, 'error');
            novoPreco = precoMinimo;
            input.value = novoPreco;
        }
        if (novoPreco < 0) input.value = 0;
        app.manualPrices[key] = novoPreco;
        app.updateUI();
        app.triggerSaveCalculatorPreferences();
    },

    openResaleModal() {
        app.populateResaleModalInputs();
        dom.resalePriceModal.classList.remove('hidden');
    },

    populateResaleModalInputs() {
        for (const key in ITENS_CATALOGO) {
            const input = document.getElementById(`resale-price-${key}`);
            if (input) input.value = app.customResalePrices[key] || '';
        }
    },

    async saveResalePrices() {
        const pricesToSave = {};
        for (const key in ITENS_CATALOGO) {
            const input = document.getElementById(`resale-price-${key}`);
            const value = parseFloat(input.value);
            if (!isNaN(value) && value > 0) pricesToSave[key] = value;
        }
        app.customResalePrices = pricesToSave;
        await app.saveCustomResalePricesToFirestore();
        dom.resalePriceModal.classList.add('hidden');
        if (dom.customResaleToggle.checked) app.toggleCustomResaleMode(true);
    },
    
    toggleCustomResaleMode(isChecked) {
        if (isChecked && dom.resellerModeToggle.checked) {
            dom.resellerModeToggle.checked = false;
            app.toggleResellerMode(false);
        }
        for (const key in ITENS_CATALOGO) {
            const priceInput = document.getElementById(`price-${key}`);
            if (priceInput) {
                priceInput.disabled = isChecked;
                if (isChecked) {
                    priceInput.value = app.customResalePrices[key] || ITENS_CATALOGO[key].preco;
                } else {
                    app.applyManualOrCatalogPrices();
                }
            }
        }
        app.updateUI();
    },

    applyManualOrCatalogPrices() {
        for (const key in ITENS_CATALOGO) {
            const priceInput = document.getElementById(`price-${key}`);
            if (priceInput) priceInput.value = app.manualPrices[key] || ITENS_CATALOGO[key].preco;
        }
    },

    formatCurrency(number) { return (number || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); },

    calculateValues() {
        const descontoPercentual = parseFloat(dom.descontoInput.value) || 0;
        const fatorDesconto = 1 - (descontoPercentual / 100);
        let totalFinal = 0;
        const itensCalculados = {};
        const isResellerMode = dom.resellerModeToggle.checked;
        const isCustomResaleMode = dom.customResaleToggle.checked;
        let reviveLimitRemaining = app.CONFIG.RESELLER_DAILY_LIMIT - app.currentCustomerUsage.revive;
        let maxLimitRemaining = app.CONFIG.RESELLER_DAILY_LIMIT - app.currentCustomerUsage.max;
        for (const key in ITENS_CATALOGO) {
            const precoBase = ITENS_CATALOGO[key].preco;
            const quantidade = parseInt(document.getElementById(`qtd-${key}`)?.value) || 0;
            let subtotal = 0;
            let precoAplicado;
            if (isResellerMode) {
                precoAplicado = PRECOS_RESELLER[key];
                if(key === 'revive' || key === 'max'){
                    const limitRemaining = (key === 'revive') ? reviveLimitRemaining : maxLimitRemaining;
                    const tokensDentroDoLimite = Math.max(0, Math.min(quantidade, limitRemaining));
                    const tokensForaDoLimite = Math.max(0, quantidade - tokensDentroDoLimite);
                    subtotal += tokensDentroDoLimite * PRECOS_RESELLER[key];
                    subtotal += tokensForaDoLimite * precoBase;
                } else { subtotal = quantidade * PRECOS_RESELLER[key]; }
            } else if (isCustomResaleMode) {
                precoAplicado = (quantidade > 84 && PRECOS_VOLUME[key]) ? PRECOS_VOLUME[key] : (app.customResalePrices[key] || precoBase);
                subtotal = quantidade * precoAplicado;
            } else {
                precoAplicado = parseFloat(document.getElementById(`price-${key}`)?.value) || precoBase;
                subtotal = quantidade * (precoAplicado * fatorDesconto);
            }
            totalFinal += subtotal;
            itensCalculados[key] = { quantidade, precoUnitario: precoAplicado, subtotal };
        }
        return { totalFinal, descontoPercentual, itens: itensCalculados };
    },

    updateUI() {
        const calculo = app.calculateValues();
        if (!calculo) return;

        const isDiscountApplicable = !dom.resellerModeToggle.checked && !dom.customResaleToggle.checked;
        const fatorDesconto = 1 - (calculo.descontoPercentual / 100);
        const tfootTD = dom.calculatorTable.querySelector('tfoot td:first-child');
        const showDiscount = isDiscountApplicable && calculo.descontoPercentual > 0;
        dom.calculatorTable.classList.toggle('show-discount', showDiscount);
        tfootTD.setAttribute('colspan', showDiscount ? '4' : '3');

        Array.from(dom.tabelaItensBody.rows).forEach((row, index) => {
            const key = Object.keys(ITENS_CATALOGO)[index];
            const itemCalculado = calculo.itens[key];
            const priceInput = document.getElementById(`price-${key}`);

            // --- INÍCIO DA MODIFICAÇÃO (Preço dinâmico para Revenda) ---
            if (dom.customResaleToggle.checked && priceInput) {
                priceInput.value = itemCalculado.precoUnitario;
            }
            // --- FIM DA MODIFICAÇÃO ---

            const discountedPriceCell = row.querySelector(`#discounted-price-${key}`);
            if (discountedPriceCell) {
                if (showDiscount) {
                    const precoOriginal = parseFloat(document.getElementById(`price-${key}`).value) || ITENS_CATALOGO[key].preco;
                    const precoFinal = precoOriginal * fatorDesconto;
                    discountedPriceCell.textContent = app.formatCurrency(precoFinal);
                } else {
                    discountedPriceCell.textContent = '-';
                }
            }

            const totalCell = row.cells[row.cells.length - 1];
            totalCell.innerHTML = `${app.formatCurrency(itemCalculado.subtotal)} `;
            totalCell.appendChild(app.createCoinIcon());
        });

        dom.totalGeralCell.innerHTML = `<b>${app.formatCurrency(calculo.totalFinal)}</b> `;
        dom.totalGeralCell.appendChild(app.createCoinIcon());
    },

    reset({ fullReset = false } = {}) {
        if (fullReset) {
            dom.nomeClienteInput.value = '';
            dom.resellerCustomerSelect.value = '';
            dom.resellerCustomerManualInput.value = '';
            dom.resellerCustomerManualInput.classList.add('hidden');
            dom.descontoInput.value = '';
            
            // --- INÍCIO DA CORREÇÃO (Reset explícito dos toggles) ---
            dom.resellerModeToggle.checked = false;
            app.toggleResellerMode(false); // Chama a função para reverter as mudanças de UI associadas
            
            dom.customResaleToggle.checked = false;
            app.toggleCustomResaleMode(false); // Chama a função para reverter as mudanças de UI associadas
            // --- FIM DA CORREÇÃO ---
            
            app.manualPrices = {};
            app.applyManualOrCatalogPrices();
            app.checkResellerLimit();
        }
        dom.totalMushInput.value = '';
        dom.leftoverMushDiv.innerHTML = '';
        dom.leftoverDistributorSection.classList.add('hidden');
        Object.keys(ITENS_CATALOGO).forEach(key => {
            const qtdInput = document.getElementById(`qtd-${key}`);
            if (qtdInput) qtdInput.value = 0;
        });
        app.updateUI();
        app.triggerSaveCalculatorPreferences();
    },

    distributeMush() {
        const totalMush = parseFloat(dom.totalMushInput.value) || 0;
        app.reset({ fullReset: false }); 
        if (totalMush <= 0) { app.updateUI(); return; }
        const selectedTokenKeys = Array.from(dom.tokenFiltersContainer.querySelectorAll('input:checked')).map(cb => cb.value);
        if (selectedTokenKeys.length === 0) { app.showNotification(TRANSLATIONS[currentLang].alertNoItems, 'error'); return; }
        let tokens = selectedTokenKeys.map(key => ({ key, preco: parseFloat(document.getElementById(`price-${key}`).value) || ITENS_CATALOGO[key].preco, quantidade: 0 }));
        if (tokens.length === 2 && document.querySelector('input[name="two-token-strategy"]:checked').value === 'split') {
            const mushPerToken = totalMush / 2;
            tokens.forEach(token => { if (token.preco > 0) token.quantidade = Math.floor(mushPerToken / token.preco); });
        } else {
            app.runFairDistribution(tokens, totalMush);
        }
        app.updateDistributionUI(tokens, totalMush);
    },

    distributeLeftoverMush() {
        const selectedTokenKeys = Array.from(dom.leftoverTokenFiltersContainer.querySelectorAll('input:checked')).map(cb => cb.value);
        if (selectedTokenKeys.length === 0) { app.showNotification(TRANSLATIONS[currentLang].alertNoItems, 'error'); return; }
        let tokens = selectedTokenKeys.map(key => ({ key, preco: parseFloat(document.getElementById(`price-${key}`).value) || ITENS_CATALOGO[key].preco, quantidade: 0 }));
        app.runFairDistribution(tokens, app.currentLeftover);
        tokens.forEach(token => {
            const qtyInput = document.getElementById(`qtd-${token.key}`);
            qtyInput.value = (parseInt(qtyInput.value) || 0) + token.quantidade;
        });
        app.updateDistributionUI([], parseFloat(dom.totalMushInput.value) || 0);
    },

    runFairDistribution(tokens, totalMush) {
        tokens.sort(() => Math.random() - 0.5);
        let mushRestante = totalMush;
        let comprouNestaRodada = true;
        while(comprouNestaRodada) {
            comprouNestaRodada = false;
            for (const token of tokens) {
                if (mushRestante >= token.preco && token.preco > 0) {
                    token.quantidade++;
                    mushRestante -= token.preco;
                    comprouNestaRodada = true;
                }
            }
        }
        return tokens;
    },

    updateDistributionUI(tokens, totalMushInputted) {
        tokens.forEach(token => { document.getElementById(`qtd-${token.key}`).value = token.quantidade; });
        const calculoAtual = app.calculateValues();
        app.currentLeftover = totalMushInputted - calculoAtual.totalFinal;
        dom.leftoverMushDiv.innerHTML = `${TRANSLATIONS[currentLang].leftoverMushText} <b>${app.formatCurrency(app.currentLeftover)}</b> `;
        dom.leftoverMushDiv.appendChild(app.createCoinIcon());
        const cheapestPrice = Math.min(...Object.values(ITENS_CATALOGO).map(item => item.preco));
        if (app.currentLeftover >= cheapestPrice) {
            dom.leftoverDistributorSection.classList.remove('hidden');
            app.buildTokenFilters(dom.leftoverTokenFiltersContainer);
        } else {
            dom.leftoverDistributorSection.classList.add('hidden');
        }
        app.updateUI();
    },

    createCoinIcon() {
        const img = document.createElement('img');
        img.src = MOEDA_BASE64;
        img.style.cssText = 'width: 16px; height: 16px; vertical-align: middle; margin-left: 4px;';
        img.alt = 'mush';
        return img;
    },

    buildReceiptHtml(receiptData, docId) {
        const t = TRANSLATIONS[currentLang];
        const coinIconHtml = `<img src="${MOEDA_BASE64}" class="coin-icon" alt="mush">`;
        let subtotalBruto = 0;
        let itemsTableRows = '';
        const fatorDesconto = 1 - (receiptData.discountApplied || 0) / 100;
        for (const key in receiptData.itemsData) {
            const item = receiptData.itemsData[key];
            const catalogoItem = ITENS_CATALOGO[key];
            if (item.qty > 0 && catalogoItem) {
                const precoOriginal = item.price; // O preço já vem correto do prepareSaleData
                const subtotalItemSemDesconto = item.qty * precoOriginal;
                subtotalBruto += subtotalItemSemDesconto;
                itemsTableRows += `<tr><td>${catalogoItem[`name_${currentLang}`]} x ${item.qty}</td><td>${app.formatCurrency(precoOriginal)}${coinIconHtml}</td><td>${app.formatCurrency(subtotalItemSemDesconto * fatorDesconto)}${coinIconHtml}</td></tr>`;
            }
        }
        const valorDesconto = subtotalBruto - receiptData.grandTotal;
        const dataVenda = receiptData.createdAt?.toDate ? receiptData.createdAt.toDate().toLocaleString(currentLang) : new Date().toLocaleString(currentLang);
        const resellerTagHtml = receiptData.isResellerSale ? `<span style="font-size: 0.9em; color: var(--accent-warning); font-weight: bold;">(Revendedor)</span>` : '';
        return `<div class="receipt-body"><div class="receipt-header"><h2>${t.receiptHeader}</h2><p>${receiptData.customerName} ${resellerTagHtml}</p><p>${t.receiptSeller}: ${receiptData.seller}</p><p class="receipt-id">${t.receiptTransactionId}: ${docId}</p></div><div class="receipt-section-title">${t.receiptItemsHeader}</div><table class="receipt-items-table"><thead><tr><th>Item</th><th>${t.receiptUnitPrice}</th><th>Total</th></tr></thead><tbody>${itemsTableRows}</tbody></table><div class="receipt-totals"><div><span>${t.receiptSubtotal}:</span> <span>${app.formatCurrency(subtotalBruto)}${coinIconHtml}</span></div><div><span>${t.receiptDiscount} (${receiptData.discountApplied || 0}%):</span> <span>-${app.formatCurrency(valorDesconto)}${coinIconHtml}</span></div><div class="final-total"><span>${t.receiptFinalTotal}:</span> <span>${app.formatCurrency(receiptData.grandTotal)}${coinIconHtml}</span></div></div><div class="receipt-footer"><p>${dataVenda}</p><p>${t.receiptThanks}</p></div></div>`;
    },
    
    async processSaleAndGenerateReceipt() {
        const receiptData = app.prepareSaleData();
        if (!receiptData) return;
        const savedDoc = await app.saveSaleAndUpdateLimits(receiptData);
        if (!savedDoc) return; 
        await app.createAndDownloadReceiptImage(receiptData, savedDoc.id);
        app.reset({ fullReset: true });
    },

    prepareSaleData() {
        const calculo = app.calculateValues();
        if (!calculo || Object.values(calculo.itens).every(item => item.quantidade === 0)) {
            app.showNotification(TRANSLATIONS[currentLang].alertNoItems, 'error');
            return null;
        }
        if (dom.resellerModeToggle.checked) {
            const reviveQty = calculo.itens.revive?.quantidade || 0;
            const maxQty = calculo.itens.max?.quantidade || 0;
            const reviveLimitRemaining = app.CONFIG.RESELLER_DAILY_LIMIT - app.currentCustomerUsage.revive;
            const maxLimitRemaining = app.CONFIG.RESELLER_DAILY_LIMIT - app.currentCustomerUsage.max;
            if (reviveQty > reviveLimitRemaining || maxQty > maxLimitRemaining) {
                app.showNotification(TRANSLATIONS[currentLang].resellerLimitExceededWarning, 'error');
            }
        }
        const isResellerMode = dom.resellerModeToggle.checked;
        const isCustomResaleMode = dom.customResaleToggle.checked;
        let customerName = isResellerMode ? (dom.resellerCustomerSelect.value === 'manual' ? dom.resellerCustomerManualInput.value.trim() : dom.resellerCustomerSelect.value) || 'Revendedor_Nao_Identificado' : dom.nomeClienteInput.value.trim() || 'Nao_Identificado';
        const itemsToSave = {};
        for (const key in calculo.itens) {
            if (calculo.itens[key].quantidade > 0) {
                 itemsToSave[key] = { qty: calculo.itens[key].quantidade, price: parseFloat(document.getElementById(`price-${key}`).value) || ITENS_CATALOGO[key].preco };
            }
        }
        return { customerName, discountApplied: calculo.descontoPercentual, grandTotal: calculo.totalFinal, itemsData: itemsToSave, seller: app.currentUsername, isResellerSale: isResellerMode, isCustomResale: isCustomResaleMode, createdAt: firebase.firestore.FieldValue.serverTimestamp() };
    },

    async saveSaleAndUpdateLimits(receiptData) {
        try {
            const docRef = await db.collection("receipts").add(receiptData);
            if (receiptData.isResellerSale && receiptData.customerName !== 'Revendedor_Nao_Identificado') {
                const reviveComprados = receiptData.itemsData.revive?.qty || 0;
                const maxComprados = receiptData.itemsData.max?.qty || 0;
                if (reviveComprados > 0 || maxComprados > 0) {
                    const customerNameForDb = receiptData.customerName.toLowerCase();
                    const dateStr = app.getFormattedDate();
                    const docId = `${customerNameForDb}_${dateStr}`;
                    const limitRef = db.collection('resellerLimits').doc(docId);
                    const updateData = { customerName: customerNameForDb, date: dateStr, lastUpdatedBy: auth.currentUser.email };
                    if (reviveComprados > 0) updateData.reviveCount = firebase.firestore.FieldValue.increment(reviveComprados);
                    if (maxComprados > 0) updateData.maxCount = firebase.firestore.FieldValue.increment(maxComprados);
                    await limitRef.set(updateData, { merge: true });
                    app.currentCustomerUsage.revive += reviveComprados;
                    app.currentCustomerUsage.max += maxComprados;
                    app.updateResellerLimitStatusUI();
                }
            }
            return docRef;
        } catch (e) {
            console.error("Erro ao salvar no Firestore: ", e);
            app.showNotification("Houve um erro ao salvar o recibo.", 'error');
            return null;
        }
    },

    async createAndDownloadReceiptImage(receiptData, docId, silent = false) {
        const receiptDataWithDate = { ...receiptData, createdAt: receiptData.createdAt?.toDate ? { toDate: () => receiptData.createdAt.toDate() } : { toDate: () => new Date() } };
        const receiptHtml = app.buildReceiptHtml(receiptDataWithDate, docId);
        dom.receiptGeneratorContainer.innerHTML = receiptHtml;
        dom.receiptGeneratorContainer.style.display = 'flex';
        const receiptBody = dom.receiptGeneratorContainer.querySelector('.receipt-body');
        try {
            await new Promise(resolve => requestAnimationFrame(resolve));
            const canvas = await html2canvas(receiptBody, {
                scale: 2, useCORS: true, backgroundColor: getComputedStyle(receiptBody).getPropertyValue('background-color'), logging: false,
            });
            const dataUrl = canvas.toDataURL('image/png');
            if (!dataUrl || dataUrl === 'data:,') {
                 throw new Error('Canvas retornou uma URL de dados vazia.');
            }
            const link = document.createElement('a');
            const nomeSanitizado = (receiptData.customerName || 'recibo').normalize('NFD').replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '_').replace(/[^\w-]/g, '');
            const dateStr = receiptDataWithDate.createdAt.toDate().toISOString().slice(0, 10);
            link.download = `${nomeSanitizado}_${dateStr}.png`;
            link.href = dataUrl;
            link.click();
        } catch (error) {
            console.error("Erro no html2canvas:", error);
            if (!silent) { app.showNotification("Falha ao gerar a imagem do recibo. Tente novamente.", "error"); }
        } finally {
            dom.receiptGeneratorContainer.style.display = 'none';
            dom.receiptGeneratorContainer.innerHTML = '';
        }
    },

    async regenerateReceipt(docId, silent = false) {
        if (!docId) return;
        try {
            const docRef = db.collection('receipts').doc(docId);
            const docSnap = await docRef.get();
            if (!docSnap.exists) {
              if (!silent) app.showNotification("Erro: Recibo não encontrado.", 'error');
              return;
            }
            const receiptData = docSnap.data();
            await app.createAndDownloadReceiptImage(receiptData, docId, silent);
        } catch (error) {
            console.error("Erro ao regenerar recibo:", error);
            if (!silent) { app.showNotification("Ocorreu um erro ao buscar os dados do recibo.", 'error'); }
        }
    },

    async openTxtExportModal() {
        app.showLoading(dom.customerListForExport);
        dom.txtExportModal.classList.remove('hidden');
        const searchTerm = dom.historySearchInput.value.toLowerCase().trim();
        let startDate = dom.historyDateStart.value ? new Date(dom.historyDateStart.value + 'T00:00:00') : null;
        let endDate = dom.historyDateEnd.value ? new Date(dom.historyDateEnd.value + 'T23:59:59') : null;
        let query = db.collection("receipts");
        if (startDate) query = query.where('createdAt', '>=', startDate);
        if (endDate) query = query.where('createdAt', '<=', endDate);
        try {
            const allDocsSnapshot = await query.get();
            let docs = allDocsSnapshot.docs.filter(doc => !searchTerm || (doc.data().customerName || '').toLowerCase().includes(searchTerm));
            if (docs.length === 0) {
                app.renderEmptyState(dom.customerListForExport, TRANSLATIONS[currentLang].historyNoRecords);
                return;
            }
            const customerSummary = {};
            docs.forEach(doc => {
                const data = doc.data();
                const customerName = data.customerName || 'Cliente Não Identificado';
                customerSummary[customerName] = (customerSummary[customerName] || 0) + (data.grandTotal || 0);
            });
            const summaryArray = Object.entries(customerSummary).map(([name, totalSpent]) => ({ name, totalSpent })).sort((a, b) => b.totalSpent - a.totalSpent);
            dom.customerListForExport.innerHTML = '';
            dom.selectAllCustomersCheckbox.checked = false;
            summaryArray.forEach(summary => {
                const label = document.createElement('label');
                label.innerHTML = `
                  <input type="checkbox" value="${summary.name}" data-total="${summary.totalSpent}">
                  <div class="customer-info"><span>${summary.name}</span><span class="customer-total">M$ ${app.formatCurrency(summary.totalSpent)}</span></div>`;
                dom.customerListForExport.appendChild(label);
            });
        } catch (error) {
            console.error("Erro ao gerar resumo para exportação:", error);
            dom.customerListForExport.innerHTML = `<p style="color: var(--text-error);">${TRANSLATIONS[currentLang].errorGeneric}</p>`;
        }
    },

    handleSelectAllCustomers(event) {
        dom.customerListForExport.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
          checkbox.checked = event.target.checked;
        });
    },

    generateTxtFile() {
        const checkedCustomers = dom.customerListForExport.querySelectorAll('input[type="checkbox"]:checked');
        if (checkedCustomers.length === 0) {
          app.showNotification("Nenhum cliente selecionado para exportar.", 'error');
          return;
        }
        const linesToExport = Array.from(checkedCustomers).map(checkbox => {
            const totalSpent = parseFloat(checkbox.dataset.total);
            return `${checkbox.value}: M$ ${app.formatCurrency(totalSpent)}`;
        });
        const fileContent = linesToExport.join('\r\n');
        const blob = new Blob([fileContent], { type: 'text/plain;charset=utf-8' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `Relatorio_Clientes_${new Date().toISOString().slice(0, 10)}.txt`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        dom.txtExportModal.classList.add('hidden');
    }
  };

  app.init();
</script>
</body>
</html>
