<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
<meta charset="UTF-8">
<title>Calculadora de Tokens</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Poppins:wght@700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>

<style>
  :root {
    --font-header: 'Poppins', sans-serif;
    --font-body: 'Inter', sans-serif;
    --bg-primary: #18181b;
    --bg-secondary: #27272a;
    --bg-tertiary: #3f3f46;
    --border-color: #3f3f46;
    --accent-primary: #34d399;
    --accent-hover: #10b981;
    --accent-danger: #f43f5e;
    --text-primary: #f8fafc;
    --text-secondary: #a1a1aa;
    --text-error: #fca5a5;
  }

  html[data-theme='light'] {
    --bg-primary: #f4f4f5;
    --bg-secondary: #ffffff;
    --bg-tertiary: #e4e4e7;
    --border-color: #d4d4d8;
    --accent-primary: #10b981;
    --accent-hover: #0f9a6c;
    --accent-danger: #ef4444;
    --text-primary: #18181b;
    --text-secondary: #71717a;
    --text-error: #b91c1c;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background-color: var(--bg-primary);
    color: var(--text-primary);
    font-family: var(--font-body);
    padding: 40px 20px;
    transition: background-color 0.3s ease, color 0.3s ease;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    min-height: 100vh;
  }

  .hidden { display: none !important; }

  #auth-container {
    width: 100%;
    max-width: 400px;
    background: var(--bg-secondary);
    padding: 32px;
    border-radius: 16px;
    border: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    gap: 24px;
    margin-top: 10vh;
  }
  
  #app-container {
    width: 100%;
    max-width: 800px;
  }

  .container {
    width: 100%;
    background: var(--bg-secondary);
    padding: 32px;
    border-radius: 16px;
    border: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    gap: 24px;
  }
  
  .settings-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
  }
  .settings-controls { display: flex; align-items: center; gap: 16px;}
  #logged-in-user { font-size: 14px; color: var(--text-secondary); }
  #logged-in-user .username { font-weight: 700; color: var(--text-primary); }
  .language-switcher button { background: none; border: none; padding: 4px; cursor: pointer; transition: all 0.3s ease; }
  .language-switcher button:not(.active) { filter: grayscale(100%); opacity: 0.6; }
  html[data-theme='dark'] .language-switcher button:not(.active) { filter: grayscale(100%) invert(100%); opacity: 0.8; }
  .language-switcher button.active, .language-switcher button:not(.active):hover { filter: none; opacity: 1; transform: scale(1.1); }
  
  .theme-switcher { display: flex; align-items: center; gap: 8px; }
  .theme-switcher-label { font-size: 12px; color: var(--text-secondary); font-weight: 500; }
  .toggle-track { width: 44px; height: 24px; background-color: var(--bg-tertiary); border-radius: 99px; position: relative; cursor: pointer; transition: background-color 0.3s ease; }
  .toggle-thumb { width: 18px; height: 18px; background-color: white; border-radius: 50%; position: absolute; top: 3px; left: 4px; transition: transform 0.3s ease; }
  html[data-theme='light'] .toggle-track { background-color: var(--accent-primary); }
  html[data-theme='light'] .toggle-thumb { transform: translateX(19px); }

  h2 { font-family: var(--font-header); color: var(--accent-primary); font-size: 28px; font-weight: 700; text-align: center; margin-bottom: 8px;}
  .input-group { display: flex; flex-direction: column; gap: 8px; }
  .input-group label { font-size: 14px; font-weight: 500; color: var(--text-secondary); }

  input[type="text"], input[type="number"], input[type="password"], input[type="date"] {
    width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--bg-tertiary); color: var(--text-primary); font-size: 16px; transition: all 0.3s ease;
  }
  input[type="text"]:focus, input[type="number"]:focus, input[type="password"]:focus, input[type="date"]:focus {
    outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px rgba(52, 211, 153, 0.3);
  }

  #auth-error { color: var(--text-error); font-size: 14px; text-align: center; min-height: 20px; }

  .tab-navigation { display: flex; border-bottom: 1px solid var(--border-color); }
  .tab-link { padding: 12px 20px; cursor: pointer; background: none; border: none; color: var(--text-secondary); font-weight: 600; font-size: 16px; border-bottom: 3px solid transparent; transition: all 0.3s ease; font-family: var(--font-body); }
  .tab-link:hover { color: var(--text-primary); }
  .tab-link.active { color: var(--accent-primary); border-bottom-color: var(--accent-primary); }
  .tab-content { padding-top: 24px; display: flex; flex-direction: column; gap: 24px; }
  
  .mode-selector { display: flex; gap: 20px; background-color: var(--bg-tertiary); padding: 6px; border-radius: 10px; width: fit-content; }
  .mode-selector label { padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; }
  .mode-selector input[type="radio"] { display: none; }
  .mode-selector input[type="radio"]:checked + label { background-color: var(--bg-secondary); color: var(--accent-primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

  .distributor-container { background-color: rgba(120, 120, 120, 0.05); border: 1px dashed var(--border-color); padding: 24px; border-radius: 12px; display: flex; flex-direction: column; gap: 20px; }
  .token-filters { display: flex; flex-wrap: wrap; gap: 12px 20px; }
  .token-filters label { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px; }
  .distributor-controls { display: flex; gap: 16px; align-items: center; }
  .distributor-controls .input-group { flex-grow: 1; }
  #leftover-mush { margin-top: 16px; font-weight: 500; color: var(--text-secondary); }
  #leftover-mush span { color: var(--accent-primary); font-weight: 700; }
  
  table { width: 100%; border-collapse: collapse; }
  th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border-color); transition: background-color 0.3s ease; }
  td:nth-child(3), td:nth-child(4), th:nth-child(3), th:nth-child(4) { text-align: center; }
  th { font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
  tbody tr:hover { background-color: rgba(120, 120, 120, 0.05); }
  tfoot td { border-bottom: none; }
  tfoot b { color: var(--accent-primary); }
  
  .buttons { display: flex; justify-content: center; gap: 12px; margin-top: 16px; flex-wrap: wrap;}
  button { padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: transform 0.15s ease, background-color 0.2s, color 0.2s, box-shadow 0.2s; border: none; }
  button:hover { transform: translateY(-2px) scale(1.02); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); }
  #btnCalcular, #btnDistribute, #btnLogin, #history-apply-filter-btn { background: var(--accent-primary); color: #fff; }
  #btnCalcular:hover, #btnDistribute:hover, #btnLogin:hover, #history-apply-filter-btn:hover { background: var(--accent-hover); }
  #btnResetar { background: var(--accent-danger); color: var(--text-primary); }
  #btnGerarImagem, #btnLogout, #btnDistributeLeftover { background: var(--bg-tertiary); color: var(--text-primary); }
</style>
</head>
<body>

<div id="auth-container">
    <h2 data-translate-key="loginHeader">Login</h2>
    <div class="input-group">
        <label for="username-input" data-translate-key="usernameLabel">Usuário</label>
        <input type="text" id="username-input" autocomplete="username">
    </div>
    <div class="input-group">
        <label for="password-input" data-translate-key="passwordLabel">Senha</label>
        <input type="password" id="password-input" autocomplete="current-password">
    </div>
    <p id="auth-error"></p>
    <button id="btnLogin" data-translate-key="loginButton">Entrar</button>
</div>

<div id="app-container" class="hidden">
    <div class="container">
      <div class="settings-bar">
          <div class="language-switcher">
              <button id="lang-br">🇧🇷</button>
              <button id="lang-en">🇺🇸</button>
          </div>
          <div class="settings-controls">
              <div class="theme-switcher">
                  <span class="theme-switcher-label" data-translate-key="themeLabel"></span>
                  <div class="toggle-track" id="theme-toggle">
                      <div class="toggle-thumb"></div>
                  </div>
              </div>
              <div id="logged-in-user"></div>
              <button id="btnLogout" data-translate-key="logoutButton">Sair</button>
          </div>
      </div>

      <div class="tab-navigation">
          <button class="tab-link active" data-tab="calculator-view" data-translate-key="tabCalculator">Calculadora</button>
          <button class="tab-link" data-tab="history-view" data-translate-key="tabHistory">Histórico</button>
      </div>

      <div id="calculator-view" class="tab-content active">
          <h2 data-translate-key="mainHeader">Calculadora de Tokens</h2>
          <div class="input-group">
            <label for="nomeCliente" data-translate-key="idLabel">Identificador / Nome</label>
            <input type="text" id="nomeCliente" data-translate-key-placeholder="idPlaceholder">
          </div>
          <div class="input-group">
            <label for="desconto" data-translate-key="discountLabel">Desconto (%)</label>
            <input type="number" id="desconto" data-translate-key-placeholder="discountPlaceholder" min="0" max="100">
          </div>
          <div class="input-group">
              <label data-translate-key="calculationMode">Modo de Cálculo</label>
              <div class="mode-selector">
                  <input type="radio" id="mode-qty" name="calculation-mode" value="quantity" checked>
                  <label for="mode-qty" data-translate-key="modeQty">Por Quantidade</label>
                  <input type="radio" id="mode-mush" name="calculation-mode" value="mush">
                  <label for="mode-mush" data-translate-key="modeMush">Por Mush</label>
              </div>
          </div>
          <div class="distributor-container" id="distributor-section" style="display: none;">
              <div>
                  <label data-translate-key="distributeTokensLabel">Tokens Desejáveis para Distribuição</label>
                  <div class="token-filters" id="token-filters-container"></div>
              </div>

              <div id="two-token-options" class="hidden" style="margin-top: 10px;">
                  <label>Estratégia para 2 tokens:</label>
                  <div class="mode-selector">
                      <input type="radio" id="strategy-fair" name="two-token-strategy" value="fair" checked>
                      <label for="strategy-fair">Justa (Padrão)</label>
                      <input type="radio" id="strategy-split" name="two-token-strategy" value="split">
                      <label for="strategy-split">Dividir 50/50</label>
                  </div>
              </div>
              
              <div class="distributor-controls">
                  <div class="input-group">
                      <label for="total-mush" data-translate-key="totalMushLabel">Total de Mush a Gastar</label>
                      <input type="number" id="total-mush" placeholder="30000">
                  </div>
                  <button id="btnDistribute" data-translate-key="btnDistribute">Distribuir</button>
              </div>
              <div id="leftover-mush"></div>
              
              <div id="leftover-distributor-section" class="hidden" style="margin-top: 15px; border-top: 1px dashed var(--border-color); padding-top: 15px;">
                  <label>Distribuir o troco para:</label>
                  <div class="token-filters" id="leftover-token-filters-container"></div>
                  <div class="buttons" style="margin-top: 10px;">
                       <button id="btnDistributeLeftover">Distribuir Troco</button>
                  </div>
              </div>
          </div>
          <table>
            <thead>
              <tr>
                <th data-translate-key="tableItem">Item</th>
                <th data-translate-key="tablePrice">Preço Unitário</th>
                <th data-translate-key="tableQty">Quantidade</th>
                <th data-translate-key="tableTotal">Valor Total</th>
              </tr>
            </thead>
            <tbody id="tabela-itens"></tbody>
            <tfoot>
              <tr>
                <td colspan="3"><b data-translate-key="tableGrandTotal">TOTAL GERAL</b></td>
                <td id="totalGeral" style="text-align: center;"><b>0.00</b></td>
              </tr>
            </tfoot>
          </table>
          <div class="buttons">
            <button id="btnCalcular" data-translate-key="btnCalculate">Calcular</button>
            <button id="btnResetar" data-translate-key="btnReset">Resetar</button>
            <button id="btnGerarImagem" data-translate-key="btnExport">Exportar para PNG</button>
          </div>
      </div>
      
      <div id="history-view" class="tab-content hidden">
          <h2 data-translate-key="historyHeader">Histórico de Vendas</h2>

          <div class="input-group" style="align-items: center; margin-bottom: 20px;">
              <label>Visualizar:</label>
              <div class="mode-selector">
                  <input type="radio" id="history-view-all" name="history-view-mode" value="all" checked>
                  <label for="history-view-all">Todas as Vendas</label>
                  <input type="radio" id="history-view-summary" name="history-view-mode" value="summary">
                  <label for="history-view-summary">Resumo por Cliente</label>
              </div>
          </div>

          <div id="history-filter-bar" style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap; margin-bottom: 20px; padding: 15px; border: 1px solid var(--border-color); border-radius: 12px;">
              <div class="input-group" style="flex-grow: 1;">
                  <label for="history-search-input">Buscar por Nome</label>
                  <input type="text" id="history-search-input" placeholder="Digite o nome do cliente...">
              </div>
              <div class="input-group">
                  <label for="history-date-start">Data Início</label>
                  <input type="date" id="history-date-start">
              </div>
              <div class="input-group">
                  <label for="history-date-end">Data Fim</label>
                  <input type="date" id="history-date-end">
              </div>
              <button id="history-apply-filter-btn">Aplicar Filtros</button>
          </div>

          <div id="history-table-container"></div>
      </div>
    </div>
</div>

<div id="resultado" style="display: none; padding: 20px; background: var(--bg-secondary); color: var(--text-primary); width: 400px; border-radius: 15px; border: 1px solid var(--border-color); position: fixed; top: -100%; left: 50%; transform: translateX(-50%); z-index: -1;">
</div>


<script>
  // --- INICIALIZAÇÃO DO FIREBASE ---
  const firebaseConfig = {
    apiKey: "AIzaSyDgeTU4YmFpZIwcmE2-cxGKTkO2KqeQotE",
    authDomain: "token-calculator-a45d6.firebaseapp.com",
    projectId: "token-calculator-a45d6",
    storageBucket: "token-calculator-a45d6.firebasestorage.app",
    messagingSenderId: "597974335563",
    appId: "1:597974335563:web:9d07ada2708d61b7d30dce"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  // --- LÓGICA DA APLICAÇÃO ---
    const MOEDA_BASE64 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAACUSURBVDhPY/j//z8DJYCJgUJWCiDPmPrP4P/fv//f//79//Pnx/+/f/8DNlDrAKSkG4B84BTg//+fA5AAYs4A5gA1zwBC/v/79w8gCajhF0D+jAar4f9/fv8DksAqsX4A8gNTAf8ZGP5/YOD5/wz8//P/D/gMWQBL/x/g/x8Y/v9g+P+DAAATz2sNmmNYXAAAAABJRU5ErkJggg==";
    const DUMMY_DOMAIN = '@painelriciv.com'; 

    const ITENS_CATALOGO = {
      revive: { preco: 790, name_br: 'Revive Token', name_en: 'Revive Token' },
      max: { preco: 570, name_br: 'Max Growth Token', name_en: 'Max Growth Token' },
      partial: { preco: 195, name_br: 'Partial Growth Token', name_en: 'Partial Growth Token' },
      change: { preco: 90, name_br: 'Appearance Change Token', name_en: 'Appearance Change Token' }
    };

    const TRANSLATIONS = {
      br: {
          pageTitle: "Calculadora de Tokens", mainHeader: "Calculadora de Tokens", themeLabel: "Tema Claro",
          idLabel: "Identificador / Nome", idPlaceholder: "Digite seu nome ou ID", discountLabel: "Desconto (%)",
          discountPlaceholder: "Ex: 10", tableItem: "Item", tablePrice: "Preço Unitário", tableQty: "Quantidade",
          tableTotal: "Valor Total", tableGrandTotal: "TOTAL GERAL", btnCalculate: "Calcular", btnReset: "Resetar",
          btnExport: "Exportar para PNG", alertNoItems: "Nenhum item foi selecionado para gerar o recibo.",
          receiptHeader: "Recibo", receiptItemsHeader: "Itens Comprados", receiptSubtotal: "Subtotal",
          receiptDiscount: "Desconto", receiptFinalTotal: "Total Final", receiptThanks: "✨ Agradecemos a preferência! ✨",
          calculationMode: "Modo de Cálculo", modeQty: "Por Quantidade", modeMush: "Por Mush",
          distributeTokensLabel: "Tokens Desejáveis para Distribuição", totalMushLabel: "Total de Mush a Gastar",
          btnDistribute: "Distribuir", leftoverMushText: "Sobrou:",
          loginHeader: "Acessar Calculadora", usernameLabel: "Usuário", passwordLabel: "Senha",
          loginButton: "Entrar", logoutButton: "Sair", errorInvalidCredentials: "Usuário ou senha inválidos.",
          errorGeneric: "Ocorreu um erro. Tente novamente.",
          tabCalculator: "Calculadora", tabHistory: "Histórico", historyHeader: "Histórico de Vendas",
          historyCustomer: "Cliente", historyDate: "Data", historyTotal: "Total", historySeller: "Vendedor",
          historyNoRecords: "Nenhum registro encontrado.", historyLoading: "Carregando histórico...",
          loggedInAs: "Usuário:"
      },
      en: {
          pageTitle: "Token Calculator", mainHeader: "Token Calculator", themeLabel: "Light Theme",
          idLabel: "Identifier / Name", idPlaceholder: "Enter your name or ID", discountLabel: "Discount (%)",
          discountPlaceholder: "Ex: 10", tableItem: "Item", tablePrice: "Unit Price", tableQty: "Quantity",
          tableTotal: "Total Value", tableGrandTotal: "GRAND TOTAL", btnCalculate: "Calculate", btnReset: "Reset",
          btnExport: "Export to PNG", alertNoItems: "No items were selected to generate the receipt.",
          receiptHeader: "Receipt", receiptItemsHeader: "Purchased Items", receiptSubtotal: "Subtotal",
          receiptDiscount: "Discount", receiptFinalTotal: "Final Total", receiptThanks: "✨ Thank you for your preference! ✨",
          calculationMode: "Calculation Mode", modeQty: "By Quantity", modeMush: "By Mush",
          distributeTokensLabel: "Desirable Tokens for Distribution", totalMushLabel: "Total Mush to Spend",
          btnDistribute: "Distribute", leftoverMushText: "Leftover:",
          loginHeader: "Calculator Login", usernameLabel: "Username", passwordLabel: "Password",
          loginButton: "Login", logoutButton: "Logout", errorInvalidCredentials: "Invalid username or password.",
          errorGeneric: "An error occurred. Please try again.",
          tabCalculator: "Calculator", tabHistory: "History", historyHeader: "Sales History",
          historyCustomer: "Customer", historyDate: "Date", historyTotal: "Total", historySeller: "Seller",
          historyNoRecords: "No records found.", historyLoading: "Loading history...",
          loggedInAs: "User:"
      }
    };
    
    const dom = {
      authContainer: document.getElementById('auth-container'),
      appContainer: document.getElementById('app-container'),
      usernameInput: document.getElementById('username-input'),
      passwordInput: document.getElementById('password-input'),
      btnLogin: document.getElementById('btnLogin'),
      btnLogout: document.getElementById('btnLogout'),
      authError: document.getElementById('auth-error'),
      html: document.documentElement,
      nomeClienteInput: document.getElementById('nomeCliente'),
      descontoInput: document.getElementById('desconto'),
      tabelaItensBody: document.getElementById('tabela-itens'),
      totalGeralCell: document.getElementById('totalGeral'),
      themeToggle: document.getElementById('theme-toggle'),
      langBr: document.getElementById('lang-br'),
      langEn: document.getElementById('lang-en'),
      modeQtyRadio: document.getElementById('mode-qty'),
      modeMushRadio: document.getElementById('mode-mush'),
      distributorSection: document.getElementById('distributor-section'),
      tokenFiltersContainer: document.getElementById('token-filters-container'),
      leftoverTokenFiltersContainer: document.getElementById('leftover-token-filters-container'),
      totalMushInput: document.getElementById('total-mush'),
      btnDistribute: document.getElementById('btnDistribute'),
      btnDistributeLeftover: document.getElementById('btnDistributeLeftover'),
      leftoverMushDiv: document.getElementById('leftover-mush'),
      leftoverDistributorSection: document.getElementById('leftover-distributor-section'),
      tabNavigation: document.querySelector('.tab-navigation'),
      tabLinks: document.querySelectorAll('.tab-link'),
      tabContents: document.querySelectorAll('.tab-content'),
      historyTableContainer: document.getElementById('history-table-container'),
      loggedInUserDiv: document.getElementById('logged-in-user'),
      historySearchInput: document.getElementById('history-search-input'),
      historyDateStart: document.getElementById('history-date-start'),
      historyDateEnd: document.getElementById('history-date-end'),
      historyApplyFilterBtn: document.getElementById('history-apply-filter-btn'),
    };

    let currentLang = 'br';

    const app = {
      calculatorInitialized: false,
      currentLeftover: 0,

      init() {
        this.loadPreferences();
        this.setLanguage(currentLang, true);
        this.addAuthListeners();
      },
      
      addAuthListeners() {
        auth.onAuthStateChanged(user => {
            if (user) {
                dom.authContainer.classList.add('hidden');
                dom.appContainer.classList.remove('hidden');
                const username = user.email.split('@')[0];
                dom.loggedInUserDiv.innerHTML = `<span>${TRANSLATIONS[currentLang].loggedInAs}</span> <span class="username">${username}</span>`;
                if (!this.calculatorInitialized) {
                    this.addAppEventListeners();
                    this.setLanguage(currentLang);
                    this.calculatorInitialized = true;
                }
            } else {
                dom.authContainer.classList.remove('hidden');
                dom.appContainer.classList.add('hidden');
                this.calculatorInitialized = false; 
            }
        });
        dom.btnLogin.addEventListener('click', this.handleLogin.bind(this));
        dom.btnLogout.addEventListener('click', this.handleLogout.bind(this));
      },
      
      async handleLogin() {
          const username = dom.usernameInput.value.trim();
          const password = dom.passwordInput.value;
          const t = TRANSLATIONS[currentLang];
          if (!username || !password) {
              dom.authError.textContent = t.errorInvalidCredentials;
              return;
          }
          const email = username + DUMMY_DOMAIN;
          try {
              dom.authError.textContent = '';
              await auth.signInWithEmailAndPassword(email, password);
          } catch (error) {
              if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-email') {
                  dom.authError.textContent = t.errorInvalidCredentials;
              } else {
                  dom.authError.textContent = t.errorGeneric;
              }
          }
      },
      
      handleLogout() { auth.signOut(); },

      loadPreferences() {
          this.setTheme(localStorage.getItem('theme') || 'dark');
          currentLang = localStorage.getItem('language') || 'br';
      },

      addAppEventListeners() {
          dom.descontoInput.addEventListener('input', this.updateUI.bind(this));
          document.getElementById('btnCalcular').addEventListener('click', this.updateUI.bind(this));
          document.getElementById('btnResetar').addEventListener('click', this.reset.bind(this));
          document.getElementById('btnGerarImagem').addEventListener('click', this.generateImage.bind(this));
          dom.themeToggle.addEventListener('click', () => this.setTheme(dom.html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'));
          dom.langBr.addEventListener('click', () => this.setLanguage('br'));
          dom.langEn.addEventListener('click', () => this.setLanguage('en'));
          dom.modeQtyRadio.addEventListener('change', () => this.toggleMode('quantity'));
          dom.modeMushRadio.addEventListener('change', () => this.toggleMode('mush'));
          dom.btnDistribute.addEventListener('click', this.distributeMush.bind(this));
          dom.btnDistributeLeftover.addEventListener('click', this.distributeLeftoverMush.bind(this));
          dom.tabNavigation.addEventListener('click', this.handleTabClick.bind(this));

          dom.tokenFiltersContainer.addEventListener('change', () => {
              const selectedCount = dom.tokenFiltersContainer.querySelectorAll('input:checked').length;
              document.getElementById('two-token-options').classList.toggle('hidden', selectedCount !== 2);
          });
          
          document.querySelectorAll('input[name="history-view-mode"]').forEach(radio => {
              radio.addEventListener('change', this.loadHistory.bind(this));
          });
          
          dom.historyApplyFilterBtn.addEventListener('click', this.loadHistory.bind(this));
      },

      handleTabClick(event) {
          const clickedTab = event.target.closest('.tab-link');
          if (!clickedTab) return;
          const tabId = clickedTab.dataset.tab;
          
          if(tabId === 'history-view' && !document.getElementById(tabId).classList.contains('active')) {
              this.loadHistory();
          }

          dom.tabLinks.forEach(link => link.classList.remove('active'));
          dom.tabContents.forEach(content => content.classList.add('hidden'));
          
          clickedTab.classList.add('active');
          document.getElementById(tabId).classList.remove('hidden');
      },
      
      async loadHistory() {
          const t = TRANSLATIONS[currentLang];
          dom.historyTableContainer.innerHTML = `<p>${t.historyLoading}</p>`;
          
          const viewMode = document.querySelector('input[name="history-view-mode"]:checked').value;
          const searchTerm = dom.historySearchInput.value.toLowerCase().trim();
          const startDate = dom.historyDateStart.value ? new Date(dom.historyDateStart.value) : null;
          const endDate = dom.historyDateEnd.value ? new Date(dom.historyDateEnd.value) : null;

          if (endDate) endDate.setHours(23, 59, 59, 999);

          try {
              let query = db.collection("receipts");
              if (startDate) query = query.where('createdAt', '>=', startDate);
              if (endDate) query = query.where('createdAt', '<=', endDate);
              query = query.orderBy('createdAt', 'desc');

              let querySnapshot = await query.get();
              let docs = querySnapshot.docs;

              if (searchTerm) {
                  docs = docs.filter(doc => (doc.data().customerName || '').toLowerCase().includes(searchTerm));
              }

              if (docs.length === 0) {
                  dom.historyTableContainer.innerHTML = `<p>${t.historyNoRecords}</p>`;
                  return;
              }

              if (viewMode === 'all') {
                  let tableHTML = `<table><thead><tr><th>${t.historyCustomer}</th><th>${t.historySeller}</th><th>${t.historyTotal}</th><th>${t.historyDate}</th></tr></thead><tbody>`;
                  docs.forEach(doc => {
                      const data = doc.data();
                      tableHTML += `<tr><td>${data.customerName || 'N/A'}</td><td>${(data.seller || 'N/A').split('@')[0]}</td><td>${(data.grandTotal || 0).toFixed(2)}</td><td>${data.createdAt?.toDate ? data.createdAt.toDate().toLocaleString(currentLang) : 'N/A'}</td></tr>`;
                  });
                  dom.historyTableContainer.innerHTML = tableHTML + `</tbody></table>`;
              } else if (viewMode === 'summary') {
                  const customerSummary = {};
                  docs.forEach(doc => {
                      const data = doc.data();
                      const customerName = data.customerName || 'Cliente Não Identificado';
                      if (!customerSummary[customerName]) {
                          customerSummary[customerName] = { totalSpent: 0, salesCount: 0, lastSaleDate: null };
                      }
                      customerSummary[customerName].totalSpent += data.grandTotal || 0;
                      customerSummary[customerName].salesCount++;
                      if (!customerSummary[customerName].lastSaleDate) {
                          customerSummary[customerName].lastSaleDate = data.createdAt?.toDate ? data.createdAt.toDate() : null;
                      }
                  });
                  const summaryArray = Object.keys(customerSummary).map(name => ({ name, ...customerSummary[name] })).sort((a, b) => b.totalSpent - a.totalSpent);
                  let tableHTML = `<table><thead><tr><th>Cliente</th><th>Total Gasto</th><th>Nº de Compras</th><th>Última Compra</th></tr></thead><tbody>`;
                  summaryArray.forEach(summary => {
                      tableHTML += `<tr><td>${summary.name}</td><td>${summary.totalSpent.toFixed(2)}</td><td>${summary.salesCount}</td><td>${summary.lastSaleDate ? summary.lastSaleDate.toLocaleDateString(currentLang) : 'N/A'}</td></tr>`;
                  });
                  dom.historyTableContainer.innerHTML = tableHTML + `</tbody></table>`;
              }
          } catch (error) {
              console.error("Erro ao buscar histórico: ", error);
              if (error.code === 'failed-precondition') {
                   dom.historyTableContainer.innerHTML = `<p style="color: var(--text-error);"><b>Ação Necessária:</b> O filtro por data precisa de um índice no Firestore. Acesse o console do seu navegador (F12) para encontrar um link que cria este índice automaticamente. Após criá-lo (pode levar alguns minutos), a funcionalidade será liberada.</p>`;
                   console.log("Para criar o índice, acesse o link gerado pelo Firebase ou crie manualmente na coleção 'receipts' com o campo 'createdAt' (decrescente).");
              } else {
                  dom.historyTableContainer.innerHTML = `<p style="color: var(--text-error);">${t.errorGeneric}</p>`;
              }
          }
      },
      
      setLanguage(lang, isLoginScreenOnly = false) {
          currentLang = lang;
          localStorage.setItem('language', lang);
          document.querySelectorAll('[data-translate-key]').forEach(el => {
              const key = el.dataset.translateKey;
              if (TRANSLATIONS[lang][key]) el.innerText = TRANSLATIONS[lang][key];
          });
          document.querySelectorAll('[data-translate-key-placeholder]').forEach(el => {
              const key = el.dataset.translateKeyPlaceholder;
              if (TRANSLATIONS[lang][key]) el.placeholder = TRANSLATIONS[lang][key];
          });
          document.title = TRANSLATIONS[lang].pageTitle;
          dom.langBr.classList.toggle('active', lang === 'br');
          dom.langEn.classList.toggle('active', lang === 'en');
          if (!isLoginScreenOnly) {
            this.loadTable();
            this.buildTokenFilters(dom.tokenFiltersContainer);
            this.updateUI();
          }
      },
      
      toggleMode(mode) {
        dom.distributorSection.style.display = mode === 'mush' ? 'flex' : 'none';
        dom.tabelaItensBody.querySelectorAll('input').forEach(input => input.disabled = (mode === 'mush'));
        document.getElementById('btnCalcular').style.display = mode === 'quantity' ? 'inline-block' : 'none';
        if (mode === 'mush') this.buildTokenFilters(dom.tokenFiltersContainer);
      },

      setTheme(theme) {
          dom.html.setAttribute('data-theme', theme);
          localStorage.setItem('theme', theme);
      },

      buildTokenFilters(container) {
          container.innerHTML = '';
          for (const key in ITENS_CATALOGO) {
              const item = ITENS_CATALOGO[key];
              const label = document.createElement('label');
              label.innerHTML = `<input type="checkbox" value="${key}" checked><span>${item[`name_${currentLang}`]}</span>`;
              container.appendChild(label);
          }
          if (container.id === 'token-filters-container') {
              container.dispatchEvent(new Event('change'));
          }
      },
      
      calculateValues() {
          const descontoPercentual = parseFloat(dom.descontoInput.value) || 0;
          const fatorDesconto = 1 - (descontoPercentual / 100);
          let totalFinal = 0;
          const itensCalculados = {};

          for (const key in ITENS_CATALOGO) {
              const item = ITENS_CATALOGO[key];
              const quantidade = parseInt(document.getElementById(`qtd-${key}`)?.value || 0);
              const subtotal = quantidade * (item.preco * fatorDesconto);
              totalFinal += subtotal;
              itensCalculados[key] = {
                  quantidade,
                  precoOriginal: item.preco,
                  precoComDesconto: item.preco * fatorDesconto,
                  subtotal
              };
          }
          return { totalFinal, descontoPercentual, itens: itensCalculados };
      },

      distributeMush() {
          this.reset(false);
          const totalMush = parseFloat(dom.totalMushInput.value) || 0;
          if (totalMush <= 0) { this.updateUI(); return; }

          const selectedTokenKeys = Array.from(dom.tokenFiltersContainer.querySelectorAll('input:checked')).map(cb => cb.value);
          if (selectedTokenKeys.length === 0) { alert(TRANSLATIONS[currentLang].alertNoItems); return; }
          
          let tokens = selectedTokenKeys.map(key => ({ key, preco: ITENS_CATALOGO[key].preco, quantidade: 0 }));
          
          if (tokens.length === 2 && document.querySelector('input[name="two-token-strategy"]:checked').value === 'split') {
              const mushPerToken = totalMush / 2;
              tokens.forEach(token => token.quantidade = Math.floor(mushPerToken / token.preco));
          } else {
              this.runFairDistribution(tokens, totalMush);
          }
          this.updateDistributionUI(tokens);
      },

      distributeLeftoverMush() {
          const selectedTokenKeys = Array.from(dom.leftoverTokenFiltersContainer.querySelectorAll('input:checked')).map(cb => cb.value);
           if (selectedTokenKeys.length === 0) { alert(TRANSLATIONS[currentLang].alertNoItems); return; }

          let tokens = selectedTokenKeys.map(key => ({
              key,
              preco: ITENS_CATALOGO[key].preco,
              quantidade: parseInt(document.getElementById(`qtd-${key}`).value) || 0
          }));
          
          this.runFairDistribution(tokens, this.currentLeftover);
          this.updateDistributionUI(tokens);
          dom.leftoverDistributorSection.classList.add('hidden');
      },
      
      runFairDistribution(tokens, totalMush) {
          tokens.sort(() => Math.random() - 0.5);
          let mushRestante = totalMush;
          let possivelComprar = true;
          while (possivelComprar) {
              let comprouNestaRodada = false;
              for (const token of tokens) {
                  if (mushRestante >= token.preco) {
                      token.quantidade++;
                      mushRestante -= token.preco;
                      comprouNestaRodada = true;
                  }
              }
              if (!comprouNestaRodada) possivelComprar = false;
          }
      },

      updateDistributionUI(tokens) {
          let mushGasto = 0;
          tokens.forEach(token => {
              document.getElementById(`qtd-${token.key}`).value = token.quantidade;
              mushGasto += token.quantidade * ITENS_CATALOGO[token.key].preco;
          });
          
          const mushTotal = parseFloat(dom.totalMushInput.value) || 0;
          this.currentLeftover = mushTotal - mushGasto;
          
          dom.leftoverMushDiv.innerHTML = `${TRANSLATIONS[currentLang].leftoverMushText} <b>${this.currentLeftover.toFixed(2)}</b> `;
          dom.leftoverMushDiv.appendChild(this.createCoinIcon());

          const cheapestPrice = Math.min(...Object.values(ITENS_CATALOGO).map(t => t.preco));
          if (this.currentLeftover >= cheapestPrice) {
              dom.leftoverDistributorSection.classList.remove('hidden');
              this.buildTokenFilters(dom.leftoverTokenFiltersContainer);
          } else {
              dom.leftoverDistributorSection.classList.add('hidden');
          }

          this.updateUI();
      },

      createCoinIcon() {
          const img = document.createElement('img');
          img.src = MOEDA_BASE64;
          img.style.cssText = 'width: 16px; height: 16px; vertical-align: middle; margin-left: 4px;';
          img.alt = 'mush';
          return img;
      },

      loadTable() {
          dom.tabelaItensBody.innerHTML = '';
          for (const key in ITENS_CATALOGO) {
            const item = ITENS_CATALOGO[key];
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${item[`name_${currentLang}`]}</td><td>${item.preco.toFixed(2)}</td><td style="text-align: center;"><div style="width: 80px; margin: 0 auto;"><input type="number" id="qtd-${key}" value="0" min="0"></div></td><td style="text-align: center;">0.00</td>`;
            tr.querySelector(`td:nth-child(2)`).appendChild(this.createCoinIcon());
            tr.querySelector(`td:nth-child(4)`).appendChild(this.createCoinIcon());
            dom.tabelaItensBody.appendChild(tr);
            tr.querySelector(`#qtd-${key}`).addEventListener('input', this.updateUI.bind(this));
          }
          this.updateUI();
      },

      updateUI() {
          const calculo = this.calculateValues();
          if (!calculo) return;
          Array.from(dom.tabelaItensBody.rows).forEach((row, index) => {
            const key = Object.keys(ITENS_CATALOGO)[index];
            const itemCalculado = calculo.itens[key];
            row.cells[1].innerHTML = `${itemCalculado.precoOriginal.toFixed(2)} ${calculo.descontoPercentual > 0 ? `➝ ${itemCalculado.precoComDesconto.toFixed(2)}` : ''} `;
            row.cells[1].appendChild(this.createCoinIcon());
            row.cells[3].innerHTML = `${itemCalculado.subtotal.toFixed(2)} `;
            row.cells[3].appendChild(this.createCoinIcon());
          });
          dom.totalGeralCell.innerHTML = `<b>${calculo.totalFinal.toFixed(2)}</b> `;
          dom.totalGeralCell.appendChild(this.createCoinIcon());
      },

      reset(clearDistributor = true) {
          dom.nomeClienteInput.value = '';
          dom.descontoInput.value = '';
          if (clearDistributor) {
              dom.totalMushInput.value = '';
              dom.leftoverMushDiv.innerHTML = '';
              dom.leftoverDistributorSection.classList.add('hidden');
          }
          Object.keys(ITENS_CATALOGO).forEach(key => document.getElementById(`qtd-${key}`).value = 0);
          this.updateUI();
      },

      async generateImage() {
        const calculo = this.calculateValues();
        if(!calculo) return;
        const t = TRANSLATIONS[currentLang];
        let temItens = Object.values(calculo.itens).some(item => item.quantidade > 0);
        if (!temItens) { alert(t.alertNoItems); return; }
        const nome = dom.nomeClienteInput.value.trim() || 'Nao_Identificado';
        const itemsToSave = {};
        for(const key in calculo.itens) {
            if(calculo.itens[key].quantidade > 0) itemsToSave[key] = calculo.itens[key].quantidade;
        }
        const receiptData = {
            customerName: nome, discountApplied: calculo.descontoPercentual, grandTotal: calculo.totalFinal,
            items: itemsToSave, seller: auth.currentUser.email, createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        try {
            await db.collection("receipts").add(receiptData);
        } catch(e) {
            console.error("Erro ao salvar no Firestore: ", e);
            alert("Houve um erro ao salvar o recibo no banco de dados.");
        }
        let receiptHtml = `<h2 style="font-family: 'Poppins', sans-serif; color: var(--accent-primary); text-align: center;">${t.receiptHeader}</h2><p style="text-align: center; color: var(--text-secondary); margin-bottom: 20px;">${nome}</p><h3 style="margin-top: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; font-size: 1em;">${t.receiptItemsHeader}</h3><table style="width: 100%; margin-top: 10px; border-collapse: collapse; font-size: 0.9em;"><tbody>`;
        for(const key in calculo.itens) {
            const item = calculo.itens[key];
            if(item.quantidade > 0) receiptHtml += `<tr><td style="padding: 5px 0;">${ITENS_CATALOGO[key][`name_${currentLang}`]} x ${item.quantidade}</td><td style="padding: 5px 0; text-align: right;">${item.subtotal.toFixed(2)}</td></tr>`;
        }
        const subtotalBruto = calculo.totalFinal / (1 - calculo.descontoPercentual / 100);
        const valorDesconto = subtotalBruto - calculo.totalFinal;
        receiptHtml += `</tbody></table><div style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 10px; font-size: 0.9em;"><p style="display: flex; justify-content: space-between;"><span>${t.receiptSubtotal}:</span> <span>${subtotalBruto.toFixed(2)}</span></p><p style="display: flex; justify-content: space-between;"><span>${t.receiptDiscount} (${calculo.descontoPercentual}%):</span> <span>-${valorDesconto.toFixed(2)}</span></p><p style="display: flex; justify-content: space-between; font-weight: bold; color: var(--accent-primary); font-size: 1.2em; margin-top: 5px;"><span>${t.receiptFinalTotal}:</span> <span>${calculo.totalFinal.toFixed(2)}</span></p></div><p style="text-align: center; margin-top: 20px; font-size: 0.9em;">${t.receiptThanks}</p>`;
        const resultadoDiv = document.getElementById('resultado');
        resultadoDiv.innerHTML = receiptHtml;
        resultadoDiv.style.display = 'block';
        resultadoDiv.style.position = 'fixed';
        resultadoDiv.style.top = '50%';
        resultadoDiv.style.left = '50%';
        resultadoDiv.style.transform = 'translate(-50%, -50%)';
        resultadoDiv.style.zIndex = '1000';
        setTimeout(() => {
            html2canvas(resultadoDiv, { backgroundColor: getComputedStyle(document.body).getPropertyValue('--bg-secondary'), scale: 2 }).then(canvas => {
              const link = document.createElement('a');
              const nomeSanitizado = nome.normalize('NFD').replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '_').replace(/[^\w-]/g, '');
              link.download = `${nomeSanitizado}_recibo.png`;
              link.href = canvas.toDataURL('image/png');
              link.click();
              resultadoDiv.style.display = 'none';
              resultadoDiv.style.top = '-100%';
              resultadoDiv.style.zIndex = '-1';
            });
        }, 300);
      }
    };
    
    app.init();
</script>
</body>
</html>
